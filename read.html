<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Study Tool - JSON Storage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <style>
        :root { --primary: #2563eb; --bg: #e2e8f0; --sidebar-w: 350px; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        #main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        #toolbar { background: #1e293b; color: white; padding: 12px 25px; display: flex; gap: 15px; align-items: center; z-index: 100; }
        .btn-tool { background: var(--primary); color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; font-size: 13px; }
        .btn-tool.secondary { background: #475569; }
        #viewer-container { flex: 1; overflow: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .page-container { position: relative; background: white; margin-bottom: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .textLayer { opacity: 1; mix-blend-mode: multiply; } 
        .hl-box { position: absolute; background: rgba(255, 255, 0, 0.4); cursor: pointer; z-index: 1; }
        .ul-box { position: absolute; border-bottom: 2px solid red; cursor: pointer; z-index: 1; }
        .nt-box { position: absolute; cursor: pointer; z-index: 10; font-size: 24px; transform: translate(-50%, -50%); }
        #info-sidebar { width: var(--sidebar-w); background: white; border-left: 1px solid #cbd5e1; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.05); transform: translateX(100%); transition: 0.3s; position: absolute; right: 0; top: 0; bottom: 0; z-index: 1000; }
        #info-sidebar.open { transform: translateX(0); }
        .sidebar-header { background: #f8fafc; padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: bold; display: flex; justify-content: space-between; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; line-height: 1.6; }
        .info-label { color: #64748b; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-top: 15px; display: block; }
        .info-value { background: #f1f5f9; padding: 10px; border-radius: 4px; display: block; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        #floating-menu { display: none; position: fixed; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; padding: 5px; border: 1px solid #ccc; }
        #floating-menu button { border: none; background: none; padding: 10px 15px; cursor: pointer; font-weight: bold; border-radius: 4px; }
        #note-form-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; }
        .note-form { background: white; padding: 25px; border-radius: 12px; width: 500px; display: flex; flex-direction: column; gap: 10px; }
        .note-form textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
    </style>
</head>
<body>

<div id="main-content">
    <div id="toolbar">
        <label class="btn-tool">üìÇ M·ªü PDF <input type="file" id="file-selector" accept="application/pdf" style="display:none"></label>
        <button class="btn-tool secondary" onclick="exportNotes()">üíæ L∆∞u File Ghi Ch√∫ (.json)</button>
        <label class="btn-tool secondary">üì§ N·∫°p Ghi Ch√∫ <input type="file" id="import-selector" accept=".json" style="display:none"></label>
        <div id="status" style="font-size: 12px; color: #cbd5e1;">B√¥i ƒëen text ƒë·ªÉ g√°n ph√¢n t√≠ch.</div>
    </div>
    <div id="viewer-container"></div>
</div>

<div id="info-sidebar">
    <div class="sidebar-header">CHI TI·∫æT PH√ÇN T√çCH <button onclick="closeSidebar()" style="cursor:pointer; border:none; background:none">‚úñ</button></div>
    <div class="sidebar-content" id="sidebar-data"></div>
    <div style="padding:15px; border-top:1px solid #eee">
        <button id="del-btn" style="color:red; cursor:pointer; border:none; background:none">üóë X√≥a ghi ch√∫ n√†y</button>
    </div>
</div>

<div id="note-form-overlay">
    <div class="note-form">
        <h3>G√°n th√¥ng tin ph√¢n t√≠ch</h3>
        <span class="info-label">C√¢u g·ªëc (Source)</span>
        <div id="form-source" style="font-weight:bold; background:#eee; padding:10px; max-height: 60px; overflow: auto;"></div>
        <span class="info-label">D·ªãch (Translation)</span>
        <textarea id="form-trans"></textarea>
        <span class="info-label">Ng·ªØ ph√°p (Grammar)</span>
        <textarea id="form-grammar"></textarea>
        <span class="info-label">Th√†nh ph·∫ßn (Components)</span>
        <textarea id="form-comp"></textarea>
        <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
            <button onclick="closeForm()">H·ªßy</button>
            <button onclick="saveNote()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer">L∆∞u l·∫°i</button>
        </div>
    </div>
</div>

<div id="floating-menu">
    <button onclick="addMarkup('hl')">üñç HL</button>
    <button onclick="addMarkup('ul')"><u>U</u></button>
    <button onclick="showNoteForm()">üìù Note</button>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const viewer = document.getElementById('viewer-container');
    const menu = document.getElementById('floating-menu');
    const sidebar = document.getElementById('info-sidebar');
    let selectedRange = null;
    let allNotes = []; // Danh s√°ch l∆∞u tr·ªØ to√†n b·ªô note

    // M·ªü File PDF
    document.getElementById('file-selector').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        viewer.innerHTML = 'ƒêang t·∫£i PDF...';
        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
        viewer.innerHTML = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-container';
            pageDiv.id = 'page-' + i;
            pageDiv.style.width = viewport.width + 'px';
            pageDiv.style.height = viewport.height + 'px';
            viewer.appendChild(pageDiv);
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width; canvas.height = viewport.height;
            pageDiv.appendChild(canvas);
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'textLayer';
            pageDiv.appendChild(textLayerDiv);
            pdfjsLib.renderTextLayer({ textContent: await page.getTextContent(), container: textLayerDiv, viewport, textDivs: [] });
        }
    };

    // N·∫°p file JSON ghi ch√∫
    document.getElementById('import-selector').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            allNotes = JSON.parse(ev.target.result);
            document.querySelectorAll('.nt-box').forEach(el => el.remove());
            allNotes.forEach(note => createPin(note));
        };
        reader.readAsText(file);
    };

    document.addEventListener('mouseup', (e) => {
        const sel = window.getSelection();
        if (sel.toString().trim()) {
            selectedRange = sel.getRangeAt(0);
            menu.style.display = 'flex';
            menu.style.left = e.clientX + 'px'; menu.style.top = (e.clientY - 50) + 'px';
        } else if (!e.target.closest('#floating-menu')) {
            menu.style.display = 'none';
        }
    });

    function addMarkup(type) {
        const rects = selectedRange.getClientRects();
        const pageNode = selectedRange.startContainer.parentElement.closest('.page-container');
        for (let r of rects) {
            const pageRect = pageNode.getBoundingClientRect();
            const box = document.createElement('div');
            box.className = type + '-box';
            box.style.left = (r.left - pageRect.left) + 'px';
            box.style.top = (r.top - pageRect.top) + 'px';
            box.style.width = r.width + 'px'; box.style.height = r.height + 'px';
            box.onclick = () => box.remove();
            pageNode.appendChild(box);
        }
        clearSelection();
    }

    function showNoteForm() {
        document.getElementById('form-source').innerText = selectedRange.toString();
        document.getElementById('note-form-overlay').style.display = 'flex';
        menu.style.display = 'none';
    }

    function saveNote() {
        const r = selectedRange.getBoundingClientRect();
        const pageNode = selectedRange.startContainer.parentElement.closest('.page-container');
        const pRect = pageNode.getBoundingClientRect();

        const note = {
            id: Date.now(),
            pageId: pageNode.id,
            source: selectedRange.toString(),
            trans: document.getElementById('form-trans').value,
            grammar: document.getElementById('form-grammar').value,
            comp: document.getElementById('form-comp').value,
            x: ((r.left - pRect.left) / pRect.width) * 100, // L∆∞u t·ªça ƒë·ªô %
            y: ((r.top - pRect.top) / pRect.height) * 100
        };

        allNotes.push(note);
        createPin(note);
        closeForm();
        clearSelection();
        document.getElementById('form-trans').value = '';
        document.getElementById('form-grammar').value = '';
        document.getElementById('form-comp').value = '';
    }

    function createPin(note) {
        const parent = document.getElementById(note.pageId);
        if (!parent) return;
        const pin = document.createElement('div');
        pin.className = 'nt-box'; pin.innerHTML = 'üìå';
        pin.style.left = note.x + '%'; pin.style.top = note.y + '%';
        pin.onclick = (e) => { e.stopPropagation(); showDetails(note, pin); };
        parent.appendChild(pin);
    }

    function showDetails(note, pinElement) {
        const container = document.getElementById('sidebar-data');
        container.innerHTML = `
            <span class="info-label">Nguy√™n vƒÉn</span><div class="info-value" style="background:#fff">${note.source}</div>
            <span class="info-label">D·ªãch nghƒ©a</span><div class="info-value">${note.trans.replace(/\n/g, '<br>')}</div>
            <span class="info-label">Ng·ªØ ph√°p</span><div class="info-value">${note.grammar.replace(/\n/g, '<br>')}</div>
            <span class="info-label">Th√†nh ph·∫ßn</span><div class="info-value">${note.comp.replace(/\n/g, '<br>')}</div>
        `;
        sidebar.classList.add('open');
        document.getElementById('del-btn').onclick = () => {
            if(confirm("X√≥a ph√¢n t√≠ch n√†y?")) {
                allNotes = allNotes.filter(n => n.id !== note.id);
                pinElement.remove(); closeSidebar();
            }
        };
    }

    function exportNotes() {
        if (allNotes.length === 0) return alert("Ch∆∞a c√≥ ghi ch√∫ n√†o ƒë·ªÉ l∆∞u!");
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allNotes));
        const dlAnchor = document.createElement('a');
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", "pdf_notes.json");
        dlAnchor.click();
    }

    function closeForm() { document.getElementById('note-form-overlay').style.display = 'none'; }
    function closeSidebar() { sidebar.classList.remove('open'); }
    function clearSelection() { window.getSelection().removeAllRanges(); menu.style.display = 'none'; }
</script>
</body>
</html>
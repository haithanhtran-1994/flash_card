<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP Dynamic Linker v2 - Editor Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #fdfaf6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 10px; border: 1px solid #eee; }
        .hidden { display: none; }
        #content-list { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            line-height: 2.2; 
            white-space: pre-wrap;
            text-align: justify;
        }
        #content-list.hide-furi rt { display: none; }
        .source-sentence { 
            display: inline; 
            font-size: 1.15rem; 
            color: #2c3e50; 
            cursor: pointer; 
            padding: 0 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .source-sentence:hover { background: #fff8e1; color: var(--accent); }
/* Style ƒê·ªçc nhanh - controlled mark (KH√îNG ph√° selection) */
.fast-read-item {
    position: relative;
    display: inline;
    cursor: pointer;
    border-radius: 4px;
    padding: 0;

    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
}

/* highlight / ID: d√πng n·ªÅn */
.fast-read-item.hl {
    background: linear-gradient(
        to top,
        var(--mark-color) 1.0em,
        transparent 0.85em
    );
}


.fast-read-item.id {
    background: transparent !important;
    color: var(--mark-color);
    font-weight: 600;
}
.fast-read-item.id rt {
    color: inherit; /* ho·∫∑c gi·ªØ m·∫∑c ƒë·ªãnh n·∫øu m√†y mu·ªën */
}


/* underline: d√πng box-shadow, KH√îNG d√πng border */
.fast-read-item.ul {
    background: transparent !important;
    box-shadow: inset 0 -4px 0 0 var(--mark-color);
    padding-bottom: 2px;
}
ruby rt {
    user-select: none;
    pointer-events: none;
}

        .screentip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0;
            border-radius:0 0 5px 5px;
			overflow: hidden;     
            font-size: 0.75rem;
            z-index: 9999;
            width: max-content;
            max-width: 230px;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: auto;
            line-height: 1.25;
			padding-top: 0;
        }
		/* N√∫t X nh·ªè */
.tip-del {
    position: relative;
    top: 0;
	margin: 0;

    font-size: 14px;
    line-height: 14px;
    width: 16px;
    height: 16px;
    text-align: center;
    color: #ff6b6b;
    cursor: pointer;
    border-radius: 50%;
    user-select: none;
	flex-shrink: 0;  
}
.tip-title {
    line-height: 1;
    padding: 0;
    margin: 0;
}

.tip-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 0 8px 4px 8px;
	margin: 0;
	
    font-weight: 600;
    border-bottom: 1px solid rgba(255,255,255,0.2);
	border-bottom: 1px solid #ddd; 
	cursor: pointer;
}
.tip-header:hover {
    background: #333;
}

.tip-body {
    padding: 4px 6px;
    font-weight: normal;
	text-align: center;
	cursor: text;
}

.tip-del:hover {
    background: rgba(255, 107, 107, 0.2);
}
		.screentip-id {
    background: #333;
    color: white;
	cursor: pointer;
}

.screentip-note {
    background: #f6f6f6;
    color: #333;
    border-bottom: 1px solid #ddd;
	text-align: center;
	cursor: text;
}

.screentip-note .tip-body div {
    text-align: left;
}

        .fast-read-item:hover .screentip { display: block; }
        .smart-list { list-style: none; padding: 0; margin: 10px 0; }
        .smart-item { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .tag-row { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 5px; }
        .tag-label { background: #34495e; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; }
        .tag-id-badge { font-family: monospace; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; border: 1px dashed; cursor: pointer; }
        .id-exists { border-color: #27ae60; color: #27ae60; background: #ebf7ee; }
        .id-none { border-color: #e74c3c; color: #e74c3c; background: #fdf2f2; }
        .tag-desc { color: #555; font-size: 0.95rem; line-height: 1.4; padding: 5px; border: 1px solid transparent; border-radius: 4px; }
        .tag-desc:hover { border-color: #ddd; background: #fff; cursor: edit; }
        .master-box { margin-top: 8px; padding: 10px; background: #fffde7; border-radius: 8px; border-left: 4px solid #fbc02d; font-size: 0.85rem; }
        .master-entry { margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .master-key { font-weight: bold; color: #7f8c8d; text-transform: capitalize; }
        .edit-container { display: flex; flex-direction: column; gap: 5px; margin: 5px 0; }
        .inline-edit { width: 100%; font-size: 0.95rem; padding: 8px; border: 2px solid var(--accent); border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .edit-buttons { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-save { background: #27ae60; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-cancel { background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: #ecf0f1; color: #2c3e50; }
        .btn-sm.active { background: var(--accent); color: white; }
        .popup { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); z-index: 1000; max-height: 80vh; overflow-y: auto; }
        #master-search { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-top: 10px; box-sizing: border-box;}
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background: #fff8e1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .mini-id-tag { display: inline-flex; align-items: center; background: #eee; padding: 2px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; font-size: 0.8rem; border: 1px solid #ccc; }
        .mini-id-del { color: #e74c3c; font-weight: bold; margin-left: 6px; cursor: pointer; padding: 0 4px; }
        .mini-id-del:hover { background: #fdd; border-radius: 50%; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        .read-mode-switch { background: #fff; padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <div id="setup-view" class="card">
        <h3>1. Master JSON</h3>
        <input type="file" id="master-input" accept=".json">
        <hr>
        <h3>2. Excel Data</h3>
        <input type="file" id="excel-input" accept=".xlsx">
    </div>
    <div id="main-app" class="hidden">
        <div class="toolbar">
            <button class="btn" style="background: #27ae60; color: white; flex: 1; min-width: 150px;" onclick="exportNewData()">üì• Xu·∫•t Excel Data M·ªõi</button>
            <div class="read-mode-switch">
                <input type="checkbox" id="chk-fast-read" onchange="renderList()"> <span>ƒê·ªçc nhanh</span>
            </div>
            <button id="btn-field-config" class="btn hidden" style="background: #9b59b6; color: white;" onclick="openFieldConfig()">Tr∆∞·ªùng hi·ªÉn th·ªã</button>
            <button id="furi-toggle" class="btn" style="background: #f39c12; color: white;" onclick="toggleFurigana()">FURI</button>
            <button class="btn" style="background: #95a5a6; color: white;" onclick="location.reload()">üîÑ ƒê·ªïi File</button>
			<div id="fast-tools" class="hidden">
				<!-- Color picker -->
				<input type="color" value="#e67e22"
					onchange="currentColor=this.value"
					title="Ch·ªçn m√†u highlight">
				
				<!-- Mode buttons -->
				<button class="btn-sm active" id="mode-id"
						onclick="setMarkMode('id')">ID</button>
				<button class="btn-sm" id="mode-hl"
						onclick="setMarkMode('highlight')">Highlight</button>
				<button class="btn-sm" id="mode-ul"
						onclick="setMarkMode('underline')">Underline</button>
			</div>
			
        </div>
        <div id="content-list"></div>
    </div>
    <div id="overlay" class="overlay hidden" onclick="closePopup()"></div>
    <div id="popup" class="popup hidden">
        <div id="popup-inner"></div>
    </div>
<script>
    let masterDB = [];
    let excelRows = [];
    let sessionPatches = JSON.parse(localStorage.getItem('jp_patches_v3') || '{}');
    let displayFields = JSON.parse(localStorage.getItem('jp_tip_fields_v1') || '[]');
    let collapsedState = {}; 
    let activeTarget = null;
    let isFuriHidden = false;
let currentColor = '#e67e22';     // m√†u ƒëang ch·ªçn
let markMode = 'id';              // 'highlight' | 'underline' | 'id'

    // L∆∞u tr·ªØ c·∫•u tr√∫c DOM ƒë√£ g√°n ID c·ªßa t·ª´ng c√¢u
    // { rowIdx: "innerHTML_ƒë√£_b·ªçc_span" }
    let domPatches = JSON.parse(localStorage.getItem('jp_dom_patches_v1') || '{}');
    document.getElementById('master-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { masterDB = JSON.parse(ev.target.result); alert("‚úÖ Master n·∫°p xong!"); };
        r.readAsText(e.target.files[0]);
    };
    document.getElementById('excel-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
            excelRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            renderList();
        };
        r.readAsArrayBuffer(e.target.files[0]);
    };
	function setMarkMode(mode) {
		markMode = mode;
		['id','hl','ul'].forEach(m => {
			const btn = document.getElementById(`mode-${m === 'hl' ? 'hl' : m}`);
			if (btn) btn.classList.toggle('active', mode === (m === 'hl' ? 'highlight' : m === 'ul' ? 'underline' : 'id'));
		});
	}

    function toggleFurigana() {
        isFuriHidden = !isFuriHidden;
        const container = document.getElementById('content-list');
        const btn = document.getElementById('furi-toggle');
        if (isFuriHidden) {
            container.classList.add('hide-furi');
            btn.style.opacity = "0.6";
        } else {
            container.classList.remove('hide-furi');
            btn.style.opacity = "1";
        }
    }
    function parseCurlyBrackets(str) {
        if (!str) return [];
        const regex = /\{([^}]+)\}/g;
        const items = str.split(/[;\n]/);
        return items.map(item => {
            const matches = [];
            let m;
            while ((m = regex.exec(item)) !== null) { matches.push(m[1]); }
            return { name: matches[0] || "", desc: matches[1] || "", id: matches[2] || "" };
        }).filter(x => x.name !== "");
    }
function renderList() {
    const isFastRead = document.getElementById('chk-fast-read').checked;
    document.getElementById('btn-field-config').classList.toggle('hidden', !isFastRead);
	document.getElementById('fast-tools')
		.classList.toggle('hidden', !isFastRead);

    const container = document.getElementById('content-list');
    container.innerHTML = ''; 
    excelRows.forEach((row, idx) => {
        const sentenceSpan = document.createElement('span');
        sentenceSpan.className = 'source-sentence';
        sentenceSpan.setAttribute('data-idx', idx);
        if (domPatches[idx]) {
            sentenceSpan.innerHTML = domPatches[idx];
        } else {
            sentenceSpan.innerHTML = (row.SOURCE || '').replace(/\\n/g, '\n');
        }
        // T·∫†O SCREENTIP ƒê·ªòNG KHI ·ªû CH·∫æ ƒê·ªò ƒê·ªåC NHANH
        if (isFastRead) {
  sentenceSpan.querySelectorAll('.fast-read-item').forEach(item => {
    const type = item.getAttribute('data-type');

    // X√≥a screentip c≈© n·∫øu c√≥
    const oldTip = item.querySelector('.screentip');
    if (oldTip) oldTip.remove();

    let tipHTML = '';

    if (type === 'id') {
        const id = item.getAttribute('data-id');
        const mInfo = masterDB.find(m => m.master_id === id);
        tipHTML = `ID: ${id}`;
        if (mInfo && displayFields.length > 0) {
            displayFields.forEach(f => {
                if (mInfo[f]) tipHTML += `<br><b>${f}:</b> ${mInfo[f]}`;
            });
        }
    } else {
        const note = item.getAttribute('data-note') || '';
    }

const tipDiv = document.createElement('div');
tipDiv.className = 'screentip ' + (type === 'id' ? 'screentip-id' : 'screentip-note');

if (type === 'id') {
    const id = item.getAttribute('data-id');
    const mInfo = masterDB.find(m => m.master_id === id);

    let bodyHTML = '';
    if (mInfo && displayFields.length > 0) {
        displayFields.forEach(f => {
            if (mInfo[f]) {
                bodyHTML += `<div><b>${f}:</b> ${mInfo[f]}</div>`;
            }
        });
    }

    tipDiv.innerHTML = `<div class="tip-header"
	onclick="event.stopPropagation(); openFastSearch(${idx}, null, '${id}')">
            <div class="tip-title">ID: ${id}</div>
            <span class="tip-del"
                  onclick="event.stopPropagation(); deleteFastMark(this, ${idx})">√ó</span>
        </div>
        <div class="tip-body">
            ${bodyHTML}
        </div>
    `;
} else {
    const note = item.getAttribute('data-note') || '';

    tipDiv.innerHTML = `<div class="tip-header">
            <div class="tip-title">Note</div>
            <span class="tip-del"
                  onclick="event.stopPropagation(); deleteFastMark(this, ${idx})">√ó</span>
        </div>
        <div class="tip-body"onclick="event.stopPropagation(); editNote(this, this.closest('.fast-read-item'), ${idx})">
			${note || '<i style="opacity:.6">(Empty)</i>'}
        </div>
    `;
}

    item.appendChild(tipDiv);
});

        }
		if (!isFastRead) {
			sentenceSpan.onclick = () => showDetail(idx, 'all');
		} else {
			// V√¥ hi·ªáu h√≥a click ƒë·ªÉ tr√°nh vi·ªác click v√†o c√¢u g√¢y nhi·ªÖu qu√° tr√¨nh b√¥i ƒëen
			sentenceSpan.onclick = (e) => {
				// N·∫øu click v√†o v√πng ƒë√£ g√°n ID (c√≥ class fast-read-item) th√¨ kh√¥ng l√†m g√¨ c·∫£ ƒë·ªÉ Screentip hi·ªán b√¨nh th∆∞·ªùng
				if (e.target.closest('.fast-read-item')) return;
				
				// NgƒÉn ch·∫∑n h√†nh vi click ƒë·ªÉ tr√¨nh duy·ªát hi·ªÉu ƒë√¢y l√† b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c c·ªßa vi·ªác b√¥i ƒëen
				e.stopPropagation();
			};
		}
        container.appendChild(sentenceSpan);
        container.appendChild(document.createTextNode(' '));
    });
// T√¨m ƒëo·∫°n cu·ªëi h√†m renderList() v√† thay th·∫ø:
if (isFastRead) {
    document.ontouchend = handleTouchEnd;
} else {
    document.ontouchend = null;
}
}
function handleTouchEnd(e) {
    if (document.getElementById('chk-fast-read')?.checked) {
        // delay nh·ªè ƒë·ªÉ iOS c·∫≠p nh·∫≠t selection
        setTimeout(() => processFinalSelection(), 0);
    }
}

// N·∫øu d√πng chu·ªôt tr√™n m√°y t√≠nh th√¨ v·∫´n c·∫ßn c√°i n√†y
// B·∫Øt s·ª± ki·ªán chu·ªôt cho m√°y t√≠nh
document.onmouseup = (e) => {
    // ‚ùå N·∫øu click v√†o v√πng ƒë√£ g√°n ID / highlight ‚Üí KH√îNG x·ª≠ l√Ω selection
    if (e.target.closest('.fast-read-item')) return;
    // N·∫øu click v√†o n√∫t X√≥a ho·∫∑c c√°c n√∫t trong popup th√¨ kh√¥ng ch·∫°y ch·ªçn text
    if (e.target.closest('.tip-btn') || e.target.closest('.popup')) return;
    if (document.getElementById('chk-fast-read')?.checked) {
        processFinalSelection();
    }
};
function processFinalSelection() {
    const sel = window.getSelection();
    const selectedText = sel.toString().trim();
    
    // Ch·ªâ x·ª≠ l√Ω n·∫øu c√≥ b√¥i ƒëen vƒÉn b·∫£n v√† Popup search ch∆∞a m·ªü
    if (!selectedText || sel.rangeCount === 0 || (activeTarget && activeTarget.isSearching)) return;

    let range = sel.getRangeAt(0);
    // CLONE range ƒë·ªÉ Safari kh√¥ng t·ª± √Ω m·ªü r·ªông
const safeRange = range.cloneRange();

// Clear selection NGAY ƒë·ªÉ browser kh√¥ng can thi·ªáp
sel.removeAllRanges();

// D√πng range an to√†n
range = safeRange;

    // Ki·ªÉm tra xem v√πng ch·ªçn c√≥ n·∫±m trong m·ªôt .source-sentence kh√¥ng
    let containerNode = range.commonAncestorContainer;
    if (containerNode.nodeType === 3) containerNode = containerNode.parentElement;
    
    const sourceSentence = containerNode.closest('.source-sentence');
    
    // N·∫øu kh√¥ng thu·ªôc c√¢u n√†o th√¨ b·ªè qua
    if (!sourceSentence) return;


    const rowIdx = parseInt(sourceSentence.getAttribute('data-idx'));
    // Ch·ªâ m·ªü search khi vƒÉn b·∫£n ch·ªçn th·ª±c s·ª± c√≥ n·ªôi dung
	if (range.toString().trim().length === 0) return;
	
	// L∆∞u target chung
	activeTarget = { rowIdx, range, text: range.toString() };
	
	if (markMode === 'id') {
		openFastSearch(rowIdx, range, range.toString());
	} else {
		applyMark(range, rowIdx, markMode);
	}

}
function expandRangeToRuby(range) {
    let sc = range.startContainer;
    let ec = range.endContainer;

    if (sc.nodeType === 3) sc = sc.parentNode;
    if (ec.nodeType === 3) ec = ec.parentNode;

    const startRuby = sc.closest && sc.closest('ruby');
    const endRuby   = ec.closest && ec.closest('ruby');

    // ===== CASE 1: selection n·∫±m TRONG C√ôNG 1 ruby =====
    if (startRuby && startRuby === endRuby) {
        const rb = startRuby.querySelector('rb');
        if (!rb || !rb.firstChild) return;

        range.setStart(rb.firstChild, 0);
        range.setEnd(rb.firstChild, rb.firstChild.textContent.length);
        return;
    }

    // ===== CASE 2: START trong ruby =====
    if (startRuby) {
        const rb = startRuby.querySelector('rb');
        if (rb && rb.firstChild) {
            range.setStart(rb.firstChild, 0);
        }
    }

    // ===== CASE 3: END trong ruby =====
    if (endRuby) {
        const rbs = endRuby.querySelectorAll('rb');
        const lastRB = rbs[rbs.length - 1];
        if (lastRB && lastRB.firstChild) {
            range.setEnd(
                lastRB.firstChild,
                lastRB.firstChild.textContent.length
            );
        }
    }

    // ‚ùå TUY·ªÜT ƒê·ªêI KH√îNG SNAP n·∫øu end KH√îNG n·∫±m trong ruby
}


function applyMark(range, rowIdx, mode) {
   let note = prompt('Nh·∫≠p note cho v√πng n√†y:') || '';
    const span = document.createElement('span');
    span.className = 'fast-read-item ' + (mode === 'highlight' ? 'hl' : 'ul');
    span.style.setProperty('--mark-color', currentColor);
	span.setAttribute('data-type', mode); // highlight | underline
	if (note) span.setAttribute('data-note', note);

	expandRangeToRuby(range);

    try {
        const content = range.extractContents();
        span.appendChild(content);
        range.insertNode(span);

        const parent = span.closest('.source-sentence');
        parent.normalize();

        // L∆∞u DOM
        domPatches[rowIdx] = parent.innerHTML;
        localStorage.setItem('jp_dom_patches_v1', JSON.stringify(domPatches));
    } catch (e) {
        console.error(e);
        alert("Kh√¥ng th·ªÉ ƒë√°nh d·∫•u v√πng n√†y.");
    }

    window.getSelection()?.removeAllRanges();
    renderList();
}

    // G·ªçi popup search
function openFastSearch(rowIdx, range, text) {
    // üîí reset selection ƒë·ªÉ click sau ƒë√≥ kh√¥ng b·ªã hi·ªÉu nh·∫ßm
    window.getSelection()?.removeAllRanges();
    // L∆∞u tr·∫°ng th√°i ƒëang search ƒë·ªÉ ch·∫∑n vi·ªác ch·ªçn text nh·∫£y popup li√™n t·ª•c
    activeTarget = { rowIdx, range, text, isSearching: true };
    const html = `
        <h3>G√°n ID cho: "${text}"</h3>
        <input type="text" id="master-search" placeholder="T√¨m ID..." 
               oninput="runSearch(this.value, 'fast')">
        <div id="search-results" style="margin-top:10px; max-height:300px; overflow-y:auto; border:1px solid #eee;"></div>
        <button class="btn" onclick="closePopup()" style="width:100%; margin-top:10px;">H·ªßy</button>
    `;
    document.getElementById('popup-inner').innerHTML = html;
    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('popup').classList.remove('hidden');
    // Autofocus cho mobile
    setTimeout(() => document.getElementById('master-search').focus(), 300);
}
function saveFastID(id) {
    const { range, rowIdx } = activeTarget;
    // ===== CASE 1: ƒê·ªîI ID C√ì S·∫¥N (click v√†o screentip ID) =====
	if (!range) {
        const item = document.querySelector(
            `.source-sentence[data-idx="${rowIdx}"] .fast-read-item.id`
        );
        if (!item) return;

        item.setAttribute('data-id', id);

        const parent = item.closest('.source-sentence');
        domPatches[rowIdx] = parent.innerHTML;
        localStorage.setItem('jp_dom_patches_v1', JSON.stringify(domPatches));

        closePopup();
        renderList();
        return;
    }
	
    // ===== CASE 2: G√ÅN ID M·ªöI T·ª™ SELECTION =====
const span = document.createElement('span');
span.className = 'fast-read-item id';
span.style.setProperty('--mark-color', currentColor || '#e67e22');
span.setAttribute('data-id', id);
expandRangeToRuby(range);
span.setAttribute('data-type', 'id');

    try {
        const content = range.extractContents();
        span.appendChild(content);
        range.insertNode(span);
        const parent = span.closest('.source-sentence');
        parent.normalize(); 
        // L∆∞u HTML s·∫°ch (ch·ªâ c√≥ th·∫ª span v√† data-id, kh√¥ng ch·ª©a div screentip b√™n trong)
        domPatches[rowIdx] = parent.innerHTML;
        localStorage.setItem('jp_dom_patches_v1', JSON.stringify(domPatches));
    } catch (err) {
        console.error("L·ªói:", err);
        alert("Kh√¥ng th·ªÉ g√°n ID cho v√πng ch·ªçn n√†y.");
    }
    closePopup();
    renderList(); // G·ªçi render ƒë·ªÉ n√≥ t·ª± l·∫Øp Screentip ƒë·ªông v√†o
}
window.deleteFastMark = (btn, rowIdx) => {
    if(!confirm("X√≥a ƒë√°nh d·∫•u n√†y?")) return;

    const item = btn.closest('.fast-read-item');
    const parent = item.parentElement;

    while(item.firstChild) {
        parent.insertBefore(item.firstChild, item);
    }
    parent.removeChild(item);
    parent.normalize();

    domPatches[rowIdx] = parent.innerHTML;
    localStorage.setItem('jp_dom_patches_v1', JSON.stringify(domPatches));
    renderList();
};

    // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
    window.openFieldConfig = () => {
        if(masterDB.length === 0) return alert("C·∫ßn n·∫°p Master JSON tr∆∞·ªõc!");
        const fields = Object.keys(masterDB[0]).filter(k => k !== 'master_id');
        const html = `
            <h3>Ch·ªçn tr∆∞·ªùng hi·ªÉn th·ªã Screentip</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; text-align:left;">
                ${fields.map(f => `
                    <label style="display:flex; gap:8px; cursor:pointer; font-size:0.9rem;">
                        <input type="checkbox" ${displayFields.includes(f) ? 'checked' : ''} onchange="toggleTipField('${f}')"> ${f}
                    </label>
                `).join('')}
            </div>
            <button class="btn" onclick="closePopup()" style="width:100%; margin-top:20px; background:#27ae60; color:white;">L∆∞u & ƒê√≥ng</button>
        `;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('popup').classList.remove('hidden');
    };
window.toggleTipField = (field) => {
    if(displayFields.includes(field)) {
        displayFields = displayFields.filter(f => f !== field);
    } else {
        displayFields.push(field);
    }
    localStorage.setItem('jp_tip_fields_v1', JSON.stringify(displayFields));
    // C·∫≠p nh·∫≠t l·∫°i to√†n b·ªô Screentip tr√™n m√†n h√¨nh m√† kh√¥ng c·∫ßn F5
    renderList(); 
};
    function showDetail(idx, mode) {
        const row = excelRows[idx];
        const grammars = parseCurlyBrackets(row.GRAMMAR);
        const components = parseCurlyBrackets(row.COMPONENTS);
        let html = `
            <div class="action-bar">
                <button class="btn-sm ${mode==='trans'?'active':''}" onclick="showDetail(${idx}, 'trans')">D·ªãch</button>
                <button class="btn-sm ${mode==='grammar'?'active':''}" onclick="showDetail(${idx}, 'grammar')">Ng·ªØ ph√°p</button>
                <button class="btn-sm ${mode==='comp'?'active':''}" onclick="showDetail(${idx}, 'comp')">Th√†nh ph·∫ßn</button>
                <button class="btn-sm ${mode==='all'?'active':''}" onclick="showDetail(${idx}, 'all')">T·∫•t c·∫£</button>
                <button class="btn-sm" style="background:#3498db; color:white;" onclick="speakText(${idx})">üîä ƒê·ªçc</button>
            </div>
        `;
        if (mode === 'all' || mode === 'grammar') {
            html += `<h4>üî∏ Ng·ªØ ph√°p:</h4>` + renderSection(grammars, 'GRAMMAR', idx, mode);
        }
        if (mode === 'all' || mode === 'comp') {
            html += `<h4>üîπ Th√†nh ph·∫ßn:</h4>` + renderSection(components, 'COMPONENTS', idx, mode);
        }
        if (mode === 'all' || mode === 'trans') {
            html += `<h4>üìú B·∫£n d·ªãch:</h4>
                     <div class="card tag-desc" style="background:#f9f9f9;" 
                          onclick="editField(this, ${idx}, 'TRANSLATION')">${row.TRANSLATION || 'Ch∆∞a c√≥ b·∫£n d·ªãch'}</div>`;
        }
        html += `<button class="btn" onclick="closePopup()" style="width:100%; margin-top:20px; background:#eee">ƒê√≥ng</button>`;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('popup').classList.remove('hidden');
    }
    function renderSection(items, fieldKey, rowIdx, mode) {
        let h = `<ul class="smart-list">`;
        if (items.length === 0) h += `<li style="color:#999; font-size:0.8rem;">(Tr·ªëng)</li>`;
        items.forEach((item, iIdx) => {
            const type = fieldKey === 'GRAMMAR' ? 'grammar' : 'component';
            const patchKey = `${rowIdx}-${type}-${iIdx}`;
            const currentId = sessionPatches[patchKey] || item.id;
            const isCollapsed = collapsedState[patchKey] === true;
            const ids = currentId ? currentId.split(',').map(s => s.trim()) : [];
            const masterInfos = ids.map(id => masterDB.find(m => m.master_id === id)).filter(x => x);
            h += `<li class="smart-item">
                <div class="tag-row">
                    <span class="tag-label" onclick="openSearch('${type}', ${rowIdx}, ${iIdx}, '${item.name}')">${item.name}</span>
                    <span class="tag-id-badge ${currentId ? 'id-exists' : 'id-none'}" onclick="toggleMasterBox('${patchKey}')">
                        ID: ${currentId || 'Ch∆∞a g√°n'} ${currentId ? (isCollapsed ? '‚ñº' : '‚ñ≤') : ''}
                    </span>
                </div>
                <div class="tag-desc" onclick="editArrayField(this, ${rowIdx}, '${fieldKey}', ${iIdx})">${item.desc}</div>
                <div id="box-${patchKey}" class="master-box ${isCollapsed || !currentId ? 'hidden' : ''}">
                    ${masterInfos.length > 0 ? masterInfos.map(mInfo => `
                        <div style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                            <b>Master [${mInfo.master_id}]:</b>
                            ${renderMasterContent(mInfo)}
                        </div>
                    `).join('') : '<i>Kh√¥ng t√¨m th·∫•y th√¥ng tin trong Master DB</i>'}
                </div>
            </li>`;
        });
        return h + `</ul>`;
    }
    window.editField = (el, idx, key) => {
        if (el.querySelector('textarea')) return;
        const oldVal = excelRows[idx][key] || "";
        el.innerHTML = `
            <div class="edit-container">
                <textarea class="inline-edit">${oldVal}</textarea>
                <div class="edit-buttons">
                    <button class="btn-cancel" onclick="event.stopPropagation(); renderAfterEdit(${idx})">H·ªßy</button>
                    <button class="btn-save" onclick="event.stopPropagation(); saveField(${idx}, '${key}', this)">L∆∞u</button>
                </div>
            </div>`;
        el.querySelector('textarea').focus();
    };
    window.saveField = (idx, key, btn) => {
        const newVal = btn.closest('.edit-container').querySelector('textarea').value;
        excelRows[idx][key] = newVal;
        renderAfterEdit(idx);
    };
    window.editArrayField = (el, rowIdx, fieldKey, itemIdx) => {
        if (el.querySelector('textarea')) return;
        const items = parseCurlyBrackets(excelRows[rowIdx][fieldKey]);
        const oldDesc = items[itemIdx].desc;
        el.innerHTML = `
            <div class="edit-container">
                <textarea class="inline-edit">${oldDesc}</textarea>
                <div class="edit-buttons">
                    <button class="btn-cancel" onclick="event.stopPropagation(); renderAfterEdit(${rowIdx})">H·ªßy</button>
                    <button class="btn-save" onclick="event.stopPropagation(); saveArrayField(${rowIdx}, '${fieldKey}', ${itemIdx}, this)">L∆∞u</button>
                </div>
            </div>`;
        el.querySelector('textarea').focus();
    };
    window.saveArrayField = (rowIdx, fieldKey, itemIdx, btn) => {
        const items = parseCurlyBrackets(excelRows[rowIdx][fieldKey]);
        items[itemIdx].desc = btn.closest('.edit-container').querySelector('textarea').value;
        updateRowString(rowIdx, fieldKey, items);
        renderAfterEdit(rowIdx);
    };
    function updateRowString(rowIdx, fieldKey, items) {
        const newString = items.map((it, idx) => {
            const type = fieldKey === 'GRAMMAR' ? 'grammar' : 'component';
            const pKey = `${rowIdx}-${type}-${idx}`;
            const finalId = sessionPatches[pKey] || it.id;
            return `{${it.name}}:{${it.desc}}${finalId ? `:{${finalId}}` : ''}`;
        }).join('; ');
        excelRows[rowIdx][fieldKey] = newString;
    }
    window.renderAfterEdit = (idx) => {
        showDetail(idx, 'all');
    };
    function renderMasterContent(info) {
        let content = "";
        for (const [key, value] of Object.entries(info)) {
            if (key === 'master_id') continue;
            let displayValue = value;
            if (Array.isArray(value)) {
                displayValue = value.map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(', ');
            } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value);
            }
            content += `<div class="master-entry"><span class="master-key">${key}:</span> ${displayValue}</div>`;
        }
        return content;
    }
    window.toggleMasterBox = (key) => {
        collapsedState[key] = !collapsedState[key];
        const box = document.getElementById('box-' + key);
        if (box) box.classList.toggle('hidden');
        const badge = box.parentElement.querySelector('.tag-id-badge');
        if (badge) {
            const currentText = badge.innerText;
            const idPart = currentText.replace('ID: ', '').split(' ')[0];
            badge.innerHTML = `ID: ${idPart} ${collapsedState[key] ? '‚ñº' : '‚ñ≤'}`;
        }
    };
    window.speakText = (idx) => {
        const text = excelRows[idx].SOURCE.replace(/\\n/g, '\n');
        const div = document.createElement('div');
        div.innerHTML = text;
        div.querySelectorAll('rt').forEach(rt => rt.remove());
        const msg = new SpeechSynthesisUtterance(div.textContent || div.innerText);
        msg.lang = 'ja-JP';
        msg.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
    };
    window.openSearch = (type, rowIdx, iIdx, name) => {
        activeTarget = { type, rowIdx, iIdx };
        const patchKey = `${rowIdx}-${type}-${iIdx}`;
        const currentId = sessionPatches[patchKey] || "";
        const ids = currentId ? currentId.split(',').filter(x => x) : [];
        const html = `
            <h3>G√°n ID cho: ${name}</h3>
            <div id="current-tags" style="margin-bottom:10px;">
                ${ids.length > 0 ? ids.map(id => `
                    <span class="mini-id-tag">${id}<span class="mini-id-del" onclick="removeSingleID('${id}')">√ó</span></span>
                `).join('') : '<span style="color:#999; font-size:0.8rem;">(Ch∆∞a c√≥ ID n√†o ƒë∆∞·ª£c g√°n)</span>'}
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="master-search" placeholder="T√¨m pattern ho·∫∑c ID..." oninput="runSearch(this.value)">
                <button class="btn" onclick="clearAllIDs()" style="margin-top:10px; background:#e74c3c; color:white; padding: 0 15px; font-size:0.8rem; white-space:nowrap;">X√≥a h·∫øt</button>
            </div>
            <div id="search-results" style="margin-top:10px; max-height:300px; overflow-y:auto; border:1px solid #eee;"></div>
            <button class="btn" onclick="showDetail(${rowIdx}, 'all')" style="width:100%; margin-top:10px;">Quay l·∫°i</button>
        `;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('master-search').focus();
    };
    window.runSearch = (val, mode = 'normal') => {
        if (!val) { document.getElementById('search-results').innerHTML = ""; return; }
        const res = masterDB.filter(m => 
            (m.pattern && m.pattern.includes(val)) || 
            (m.master_id && m.master_id.includes(val))
        );
        document.getElementById('search-results').innerHTML = res.map(r => `
            <div class="result-item" onclick="${mode === 'fast' ? `saveFastID('${r.master_id}')` : `saveID('${r.master_id}')`}">
                <strong>${r.pattern || 'No Pattern'}</strong> (${r.master_id})<br>
                <small>${r.core_meaning || ''}</small>
            </div>
        `).join('');
    };
    window.saveID = id => {
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        let currentIds = sessionPatches[key] ? sessionPatches[key].split(',') : [];
        if (!currentIds.includes(id)) {
            currentIds.push(id);
        }
        sessionPatches[key] = currentIds.filter(x => x).join(',');
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, ""); 
    };
    window.removeSingleID = (idToRemove) => {
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        let currentIds = sessionPatches[key] ? sessionPatches[key].split(',') : [];
        currentIds = currentIds.filter(id => id !== idToRemove);
        sessionPatches[key] = currentIds.join(',');
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, ""); 
    };
    window.clearAllIDs = () => {
        if(!confirm("X√≥a t·∫•t c·∫£ ID ƒë√£ g√°n cho m·ª•c n√†y?")) return;
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        sessionPatches[key] = "";
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, "");
    };
    function applyPatchToData() {
        localStorage.setItem('jp_patches_v3', JSON.stringify(sessionPatches));
        const fieldKey = activeTarget.type === 'grammar' ? 'GRAMMAR' : 'COMPONENTS';
        const items = parseCurlyBrackets(excelRows[activeTarget.rowIdx][fieldKey]);
        updateRowString(activeTarget.rowIdx, fieldKey, items);
    }
    window.exportNewData = () => {
        let out = "D·ªÆ LI·ªÜU ƒê√É CH·ªàNH S·ª¨A (D√°n v√†o Excel):\n\n";
        excelRows.forEach((row, rIdx) => {
            out += `--- D√íNG ${rIdx + 1} ---\n`;
            out += `NG·ªÆ PH√ÅP: ${row.GRAMMAR || ''}\n`;
            out += `TH√ÄNH PH·∫¶N: ${row.COMPONENTS || ''}\n`;
            out += `B·∫¢N D·ªäCH: ${row.TRANSLATION || ''}\n\n`;
        });
        const blob = new Blob([out], {type: "text/plain"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "data_updated.txt";
        link.click();
    };
window.closePopup = () => {
    // Reset tr·∫°ng th√°i search ƒë·ªÉ c√≥ th·ªÉ ch·ªçn text ti·∫øp theo
    if (activeTarget) activeTarget.isSearching = false; 
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('popup').classList.add('hidden');
    window.getSelection()?.removeAllRanges();
};
window.editNote = function(bodyDiv, item, rowIdx) {
    const old = item.getAttribute('data-note') || '';
    bodyDiv.innerHTML = `
        <textarea class="inline-edit">${old}</textarea>
        <div class="edit-buttons">
            <button class="btn-cancel" onclick="event.stopPropagation(); renderList()">H·ªßy</button>
            <button class="btn-save" onclick="event.stopPropagation(); saveNote(this, '${rowIdx}')">L∆∞u</button>
        </div>
    `;
    bodyDiv.querySelector('textarea').focus();
};

window.saveNote = function(btn, rowIdx) {
    const body = btn.closest('.tip-body');
    const text = body.querySelector('textarea').value;
    const item = body.closest('.fast-read-item');

    if (text) item.setAttribute('data-note', text);
    else item.removeAttribute('data-note');

    const parent = item.closest('.source-sentence');
    domPatches[rowIdx] = parent.innerHTML;
    localStorage.setItem('jp_dom_patches_v1', JSON.stringify(domPatches));
    renderList();
};

</script>
</body>
</html>
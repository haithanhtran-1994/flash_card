<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP Dynamic Linker v2 - Editor Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #fdfaf6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 10px; border: 1px solid #eee; }
        .hidden { display: none; }
        
        /* C·∫•u tr√∫c List */
        .smart-list { list-style: none; padding: 0; margin: 10px 0; }
        .smart-item { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .tag-row { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 5px; }
        .tag-label { background: #34495e; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; }
        .tag-id-badge { font-family: monospace; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; border: 1px dashed; cursor: pointer; }
        .id-exists { border-color: #27ae60; color: #27ae60; background: #ebf7ee; }
        .id-none { border-color: #e74c3c; color: #e74c3c; background: #fdf2f2; }
        
        .tag-desc { color: #555; font-size: 0.95rem; line-height: 1.4; padding: 5px; border: 1px solid transparent; border-radius: 4px; }
        .tag-desc:hover { border-color: #ddd; background: #fff; cursor: edit; }
        
        .master-box { margin-top: 8px; padding: 10px; background: #fffde7; border-radius: 8px; border-left: 4px solid #fbc02d; font-size: 0.85rem; }
        .master-entry { margin-bottom: 4px; }
        .master-key { font-weight: bold; color: #7f8c8d; text-transform: capitalize; }

        /* Edit Input */
        .inline-edit { width: 100%; font-size: 0.95rem; padding: 5px; border: 2px solid var(--accent); border-radius: 4px; box-sizing: border-box; }

        /* N√∫t Menu trong Popup */
        .action-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: #ecf0f1; color: #2c3e50; }
        .btn-sm.active { background: var(--accent); color: white; }

        /* Search Popup */
        .popup { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); z-index: 1000; max-height: 80vh; overflow-y: auto; }
        #master-search { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-top: 10px; }
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background: #fff8e1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup-view" class="card">
        <h3>1. Master JSON</h3>
        <input type="file" id="master-input" accept=".json">
        <hr>
        <h3>2. Excel Data</h3>
        <input type="file" id="excel-input" accept=".xlsx">
    </div>

    <div id="main-app" class="hidden">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" style="background: #27ae60; color: white; flex: 1;" onclick="exportNewData()">üì• Xu·∫•t Excel Data M·ªõi</button>
            <button class="btn" style="background: #95a5a6; color: white;" onclick="location.reload()">üîÑ ƒê·ªïi File</button>
        </div>
        <div id="content-list"></div>
    </div>

    <div id="overlay" class="overlay hidden" onclick="closePopup()"></div>
    <div id="popup" class="popup hidden">
        <div id="popup-inner"></div>
    </div>

<script>
    let masterDB = [];
    let excelRows = [];
    let sessionPatches = JSON.parse(localStorage.getItem('jp_patches_v3') || '{}');
    let collapsedState = {}; 
    let activeTarget = null;

    document.getElementById('master-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { masterDB = JSON.parse(ev.target.result); alert("‚úÖ Master n·∫°p xong!"); };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('excel-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
            excelRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            renderList();
        };
        r.readAsArrayBuffer(e.target.files[0]);
    };

    function parseCurlyBrackets(str) {
        if (!str) return [];
        const regex = /\{([^}]+)\}/g;
        const items = str.split(/[;\n]/);
        return items.map(item => {
            const matches = [];
            let m;
            while ((m = regex.exec(item)) !== null) { matches.push(m[1]); }
            return { name: matches[0] || "", desc: matches[1] || "", id: matches[2] || "" };
        }).filter(x => x.name !== "");
    }

    function renderList() {
        const container = document.getElementById('content-list');
        container.innerHTML = excelRows.map((row, idx) => `
            <div class="card" onclick="showDetail(${idx}, 'all')">
                <div style="font-size:1.2rem; color:#2c3e50;">${row.SOURCE || ''}</div>
            </div>
        `).join('');
    }

    function showDetail(idx, mode) {
        const row = excelRows[idx];
        const grammars = parseCurlyBrackets(row.GRAMMAR);
        const components = parseCurlyBrackets(row.COMPONENTS);

        let html = `
            <div class="action-bar">
                <button class="btn-sm ${mode==='trans'?'active':''}" onclick="showDetail(${idx}, 'trans')">D·ªãch</button>
                <button class="btn-sm ${mode==='grammar'?'active':''}" onclick="showDetail(${idx}, 'grammar')">Ng·ªØ ph√°p</button>
                <button class="btn-sm ${mode==='comp'?'active':''}" onclick="showDetail(${idx}, 'comp')">Th√†nh ph·∫ßn</button>
                <button class="btn-sm ${mode==='all'?'active':''}" onclick="showDetail(${idx}, 'all')">T·∫•t c·∫£</button>
                <button class="btn-sm" style="background:#3498db; color:white;" onclick="speakText(\`${row.SOURCE}\`)">üîä ƒê·ªçc</button>
            </div>
        `;

        if (mode === 'all' || mode === 'grammar') {
            html += `<h4>üî∏ Ng·ªØ ph√°p:</h4>` + renderSection(grammars, 'GRAMMAR', idx, mode);
        }
        if (mode === 'all' || mode === 'comp') {
            html += `<h4>üîπ Th√†nh ph·∫ßn:</h4>` + renderSection(components, 'COMPONENTS', idx, mode);
        }
        if (mode === 'all' || mode === 'trans') {
            html += `<h4>üìú B·∫£n d·ªãch:</h4>
                     <div class="card tag-desc" style="background:#f9f9f9;" 
                          onclick="editField(this, ${idx}, 'TRANSLATION')">${row.TRANSLATION || 'Ch∆∞a c√≥ b·∫£n d·ªãch'}</div>`;
        }

        html += `<button class="btn" onclick="closePopup()" style="width:100%; margin-top:20px; background:#eee">ƒê√≥ng</button>`;

        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('popup').classList.remove('hidden');
    }

    function renderSection(items, fieldKey, rowIdx, mode) {
        let h = `<ul class="smart-list">`;
        if (items.length === 0) h += `<li style="color:#999; font-size:0.8rem;">(Tr·ªëng)</li>`;
        items.forEach((item, iIdx) => {
            const type = fieldKey === 'GRAMMAR' ? 'grammar' : 'component';
            const patchKey = `${rowIdx}-${type}-${iIdx}`;
            const currentId = sessionPatches[patchKey] || item.id;
            const mInfo = masterDB.find(m => m.master_id === currentId);
            const isCollapsed = collapsedState[patchKey] === true;

            h += `<li class="smart-item">
                <div class="tag-row">
                    <span class="tag-label" onclick="openSearch('${type}', ${rowIdx}, ${iIdx}, '${item.name}')">${item.name}</span>
                    <span class="tag-id-badge ${currentId ? 'id-exists' : 'id-none'}" onclick="toggleMasterBox('${patchKey}')">
                        ID: ${currentId || 'Ch∆∞a g√°n'} ${currentId ? (isCollapsed ? '‚ñº' : '‚ñ≤') : ''}
                    </span>
                </div>
                <div class="tag-desc" onclick="editArrayField(this, ${rowIdx}, '${fieldKey}', ${iIdx})">${item.desc}</div>
                ${mInfo ? `
                    <div id="box-${patchKey}" class="master-box ${isCollapsed ? 'hidden' : ''}">
                        <b>Master Details:</b>
                        ${renderMasterContent(mInfo)}
                    </div>` : ''}
            </li>`;
        });
        return h + `</ul>`;
    }

    // S·ª≠a tr∆∞·ªùng ƒë∆°n gi·∫£n (nh∆∞ TRANSLATION)
    window.editField = (el, idx, key) => {
        if (el.querySelector('textarea')) return;
        const oldVal = excelRows[idx][key] || "";
        const input = document.createElement('textarea');
        input.className = "inline-edit";
        input.value = oldVal;
        el.innerHTML = "";
        el.appendChild(input);
        input.focus();
        input.onblur = () => {
            excelRows[idx][key] = input.value;
            el.innerText = input.value || "Ch∆∞a c√≥ n·ªôi dung";
        };
    };

    // S·ª≠a tr∆∞·ªùng ph·ª©c t·∫°p (Grammar/Components trong ngo·∫∑c nh·ªçn)
    window.editArrayField = (el, rowIdx, fieldKey, itemIdx) => {
        if (el.querySelector('textarea')) return;
        const items = parseCurlyBrackets(excelRows[rowIdx][fieldKey]);
        const oldDesc = items[itemIdx].desc;
        
        const input = document.createElement('textarea');
        input.className = "inline-edit";
        input.value = oldDesc;
        el.innerHTML = "";
        el.appendChild(input);
        input.focus();

        input.onblur = () => {
            items[itemIdx].desc = input.value;
            // Build l·∫°i chu·ªói chu·∫©n: {name}:{desc}:{id}
            const newString = items.map(it => {
                const patchKey = `${rowIdx}-${fieldKey === 'GRAMMAR' ? 'grammar' : 'component'}-${items.indexOf(it)}`;
                const finalId = sessionPatches[patchKey] || it.id;
                return `{${it.name}}:{${it.desc}}${finalId ? `:{${finalId}}` : ''}`;
            }).join('; ');
            
            excelRows[rowIdx][fieldKey] = newString;
            el.innerText = input.value;
        };
    };

    function renderMasterContent(info) {
        let content = "";
        for (const [key, value] of Object.entries(info)) {
            if (key === 'master_id') continue;
            let displayValue = value;
            if (Array.isArray(value)) {
                displayValue = value.map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(', ');
            } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value);
            }
            content += `<div class="master-entry"><span class="master-key">${key}:</span> ${displayValue}</div>`;
        }
        return content;
    }

    window.toggleMasterBox = (key) => {
        collapsedState[key] = !collapsedState[key];
        const box = document.getElementById('box-' + key);
        if (box) box.classList.toggle('hidden');
        const badge = box.parentElement.querySelector('.tag-id-badge');
        if (badge) {
            const idVal = badge.innerText.split(' ')[1];
            badge.innerHTML = `ID: ${idVal} ${collapsedState[key] ? '‚ñº' : '‚ñ≤'}`;
        }
    };

    window.speakText = (htmlStr) => {
        const div = document.createElement('div');
        div.innerHTML = htmlStr;
        const rubies = div.querySelectorAll('ruby');
        rubies.forEach(ruby => {
            const rt = ruby.querySelector('rt');
            if (rt) rt.remove(); 
        });
        const cleanText = div.textContent || div.innerText;
        const msg = new SpeechSynthesisUtterance(cleanText);
        msg.lang = 'ja-JP';
        msg.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
    };

    window.openSearch = (type, rowIdx, iIdx, name) => {
        activeTarget = { type, rowIdx, iIdx };
        const html = `
            <h3>G√°n ID: ${name}</h3>
            <input type="text" id="master-search" placeholder="T√¨m pattern ho·∫∑c ID..." oninput="runSearch(this.value)">
            <div id="search-results" style="margin-top:10px; max-height:300px; overflow-y:auto;"></div>
            <button class="btn" onclick="showDetail(${rowIdx}, 'all')" style="width:100%; margin-top:10px;">Quay l·∫°i</button>
        `;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('master-search').focus();
    };

    window.runSearch = val => {
        if (!val) return;
        const res = masterDB.filter(m => 
            (m.pattern && m.pattern.includes(val)) || 
            (m.master_id && m.master_id.includes(val))
        );
        document.getElementById('search-results').innerHTML = res.map(r => `
            <div class="result-item" onclick="saveID('${r.master_id}')">
                <strong>${r.pattern || 'No Pattern'}</strong> (${r.master_id})<br>
                <small>${r.core_meaning || ''}</small>
            </div>
        `).join('');
    };

    window.saveID = id => {
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        sessionPatches[key] = id;
        collapsedState[key] = false;
        localStorage.setItem('jp_patches_v3', JSON.stringify(sessionPatches));
        
        // C·∫≠p nh·∫≠t l·∫°i chu·ªói trong excelRows ngay khi g√°n ID ƒë·ªÉ ƒë·ªìng b·ªô
        const fieldKey = activeTarget.type === 'grammar' ? 'GRAMMAR' : 'COMPONENTS';
        const items = parseCurlyBrackets(excelRows[activeTarget.rowIdx][fieldKey]);
        const newString = items.map((it, idx) => {
            const pKey = `${activeTarget.rowIdx}-${activeTarget.type}-${idx}`;
            const finalId = sessionPatches[pKey] || it.id;
            return `{${it.name}}:{${it.desc}}${finalId ? `:{${finalId}}` : ''}`;
        }).join('; ');
        excelRows[activeTarget.rowIdx][fieldKey] = newString;

        showDetail(activeTarget.rowIdx, 'all');
    };

    window.exportNewData = () => {
        let out = "D·ªÆ LI·ªÜU ƒê√É CH·ªàNH S·ª¨A (D√°n v√†o Excel):\n\n";
        excelRows.forEach((row, rIdx) => {
            out += `--- D√íNG ${rIdx + 1} ---\n`;
            out += `NG·ªÆ PH√ÅP: ${row.GRAMMAR || ''}\n`;
            out += `TH√ÄNH PH·∫¶N: ${row.COMPONENTS || ''}\n`;
            out += `B·∫¢N D·ªäCH: ${row.TRANSLATION || ''}\n\n`;
        });
        const blob = new Blob([out], {type: "text/plain"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "data_updated.txt";
        link.click();
    };

    window.closePopup = () => {
        window.speechSynthesis.cancel();
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('popup').classList.add('hidden');
    };
</script>
</body>
</html>
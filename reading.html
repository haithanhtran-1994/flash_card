<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP Dynamic Linker v2 - Editor Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #fdfaf6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 10px; border: 1px solid #eee; }
        .hidden { display: none; }
        
        #content-list { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            line-height: 2.2; 
            white-space: pre-wrap;
            text-align: justify;
        }
        /* CSS ·∫©n Furigana */
        #content-list.hide-furi rt { display: none; }

        .source-sentence { 
            display: inline; 
            font-size: 1.15rem; 
            color: #2c3e50; 
            cursor: pointer; 
            padding: 0 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .source-sentence:hover { background: #fff8e1; color: var(--accent); }

        .smart-list { list-style: none; padding: 0; margin: 10px 0; }
        .smart-item { margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .tag-row { display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 5px; }
        .tag-label { background: #34495e; color: white; padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; }
        .tag-id-badge { font-family: monospace; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; border: 1px dashed; cursor: pointer; }
        .id-exists { border-color: #27ae60; color: #27ae60; background: #ebf7ee; }
        .id-none { border-color: #e74c3c; color: #e74c3c; background: #fdf2f2; }
        
        .tag-desc { color: #555; font-size: 0.95rem; line-height: 1.4; padding: 5px; border: 1px solid transparent; border-radius: 4px; }
        .tag-desc:hover { border-color: #ddd; background: #fff; cursor: edit; }
        
        .master-box { margin-top: 8px; padding: 10px; background: #fffde7; border-radius: 8px; border-left: 4px solid #fbc02d; font-size: 0.85rem; }
        .master-entry { margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .master-key { font-weight: bold; color: #7f8c8d; text-transform: capitalize; }

        .edit-container { display: flex; flex-direction: column; gap: 5px; margin: 5px 0; }
        .inline-edit { width: 100%; font-size: 0.95rem; padding: 8px; border: 2px solid var(--accent); border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .edit-buttons { display: flex; gap: 5px; justify-content: flex-end; }
        .btn-save { background: #27ae60; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-cancel { background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        .action-bar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; background: #ecf0f1; color: #2c3e50; }
        .btn-sm.active { background: var(--accent); color: white; }

        .popup { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); z-index: 1000; max-height: 80vh; overflow-y: auto; }
        #master-search { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; margin-top: 10px; box-sizing: border-box;}
        .result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item:hover { background: #fff8e1; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* Style cho c√°c tag ID trong popup ƒë·ªÉ x√≥a l·∫ª */
        .mini-id-tag { display: inline-flex; align-items: center; background: #eee; padding: 2px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; font-size: 0.8rem; border: 1px solid #ccc; }
        .mini-id-del { color: #e74c3c; font-weight: bold; margin-left: 6px; cursor: pointer; padding: 0 4px; }
        .mini-id-del:hover { background: #fdd; border-radius: 50%; }
    </style>
</head>
<body>

    <div id="setup-view" class="card">
        <h3>1. Master JSON</h3>
        <input type="file" id="master-input" accept=".json">
        <hr>
        <h3>2. Excel Data</h3>
        <input type="file" id="excel-input" accept=".xlsx">
    </div>

    <div id="main-app" class="hidden">
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn" style="background: #27ae60; color: white; flex: 1;" onclick="exportNewData()">üì• Xu·∫•t Excel Data M·ªõi</button>
            <button id="furi-toggle" class="btn" style="background: #f39c12; color: white;" onclick="toggleFurigana()">FURI</button>
            <button class="btn" style="background: #95a5a6; color: white;" onclick="location.reload()">üîÑ ƒê·ªïi File</button>
        </div>
        <div id="content-list"></div>
    </div>

    <div id="overlay" class="overlay hidden" onclick="closePopup()"></div>
    <div id="popup" class="popup hidden">
        <div id="popup-inner"></div>
    </div>

<script>
    let masterDB = [];
    let excelRows = [];
    let sessionPatches = JSON.parse(localStorage.getItem('jp_patches_v3') || '{}');
    let collapsedState = {}; 
    let activeTarget = null;
    let isFuriHidden = false;

    document.getElementById('master-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => { masterDB = JSON.parse(ev.target.result); alert("‚úÖ Master n·∫°p xong!"); };
        r.readAsText(e.target.files[0]);
    };

    document.getElementById('excel-input').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
            excelRows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            renderList();
        };
        r.readAsArrayBuffer(e.target.files[0]);
    };

    // H√†m b·∫≠t t·∫Øt Furigana
    function toggleFurigana() {
        isFuriHidden = !isFuriHidden;
        const container = document.getElementById('content-list');
        const btn = document.getElementById('furi-toggle');
        if (isFuriHidden) {
            container.classList.add('hide-furi');
            btn.style.opacity = "0.6";
        } else {
            container.classList.remove('hide-furi');
            btn.style.opacity = "1";
        }
    }

    function parseCurlyBrackets(str) {
        if (!str) return [];
        const regex = /\{([^}]+)\}/g;
        const items = str.split(/[;\n]/);
        return items.map(item => {
            const matches = [];
            let m;
            while ((m = regex.exec(item)) !== null) { matches.push(m[1]); }
            return { name: matches[0] || "", desc: matches[1] || "", id: matches[2] || "" };
        }).filter(x => x.name !== "");
    }

    function renderList() {
        const container = document.getElementById('content-list');
        container.innerHTML = excelRows.map((row, idx) => {
            const text = (row.SOURCE || '').replace(/\\n/g, '\n');
            return `<span class="source-sentence" onclick="showDetail(${idx}, 'all')">${text}</span>`;
        }).join(' ');
    }

    function showDetail(idx, mode) {
        const row = excelRows[idx];
        const grammars = parseCurlyBrackets(row.GRAMMAR);
        const components = parseCurlyBrackets(row.COMPONENTS);

        let html = `
            <div class="action-bar">
                <button class="btn-sm ${mode==='trans'?'active':''}" onclick="showDetail(${idx}, 'trans')">D·ªãch</button>
                <button class="btn-sm ${mode==='grammar'?'active':''}" onclick="showDetail(${idx}, 'grammar')">Ng·ªØ ph√°p</button>
                <button class="btn-sm ${mode==='comp'?'active':''}" onclick="showDetail(${idx}, 'comp')">Th√†nh ph·∫ßn</button>
                <button class="btn-sm ${mode==='all'?'active':''}" onclick="showDetail(${idx}, 'all')">T·∫•t c·∫£</button>
                <button class="btn-sm" style="background:#3498db; color:white;" onclick="speakText(\`${row.SOURCE}\`)">üîä ƒê·ªçc</button>
            </div>
        `;

        if (mode === 'all' || mode === 'grammar') {
            html += `<h4>üî∏ Ng·ªØ ph√°p:</h4>` + renderSection(grammars, 'GRAMMAR', idx, mode);
        }
        if (mode === 'all' || mode === 'comp') {
            html += `<h4>üîπ Th√†nh ph·∫ßn:</h4>` + renderSection(components, 'COMPONENTS', idx, mode);
        }
        if (mode === 'all' || mode === 'trans') {
            html += `<h4>üìú B·∫£n d·ªãch:</h4>
                     <div class="card tag-desc" style="background:#f9f9f9;" 
                          onclick="editField(this, ${idx}, 'TRANSLATION')">${row.TRANSLATION || 'Ch∆∞a c√≥ b·∫£n d·ªãch'}</div>`;
        }

        html += `<button class="btn" onclick="closePopup()" style="width:100%; margin-top:20px; background:#eee">ƒê√≥ng</button>`;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('popup').classList.remove('hidden');
    }

    function renderSection(items, fieldKey, rowIdx, mode) {
        let h = `<ul class="smart-list">`;
        if (items.length === 0) h += `<li style="color:#999; font-size:0.8rem;">(Tr·ªëng)</li>`;
        items.forEach((item, iIdx) => {
            const type = fieldKey === 'GRAMMAR' ? 'grammar' : 'component';
            const patchKey = `${rowIdx}-${type}-${iIdx}`;
            const currentId = sessionPatches[patchKey] || item.id;
            const isCollapsed = collapsedState[patchKey] === true;

            const ids = currentId ? currentId.split(',').map(s => s.trim()) : [];
            const masterInfos = ids.map(id => masterDB.find(m => m.master_id === id)).filter(x => x);

            h += `<li class="smart-item">
                <div class="tag-row">
                    <span class="tag-label" onclick="openSearch('${type}', ${rowIdx}, ${iIdx}, '${item.name}')">${item.name}</span>
                    <span class="tag-id-badge ${currentId ? 'id-exists' : 'id-none'}" onclick="toggleMasterBox('${patchKey}')">
                        ID: ${currentId || 'Ch∆∞a g√°n'} ${currentId ? (isCollapsed ? '‚ñº' : '‚ñ≤') : ''}
                    </span>
                </div>
                <div class="tag-desc" onclick="editArrayField(this, ${rowIdx}, '${fieldKey}', ${iIdx})">${item.desc}</div>
                <div id="box-${patchKey}" class="master-box ${isCollapsed || !currentId ? 'hidden' : ''}">
                    ${masterInfos.length > 0 ? masterInfos.map(mInfo => `
                        <div style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                            <b>Master [${mInfo.master_id}]:</b>
                            ${renderMasterContent(mInfo)}
                        </div>
                    `).join('') : '<i>Kh√¥ng t√¨m th·∫•y th√¥ng tin trong Master DB</i>'}
                </div>
            </li>`;
        });
        return h + `</ul>`;
    }

    window.editField = (el, idx, key) => {
        if (el.querySelector('textarea')) return;
        const oldVal = excelRows[idx][key] || "";
        el.innerHTML = `
            <div class="edit-container">
                <textarea class="inline-edit">${oldVal}</textarea>
                <div class="edit-buttons">
                    <button class="btn-cancel" onclick="event.stopPropagation(); renderAfterEdit(${idx})">H·ªßy</button>
                    <button class="btn-save" onclick="event.stopPropagation(); saveField(${idx}, '${key}', this)">L∆∞u</button>
                </div>
            </div>`;
        el.querySelector('textarea').focus();
    };

    window.saveField = (idx, key, btn) => {
        const newVal = btn.closest('.edit-container').querySelector('textarea').value;
        excelRows[idx][key] = newVal;
        renderAfterEdit(idx);
    };

    window.editArrayField = (el, rowIdx, fieldKey, itemIdx) => {
        if (el.querySelector('textarea')) return;
        const items = parseCurlyBrackets(excelRows[rowIdx][fieldKey]);
        const oldDesc = items[itemIdx].desc;
        el.innerHTML = `
            <div class="edit-container">
                <textarea class="inline-edit">${oldDesc}</textarea>
                <div class="edit-buttons">
                    <button class="btn-cancel" onclick="event.stopPropagation(); renderAfterEdit(${rowIdx})">H·ªßy</button>
                    <button class="btn-save" onclick="event.stopPropagation(); saveArrayField(${rowIdx}, '${fieldKey}', ${itemIdx}, this)">L∆∞u</button>
                </div>
            </div>`;
        el.querySelector('textarea').focus();
    };

    window.saveArrayField = (rowIdx, fieldKey, itemIdx, btn) => {
        const items = parseCurlyBrackets(excelRows[rowIdx][fieldKey]);
        items[itemIdx].desc = btn.closest('.edit-container').querySelector('textarea').value;
        updateRowString(rowIdx, fieldKey, items);
        renderAfterEdit(rowIdx);
    };

    function updateRowString(rowIdx, fieldKey, items) {
        const newString = items.map((it, idx) => {
            const type = fieldKey === 'GRAMMAR' ? 'grammar' : 'component';
            const pKey = `${rowIdx}-${type}-${idx}`;
            const finalId = sessionPatches[pKey] || it.id;
            return `{${it.name}}:{${it.desc}}${finalId ? `:{${finalId}}` : ''}`;
        }).join('; ');
        excelRows[rowIdx][fieldKey] = newString;
    }

    window.renderAfterEdit = (idx) => {
        showDetail(idx, 'all');
    };

    function renderMasterContent(info) {
        let content = "";
        for (const [key, value] of Object.entries(info)) {
            if (key === 'master_id') continue;
            let displayValue = value;
            if (Array.isArray(value)) {
                displayValue = value.map(v => typeof v === 'object' ? JSON.stringify(v) : v).join(', ');
            } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value);
            }
            content += `<div class="master-entry"><span class="master-key">${key}:</span> ${displayValue}</div>`;
        }
        return content;
    }

    window.toggleMasterBox = (key) => {
        collapsedState[key] = !collapsedState[key];
        const box = document.getElementById('box-' + key);
        if (box) box.classList.toggle('hidden');
        const badge = box.parentElement.querySelector('.tag-id-badge');
        if (badge) {
            const currentText = badge.innerText;
            const idPart = currentText.replace('ID: ', '').split(' ')[0];
            badge.innerHTML = `ID: ${idPart} ${collapsedState[key] ? '‚ñº' : '‚ñ≤'}`;
        }
    };

    window.speakText = (htmlStr) => {
        const div = document.createElement('div');
        div.innerHTML = htmlStr;
        div.querySelectorAll('rt').forEach(rt => rt.remove());
        const msg = new SpeechSynthesisUtterance(div.textContent || div.innerText);
        msg.lang = 'ja-JP';
        msg.rate = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
    };

    window.openSearch = (type, rowIdx, iIdx, name) => {
        activeTarget = { type, rowIdx, iIdx };
        const patchKey = `${rowIdx}-${type}-${iIdx}`;
        const currentId = sessionPatches[patchKey] || "";
        const ids = currentId ? currentId.split(',').filter(x => x) : [];

        const html = `
            <h3>G√°n ID cho: ${name}</h3>
            <div id="current-tags" style="margin-bottom:10px;">
                ${ids.length > 0 ? ids.map(id => `
                    <span class="mini-id-tag">${id}<span class="mini-id-del" onclick="removeSingleID('${id}')">√ó</span></span>
                `).join('') : '<span style="color:#999; font-size:0.8rem;">(Ch∆∞a c√≥ ID n√†o ƒë∆∞·ª£c g√°n)</span>'}
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="master-search" placeholder="T√¨m pattern ho·∫∑c ID..." oninput="runSearch(this.value)">
                <button class="btn" onclick="clearAllIDs()" style="margin-top:10px; background:#e74c3c; color:white; padding: 0 15px; font-size:0.8rem; white-space:nowrap;">X√≥a h·∫øt</button>
            </div>
            <div id="search-results" style="margin-top:10px; max-height:300px; overflow-y:auto; border:1px solid #eee;"></div>
            <button class="btn" onclick="showDetail(${rowIdx}, 'all')" style="width:100%; margin-top:10px;">Quay l·∫°i</button>
        `;
        document.getElementById('popup-inner').innerHTML = html;
        document.getElementById('master-search').focus();
    };

    window.runSearch = val => {
        if (!val) { document.getElementById('search-results').innerHTML = ""; return; }
        const res = masterDB.filter(m => 
            (m.pattern && m.pattern.includes(val)) || 
            (m.master_id && m.master_id.includes(val))
        );
        document.getElementById('search-results').innerHTML = res.map(r => `
            <div class="result-item" onclick="saveID('${r.master_id}')">
                <strong>${r.pattern || 'No Pattern'}</strong> (${r.master_id})<br>
                <small>${r.core_meaning || ''}</small>
            </div>
        `).join('');
    };

    window.saveID = id => {
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        let currentIds = sessionPatches[key] ? sessionPatches[key].split(',') : [];
        if (!currentIds.includes(id)) {
            currentIds.push(id);
        }
        sessionPatches[key] = currentIds.filter(x => x).join(',');
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, ""); 
    };

    window.removeSingleID = (idToRemove) => {
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        let currentIds = sessionPatches[key] ? sessionPatches[key].split(',') : [];
        currentIds = currentIds.filter(id => id !== idToRemove);
        sessionPatches[key] = currentIds.join(',');
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, ""); 
    };

    window.clearAllIDs = () => {
        if(!confirm("X√≥a t·∫•t c·∫£ ID ƒë√£ g√°n cho m·ª•c n√†y?")) return;
        const key = `${activeTarget.rowIdx}-${activeTarget.type}-${activeTarget.iIdx}`;
        sessionPatches[key] = "";
        applyPatchToData();
        openSearch(activeTarget.type, activeTarget.rowIdx, activeTarget.iIdx, "");
    };

    function applyPatchToData() {
        localStorage.setItem('jp_patches_v3', JSON.stringify(sessionPatches));
        const fieldKey = activeTarget.type === 'grammar' ? 'GRAMMAR' : 'COMPONENTS';
        const items = parseCurlyBrackets(excelRows[activeTarget.rowIdx][fieldKey]);
        updateRowString(activeTarget.rowIdx, fieldKey, items);
    }

    window.exportNewData = () => {
        let out = "D·ªÆ LI·ªÜU ƒê√É CH·ªàNH S·ª¨A (D√°n v√†o Excel):\n\n";
        excelRows.forEach((row, rIdx) => {
            out += `--- D√íNG ${rIdx + 1} ---\n`;
            out += `NG·ªÆ PH√ÅP: ${row.GRAMMAR || ''}\n`;
            out += `TH√ÄNH PH·∫¶N: ${row.COMPONENTS || ''}\n`;
            out += `B·∫¢N D·ªäCH: ${row.TRANSLATION || ''}\n\n`;
        });
        const blob = new Blob([out], {type: "text/plain"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "data_updated.txt";
        link.click();
    };

    window.closePopup = () => {
        window.speechSynthesis.cancel();
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('popup').classList.add('hidden');
        renderList(); 
    };
</script>
</body>
</html>
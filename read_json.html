<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Book Editor Pro</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; color: #333; }
        .app-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #book-viewer { background: white; padding: 50px; margin-top: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80vh; line-height: 2; font-size: 19px; }
        
        .block { margin-bottom: 15px; cursor: pointer; padding: 8px; border-radius: 4px; border-left: 4px solid transparent; position: relative; }
        .block:hover { background: #f8f9fa; border-left-color: #007bff; }
        .block.chapter { font-size: 1.8em; font-weight: bold; color: #1a73e8; border: none; }

        /* Sidebar Editor */
        #editor-overlay { position: fixed; right: 0; top: 0; width: 450px; height: 100%; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.15); z-index: 1000; overflow-y: auto; padding: 25px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .close-btn { float: right; font-size: 30px; cursor: pointer; color: #999; }
        
        .section-group { background: #f9f9f9; border: 1px solid #ddd; padding: 12px; margin-top: 10px; border-radius: 6px; position: relative; }
        .header-split { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; border-bottom: 2px solid #eee; }
        
        .clickable-header { cursor: pointer; transition: color 0.2s; }
        .clickable-header:hover { color: #007bff; }
        
        input, textarea { width: 100%; box-sizing: border-box; margin-bottom: 8px; border: 1px solid #ccc; padding: 8px; border-radius: 4px; font-size: 14px; }
        button { cursor: pointer; padding: 8px 12px; border-radius: 5px; border: none; }
        #exportBtn { background: #28a745; color: white; font-weight: bold; }
        .add-btn { background: #007bff; color: white; }
        
        .btn-x {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            color: #ccc;
            font-size: 18px;
            font-weight: bold;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s;
            cursor: pointer;
        }
        .btn-x:hover { color: #dc3545; }

        .ref-link { color: #007bff; cursor: pointer; font-size: 12px; text-decoration: underline; display: inline-block; margin-bottom: 5px; }
        .ref-link:hover { color: #0056b3; }
        .tooltip-box { position: absolute; background: #333; color: white; padding: 12px; border-radius: 8px; font-size: 13px; z-index: 2000; width: 280px; line-height: 1.5; pointer-events: none; box-shadow: 0 8px 16px rgba(0,0,0,0.4); }
        .tooltip-box hr { border: 0; border-top: 1px solid #555; margin: 8px 0; }
        .tooltip-item { margin-bottom: 4px; }
        .tooltip-label { color: #aaa; font-size: 11px; text-transform: uppercase; display: block; }

        #search-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 3000; width: 400px; padding: 20px; }
        .search-results { max-height: 300px; overflow-y: auto; margin-top: 10px; }
        .search-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .search-item:hover { background: #f0f7ff; }

        #filter-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 4000; width: 300px; padding: 20px; }
        .filter-option { display: flex; align-items: center; gap: 10px; padding: 5px 0; }
        .filter-option input { width: auto; margin: 0; }

        #text-toolbar { position: absolute; background: #333; color: white; padding: 8px; border-radius: 8px; display: flex; gap: 8px; z-index: 2000; }
        .hl-item { border-radius: 3px; padding: 2px 0; }
        .ul-item { border-bottom-style: solid; border-bottom-width: 2px; }

        /* M·ªöI: Menu View Style */
        .view-dropdown { position: relative; display: inline-block; }
        .view-btn { background: #6c757d; color: white; margin-left: 10px; }
        .view-content { 
            position: absolute; right: 0; top: 100%; background: white; 
            min-width: 180px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); 
            z-index: 5000; border-radius: 8px; padding: 10px;
        }
        .view-content label { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; font-size: 14px; }
        .view-content label:hover { background: #f1f1f1; }
        .view-content input { width: auto; margin: 0; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h2>üìö JSON Editor</h2>
            <div>
                <span style="font-size: 12px; color: #666;">Book:</span>
                <input type="file" id="fileInput" accept=".json" style="width: 150px;">
                <span style="font-size: 12px; color: #666; margin-left: 10px;">Master:</span>
                <input type="file" id="masterInput" accept=".json" style="width: 150px;">
                
                <div class="view-dropdown">
                    <button class="view-btn" onclick="toggleViewMenu()">View üëÅÔ∏è</button>
                    <div id="viewMenu" class="view-content hidden">
                        <label><input type="checkbox" checked onchange="toggleView('trans', this.checked)"> B·∫£n d·ªãch</label>
                        <label><input type="checkbox" checked onchange="toggleView('marks', this.checked)"> Highlights & Underlines</label>
                        <label><input type="checkbox" checked onchange="toggleView('grammar', this.checked)"> Ng·ªØ ph√°p</label>
                        <label><input type="checkbox" checked onchange="toggleView('analysis', this.checked)"> Ph√¢n t√≠ch c√¢u</label>
                    </div>
                </div>

                <button id="exportBtn">Xu·∫•t File</button>
            </div>
        </header>
        <main id="book-viewer">
            <p style="text-align:center; color:#999">T·∫£i file JSON ƒë·ªÉ b·∫Øt ƒë·∫ßu...</p>
        </main>
    </div>

    <div id="search-modal" class="hidden">
        <h4>T√¨m ki·∫øm Master Data</h4>
        <input type="text" id="masterSearch" placeholder="Nh·∫≠p pattern, reading ho·∫∑c √Ω nghƒ©a..." oninput="filterMasterData()">
        <div class="search-results" id="search-results"></div>
        <button onclick="closeSearch()" style="margin-top: 10px; width: 100%;">ƒê√≥ng</button>
    </div>

    <div id="filter-modal" class="hidden">
        <h4 id="filter-title">C·∫•u h√¨nh hi·ªÉn th·ªã</h4>
        <div id="filter-options"></div>
        <button onclick="closeFilter()" style="margin-top: 15px; width: 100%; background: #007bff; color: white;">Xong</button>
    </div>

    <div id="editor-overlay" class="hidden">
        <span class="close-btn" onclick="closeEditor()">&times;</span>
        <h3 id="edit-title">Chi ti·∫øt Block</h3>
        
        <div id="container-trans">
            <label>B·∫£n d·ªãch (VI):</label>
            <textarea id="edit-trans" rows="3"></textarea>
        </div>

        <div id="container-marks">
            <div class="header-split"><h4>Highlights & Underlines</h4></div>
            <div id="marks-list"></div>
        </div>

        <div id="container-grammar">
            <div class="header-split">
                <h4 class="clickable-header" onclick="openFilter('grammar')">Ng·ªØ ph√°p ‚öôÔ∏è</h4>
                <button class="add-btn" onclick="addItem('grammar')">+</button>
            </div>
            <div id="grammar-list"></div>
        </div>

        <div id="container-analysis">
            <div class="header-split">
                <h4 class="clickable-header" onclick="openFilter('analysis')">Ph√¢n t√≠ch c√¢u ‚öôÔ∏è</h4>
                <button class="add-btn" onclick="addItem('analysis')">+</button>
            </div>
            <div id="analysis-list"></div>
        </div>

        <button style="width:100%; margin-top:30px; background:#444; color:white;" onclick="closeEditor()">L∆∞u & ƒê√≥ng</button>
    </div>

    <div id="text-toolbar" class="hidden">
        <input type="color" id="markColor" value="#ffff00">
        <button onclick="applyMark('highlight')">Highlight</button>
        <button onclick="applyMark('underline')">Underline</button>
    </div>

    <script>
        let bookData = null;
        let masterData = JSON.parse(localStorage.getItem('master_data_cache')) || [];
        let currentBlockId = null;
        let currentAssigningRef = { type: null, index: null };
        
        let displayFilters = JSON.parse(localStorage.getItem('display_filters')) || { grammar: [], analysis: [] };
        let currentFilterType = '';

        // M·ªöI: L∆∞u tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa c√°c module Editor
        let editorModulesVisibility = { trans: true, marks: true, grammar: true, analysis: true };

        function toggleViewMenu() {
            document.getElementById('viewMenu').classList.toggle('hidden');
        }

        function toggleView(module, isVisible) {
            editorModulesVisibility[module] = isVisible;
            if (currentBlockId) {
                const block = bookData.blocks.find(b => b.id === currentBlockId);
                refreshEditorLists(block);
            }
        }

        // ƒê√≥ng menu view khi click ra ngo√†i
        window.onclick = function(event) {
            if (!event.target.matches('.view-btn')) {
                const menu = document.getElementById('viewMenu');
                if (menu && !menu.classList.contains('hidden')) menu.classList.add('hidden');
            }
        }

        document.getElementById('masterInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                masterData = JSON.parse(ev.target.result);
                localStorage.setItem('master_data_cache', JSON.stringify(masterData));
                alert("ƒê√£ t·∫£i v√† l∆∞u Master Data!");
            };
            reader.readAsText(e.target.files[0]);
        };

        document.getElementById('fileInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                bookData = JSON.parse(ev.target.result);
                renderBook();
            };
            reader.readAsText(e.target.files[0]);
        };

        const hexToCss = (hex) => hex ? hex.replace('0x', '#') : '#ffff00';
        const cssToHex = (css) => css.replace('#', '0x');

        function renderBook() {
            if (!bookData) return;
            const viewer = document.getElementById('book-viewer');
            viewer.innerHTML = '';
            
            bookData.blocks.forEach(block => {
                const div = document.createElement('div');
                div.className = `block ${block.type}`;
                div.id = block.id;
                
                let content = block.content.raw;
                if (block.highlights) {
                    block.highlights.forEach(hl => {
                        const color = hexToCss(hl.color);
                        content = content.split(hl.quote).join(`<span class="hl-item" style="background-color: ${color}">${hl.quote}</span>`);
                    });
                }
                if (block.underlines) {
                    block.underlines.forEach(ul => {
                        const color = hexToCss(ul.color);
                        content = content.split(ul.quote).join(`<span class="ul-item" style="border-bottom-color: ${color}">${ul.quote}</span>`);
                    });
                }

                div.innerHTML = content;
                div.onclick = () => openEditor(block.id);
                viewer.appendChild(div);
            });
        }

        function openEditor(id) {
            currentBlockId = id;
            const block = bookData.blocks.find(b => b.id === id);
            document.getElementById('edit-title').innerText = "Block: " + id;
            document.getElementById('edit-trans').value = block.translation?.vi || '';
            refreshEditorLists(block);
            document.getElementById('editor-overlay').classList.remove('hidden');
        }

        function refreshEditorLists(block) {
            // M·ªöI: ·∫®n hi·ªán c√°c container d·ª±a tr√™n View Menu
            document.getElementById('container-trans').className = editorModulesVisibility.trans ? '' : 'hidden';
            document.getElementById('container-marks').className = editorModulesVisibility.marks ? '' : 'hidden';
            document.getElementById('container-grammar').className = editorModulesVisibility.grammar ? '' : 'hidden';
            document.getElementById('container-analysis').className = editorModulesVisibility.analysis ? '' : 'hidden';

            const marksList = document.getElementById('marks-list');
            marksList.innerHTML = '';
            ['highlights', 'underlines'].forEach(key => {
                (block[key] || []).forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'section-group';
                    div.innerHTML = `
                        <small>${key === 'highlights' ? 'üü° Highlight' : '‚ûñ Underline'}: <b>"${item.quote}"</b></small>
                        <input type="text" placeholder="Ghi ch√∫ (Note)" value="${item.note || ''}" onchange="updateMark('${key}', ${idx}, this.value)">
                        <button class="del-btn" onclick="deleteMark('${key}', ${idx})">X√≥a</button>
                    `;
                    marksList.appendChild(div);
                });
            });

            document.getElementById('grammar-list').innerHTML = renderItems(block.grammar, 'grammar');
            document.getElementById('analysis-list').innerHTML = renderItems(block.analysis, 'analysis');
        }

        function renderItems(items, type) {
            return (items || []).map((item, i) => {
                const refText = item.ref_id ? `ID: ${item.ref_id}` : "[G√°n ID Master]";
                return `
                <div class="section-group">
                    <span class="btn-x" onclick="removeItem('${type}',${i})" title="X√≥a">√ó</span>
                    <span class="ref-link" 
                          onmouseover="showTooltip(event, '${item.ref_id}', '${type}')" 
                          onmouseout="hideTooltip()" 
                          onclick="openSearch('${type}', ${i})">${refText}</span>
                    <input value="${item.quote}" oninput="updateField('${type}',${i},'quote',this.value)" placeholder="Quote">
                    ${type === 'analysis' ? `<input value="${item.role || ''}" oninput="updateField('${type}',${i},'role',this.value)" placeholder="Role (Vai tr√≤)">` : ''}
                    <textarea oninput="updateField('${type}',${i},'explanation',this.value)" placeholder="Gi·∫£i th√≠ch">${item.explanation}</textarea>
                </div>
            `}).join('');
        }

        function openFilter(type) {
            currentFilterType = type;
            const modal = document.getElementById('filter-modal');
            const optionsDiv = document.getElementById('filter-options');
            document.getElementById('filter-title').innerText = `·∫®n tr∆∞·ªùng (${type === 'grammar' ? 'Ng·ªØ ph√°p' : 'Ph√¢n t√≠ch'})`;
            
            let allKeys = [];
            if (masterData.length > 0) {
                allKeys = Object.keys(masterData[0]);
            } else {
                optionsDiv.innerHTML = '<p>H√£y load Master Data tr∆∞·ªõc</p>';
                modal.classList.remove('hidden');
                return;
            }

            optionsDiv.innerHTML = allKeys.map(key => `
                <div class="filter-option">
                    <input type="checkbox" id="f-${key}" ${displayFilters[type].includes(key) ? 'checked' : ''} 
                           onchange="toggleFilterField('${key}')">
                    <label for="f-${key}">${key}</label>
                </div>
            `).join('');

            modal.classList.remove('hidden');
        }

        function toggleFilterField(key) {
            const index = displayFilters[currentFilterType].indexOf(key);
            if (index > -1) {
                displayFilters[currentFilterType].splice(index, 1);
            } else {
                displayFilters[currentFilterType].push(key);
            }
            localStorage.setItem('display_filters', JSON.stringify(displayFilters));
        }

        function closeFilter() {
            document.getElementById('filter-modal').classList.add('hidden');
        }

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip-box hidden';
        document.body.appendChild(tooltip);

        function showTooltip(e, refId, type) {
            if (!refId || masterData.length === 0) return;
            const info = masterData.find(m => m.master_id === refId);
            if (!info) return;

            const hiddenFields = displayFilters[type] || [];
            let htmlContent = '';

            Object.keys(info).forEach(key => {
                if (!hiddenFields.includes(key)) {
                    let val = info[key];
                    if (Array.isArray(val)) val = JSON.stringify(val); 
                    if (typeof val === 'object') val = JSON.stringify(val);
                    
                    htmlContent += `
                        <div class="tooltip-item">
                            <span class="tooltip-label">${key}</span>
                            <div>${val}</div>
                        </div>
                    `;
                }
            });

            tooltip.innerHTML = htmlContent || '<em>(Kh√¥ng c√≥ d·ªØ li·ªáu hi·ªÉn th·ªã)</em>';
            tooltip.classList.remove('hidden');
            
            let x = e.pageX + 15;
            let y = e.pageY + 15;
            if (x + 300 > window.innerWidth) x = e.pageX - 300;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        function openSearch(type, index) {
            currentAssigningRef = { type, index };
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('masterSearch').value = '';
            filterMasterData();
        }

        function closeSearch() {
            document.getElementById('search-modal').classList.add('hidden');
        }

        function filterMasterData() {
            const term = document.getElementById('masterSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            const filtered = masterData.filter(m => 
                m.pattern?.toLowerCase().includes(term) || 
                m.reading?.toLowerCase().includes(term) || 
                m.core_meaning?.toLowerCase().includes(term) ||
                m.master_id?.toLowerCase().includes(term)
            );

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<strong>${item.pattern}</strong> (${item.reading})<br><small>${item.core_meaning}</small>`;
                div.onclick = () => assignRefId(item.master_id);
                resultsDiv.appendChild(div);
            });
        }

        function assignRefId(id) {
            const block = bookData.blocks.find(b => b.id === currentBlockId);
            block[currentAssigningRef.type][currentAssigningRef.index].ref_id = id;
            refreshEditorLists(block);
            closeSearch();
        }

        window.updateMark = (key, i, val) => { bookData.blocks.find(b => b.id === currentBlockId)[key][i].note = val; };
        window.deleteMark = (key, i) => { 
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë√°nh d·∫•u n√†y kh√¥ng?")) {
                const block = bookData.blocks.find(b => b.id === currentBlockId);
                block[key].splice(i, 1); 
                renderBook(); 
                refreshEditorLists(block);
            }
        };
        window.updateField = (type, i, field, val) => { 
            const block = bookData.blocks.find(b => b.id === currentBlockId);
            block[type][i][field] = val; 
        };
        window.removeItem = (type, i) => {
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y kh√¥ng?")) {
                const block = bookData.blocks.find(b => b.id === currentBlockId);
                block[type].splice(i, 1);
                refreshEditorLists(block);
            }
        };
        window.addItem = (type) => {
            const block = bookData.blocks.find(b => b.id === currentBlockId);
            if(!block[type]) block[type] = [];
            const newItem = {quote: '', explanation: '', ref_id: ''};
            if(type === 'analysis') newItem.role = '';
            block[type].push(newItem);
            refreshEditorLists(block);
        };

        document.onmouseup = (e) => {
            const sel = window.getSelection();
            const txt = sel.toString().trim();
            const toolbar = document.getElementById('text-toolbar');
            if (txt) {
                const block = sel.anchorNode.parentElement.closest('.block');
                if (block) {
                    toolbar.style.top = (e.pageY - 60) + "px";
                    toolbar.style.left = e.pageX + "px";
                    toolbar.classList.remove('hidden');
                    toolbar.dataset.blockId = block.id;
                    toolbar.dataset.text = txt;
                }
            } else { toolbar.classList.add('hidden'); }
        };

        function applyMark(type) {
            const tb = document.getElementById('text-toolbar');
            const block = bookData.blocks.find(b => b.id === tb.dataset.blockId);
            const key = type === 'highlight' ? 'highlights' : 'underlines';
            if (!block[key]) block[key] = [];
            block[key].push({
                quote: tb.dataset.text,
                color: cssToHex(document.getElementById('markColor').value),
                note: ""
            });
            renderBook();
            tb.classList.add('hidden');
        }

        function closeEditor() { 
            const block = bookData.blocks.find(b => b.id === currentBlockId);
            block.translation = block.translation || {};
            block.translation.vi = document.getElementById('edit-trans').value;
            document.getElementById('editor-overlay').classList.add('hidden'); 
            renderBook(); 
        }

        document.getElementById('exportBtn').onclick = () => {
            const blob = new Blob([JSON.stringify(bookData, null, 4)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "updated_book.json"; a.click();
        };
    </script>
</body>
</html>
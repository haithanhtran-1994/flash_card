<!DOCTYPE html>
<html lang="vi">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="VocabMaster">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Vocab Master Pro</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--primary:#2563eb;--success:#16a34a;--warning:#ca8a04;--danger:#ef4444;--bg:#f1f5f9}
html,body{margin:0;padding:0;width:100%;min-height:100%;background:var(--bg)}
body{font-family:'Segoe UI',sans-serif;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;overflow-y:auto;-webkit-overflow-scrolling:touch}
.container{width:95%;max-width:700px;background:white;padding:25px;border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);margin:20px 0;position:relative}
.hidden{display:none!important}
.field-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;min-height:60px;background:#f8fafc;border-radius:10px;padding:0 5px;overflow:hidden}
.nav-zone{flex:1;display:flex;align-items:center;justify-content:center;height:100%;cursor:pointer;gap:8px;transition:background .2s;-webkit-tap-highlight-color:transparent}
.nav-zone:active{background:#f1f5f9}
.field-label-side{font-size:.75rem;color:#94a3b8;padding:5px;opacity:.6;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.nav-arrow-small{font-size:1.1rem;font-weight:bold;color:var(--primary);flex-shrink:0}
.nav-zone-active{flex:1.2;text-align:center}
.field-active{color:var(--primary);font-size:1.1rem;font-weight:800;border-bottom:3px solid var(--primary);display:inline-block;padding-bottom:2px;cursor:pointer}
.card{height:450px;border:2px solid #e2e8f0;border-radius:20px;display:flex;flex-direction:column;overflow:hidden;background:#fff;position:relative;margin-bottom:20px;touch-action:pan-y}
.card-touch-zone{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background-color .1s}
.card-touch-zone:active{background-color:#f8fafc}
.card-content{font-size:2.2rem;text-align:left;padding:20px;font-weight:bold;color:#1e293b;word-break:break-word;flex:1;width:100%;display:block;white-space:pre-wrap;overflow-y:auto!important;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;box-sizing:border-box}
.card-content::-webkit-scrollbar{width:5px}
.card-content::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}

/* JP-LINE */
.jp-line{display:flex;align-items:center;padding:10px 14px;margin:6px 0;background:#f0f7ff;border-left:4px solid var(--primary);border-radius:10px;cursor:pointer;font-size:1.9rem;font-weight:bold;color:#1e293b;transition:background .15s;position:relative;user-select:none;-webkit-user-select:none;gap:8px}
.jp-line[contenteditable="true"],.jp-line[data-editing="true"]{background:#fffbeb;border-left-color:#f59e0b;outline:none;user-select:text;-webkit-user-select:text;cursor:text;flex-wrap:wrap}
.jp-text[contenteditable="true"]{background:#fffbeb;border-radius:4px;padding:2px 4px;}
.jp-text{flex:1;min-width:0;white-space:pre-wrap;word-break:break-word}
.jp-speak-btn{flex-shrink:0;background:none;border:none;padding:4px 6px;font-size:1rem;opacity:.5;cursor:pointer;border-radius:6px;-webkit-tap-highlight-color:transparent;line-height:1;min-width:auto}
.jp-speak-btn:active{background:rgba(0,0,0,.1);opacity:1;transform:scale(.95)}
.jp-line[contenteditable="true"] .jp-speak-btn{display:none}
.jp-vi-icon{flex-shrink:0;font-size:.7rem;opacity:.3}
.jp-line:active:not([contenteditable="true"]){background:#dbeafe}

/* SCREENTIP */
.screentip{
  position:fixed;z-index:9999;background:#1e293b;color:white;
  padding:12px 16px;border-radius:12px;font-size:1.05rem;font-weight:normal;
  line-height:1.7;box-shadow:0 10px 25px rgba(0,0,0,.4);
  word-break:break-word;display:none;cursor:pointer;
  /* FIXED: constrain to viewport, scrollable */
  max-width:min(85vw,360px);
  max-height:55vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.screentip[contenteditable="true"]{background:#0f172a;outline:2px solid #6366f1;cursor:text;user-select:text;-webkit-user-select:text}
.screentip-btns{position:fixed;z-index:10000;display:flex;gap:6px}

button{padding:14px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:transform .1s;-webkit-tap-highlight-color:transparent}
button:active{transform:scale(.98)}
.btn-sync{background:#16a34a;color:white;font-size:.8rem;padding:10px;width:100%;border-radius:8px;font-weight:bold}
.sync-section{margin-top:20px;padding:15px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px}
.action-panel{margin-top:20px;padding:15px;border-top:2px solid #e2e8f0;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn-autoplay{background:#8b5cf6;color:white;margin-top:5px}
.btn-hide-cols{background:#64748b;color:white;padding:5px 12px;font-size:.8rem;border-radius:6px}
.voice-settings{margin-top:10px;font-size:.8rem;display:flex;flex-wrap:wrap;gap:15px;align-items:center;background:#f8fafc;padding:10px;border-radius:8px;color:#64748b}
.speed-val{font-weight:bold;color:var(--primary);min-width:35px;display:inline-block}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center}
.column-modal{background:white;width:90%;max-width:420px;padding:20px;border-radius:16px;box-shadow:0 20px 25px -5px rgba(0,0,0,.2);max-height:85vh;display:flex;flex-direction:column}
.column-list{flex:1;overflow-y:auto;margin:10px 0;display:flex;flex-direction:column;gap:6px}
.column-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}
.column-item input[type="checkbox"]{width:18px;height:18px;flex-shrink:0}
.reorder-btns{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.reorder-btns button{padding:2px 6px;font-size:.75rem;background:#e2e8f0;color:#475569;border-radius:4px;min-width:24px;line-height:1}
.modal-footer{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;flex-shrink:0}
.btn-confirm{background:var(--success);color:white}
.btn-cancel{background:#94a3b8;color:white}
.sheet-badge{font-size:.6rem;background:#6366f1;color:white;padding:2px 5px;border-radius:4px;margin-left:4px;font-weight:bold;vertical-align:middle}
.mode-menu-container{position:relative;cursor:pointer}
.mode-dropdown{position:absolute;top:100%;left:0;background:white;box-shadow:0 10px 15px rgba(0,0,0,.2);border-radius:8px;z-index:2000;width:180px;display:none;border:1px solid #e2e8f0}
.mode-dropdown.show{display:block!important}
.mode-item{padding:12px 15px;border-bottom:1px solid #f1f5f9;color:#334155;font-size:.9rem;font-weight:bold}
.mode-item:last-child{border-bottom:none;color:var(--danger)}
.mode-item:active{background:#f8fafc}
.quiz-item{margin-bottom:25px;padding:20px;border:1px solid #e2e8f0;border-radius:12px;scroll-margin-top:80px}
.option-btn{width:100%;text-align:left;padding:12px;margin-top:8px;border:1px solid #cbd5e1;background:#fff;border-radius:8px;font-size:.95rem}
.option-btn.selected{border:2px solid var(--primary);background:#f0f7ff}
.option-btn.correct-ans{background:#dcfce7!important;border-color:#22c55e!important;color:#166534}
.option-btn.wrong-ans{background:#fee2e2!important;border-color:#ef4444!important;color:#991b1b}
#quiz-timer-box{position:sticky;top:10px;z-index:100;background:var(--danger);color:white;padding:10px;border-radius:10px;text-align:center;font-weight:bold;margin-bottom:15px;font-size:1.2rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
#quiz-result-summary{background:#f8fafc;padding:15px;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:20px}
.dot-nav{display:inline-block;width:30px;height:30px;line-height:30px;text-align:center;border-radius:50%;margin:4px;cursor:pointer;color:white;font-weight:bold;font-size:.8rem}
.btn-finish{background:#1e293b;color:white;width:100%;padding:15px;margin-top:20px;font-size:1.1rem}
.scenario-box{border:1px solid #e2e8f0;padding:15px;border-radius:10px;margin-top:15px;background:#f8fafc;position:relative}
.scenario-title{font-weight:bold;color:#334155;margin-bottom:10px;display:block}
.remove-scenario{position:absolute;top:10px;right:10px;color:var(--danger);cursor:pointer;font-size:.8rem}
.select-group{margin-bottom:10px}
.select-group label{display:block;font-size:.75rem;color:#64748b;margin-bottom:4px}
.exclude-list{display:flex;flex-wrap:wrap;gap:8px}
.exclude-item{font-size:.75rem;background:#fff;border:1px solid #cbd5e1;padding:2px 6px;border-radius:4px;display:flex;align-items:center;gap:4px}
.jp-hint-box{background:#f0f7ff;border-left:3px solid var(--primary);padding:8px 12px;border-radius:6px;font-size:1.1rem;font-weight:bold;margin-bottom:8px}
.db-view-container{max-width:95%!important;width:1200px!important}
.excel-table-wrapper{overflow:auto;max-height:500px;border:1px solid #ddd;margin-bottom:15px}
.excel-table{width:100%;border-collapse:collapse;background:white;font-size:.9rem}
.excel-table th{position:sticky;top:0;background:#f1f5f9;z-index:5;border:1px solid #cbd5e1;padding:8px}
.excel-table td{border:1px solid #cbd5e1;padding:5px;min-width:100px;outline:none}
.excel-table td:focus{background:#fffbeb;box-shadow:inset 0 0 0 2px var(--primary)}
.btn-db-action{padding:8px 16px;border-radius:6px;font-size:.85rem}
.btn-add-row{background:var(--primary);color:white;margin-bottom:10px}
.btn-delete-row{background:var(--danger);color:white;padding:2px 8px;border-radius:4px;font-size:.7rem;cursor:pointer}
#audio-unlock{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;text-align:center;padding:20px}
ruby{display:inline-flex;flex-direction:column-reverse;vertical-align:bottom;align-items:center;ruby-align:space-between;text-indent:0;margin:0 1px}
rt{display:block;font-size:.45em;line-height:1;color:var(--primary);text-align:center;width:100%;white-space:nowrap;overflow:visible}
</style>
</head>
<body>

<div id="screentip" class="screentip"></div>
<div id="screentip-btns" class="screentip-btns hidden"></div>

<div id="audio-unlock" class="hidden">
  <h2>üîä S·∫µn s√†ng h·ªçc t·∫≠p</h2>
  <p>Nh·∫•n ƒë·ªÉ k√≠ch ho·∫°t √¢m thanh.</p>
  <button onclick="unlockAudio()" style="background:var(--success);color:white;padding:20px 40px;font-size:1.2rem">B·∫ÆT ƒê·∫¶U NGAY</button>
</div>

<div id="setup-screen" class="container">
  <h2 style="text-align:center">üìÇ C√†i ƒë·∫∑t Database</h2>
  <div style="border:2px dashed #cbd5e1;padding:30px;text-align:center;border-radius:12px">
    <p style="margin-top:0;color:#64748b">N·∫°p file Excel (.xlsx)</p>
    <p style="font-size:.7rem;color:#94a3b8;line-height:1.5">Sheet <b>vocab</b>: C·ªôt 1=STT, c√°c c·ªôt=tr∆∞·ªùng vocab<br>Sheet ph·ª•: c·ªôt <b>STT, idx, jp, vi</b></p>
    <input type="file" id="fileInput" accept=".xlsx"/>
  </div>
  <div class="sync-section">
    <h4 style="margin:0 0 10px 0;color:#16a34a">üîÑ ƒê·ªìng b·ªô gi·ªØa c√°c m√°y</h4>
    <button class="btn-sync" onclick="exportFullBackup()">üíæ Xu·∫•t Backup (.json)</button>
    <button class="btn-sync" style="background:#0891b2;margin-top:8px" onclick="document.getElementById('backupInput').click()">üì• Nh·∫≠p Backup (.json)</button>
    <input type="file" id="backupInput" accept=".json" class="hidden" onchange="importFullBackup(event)"/>
  </div>
</div>

<div id="study-screen" class="container hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;gap:10px;background:#f8fafc;padding:10px;border-radius:12px;border:1px solid #e2e8f0">
    <div style="flex:1">
      <div class="mode-menu-container" onclick="toggleModeMenu(event)">
        <h3 id="mode-title" style="margin:0;color:var(--primary);font-size:.85rem;text-transform:uppercase;display:flex;align-items:center;gap:5px">Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span></h3>
        <div id="mode-dropdown" class="mode-dropdown">
          <div class="mode-item" onclick="selectMode('study',event)">üìö H·ªçc t·∫≠p</div>
          <div class="mode-item" onclick="selectMode('review',event)">üîÑ √în t·∫≠p</div>
          <div class="mode-item" onclick="showQuizScreen(event)">üìù Tr·∫Øc nghi·ªám</div>
        </div>
      </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">
      <span id="word-counter-top" style="font-weight:800;font-size:.9rem;color:#1e293b">0/0</span>
      <div id="status-display-top" onclick="setStatus(null)" style="font-size:1.2rem;height:1.4rem;cursor:pointer"></div>
    </div>
    <div style="flex:1;text-align:right">
      <button class="btn-hide-cols" onclick="openColumnModal()">üëÅÔ∏è C·ªôt</button>
    </div>
  </div>

  <div id="column-modal-root" class="modal-overlay hidden">
    <div class="column-modal">
      <h3 style="margin-top:0">Thi·∫øt l·∫≠p & Th·ª© t·ª± c·ªôt</h3>
      <p style="font-size:.8rem;color:#64748b;margin:0 0 5px">Tick=·∫®N | ‚Üë‚Üì=ƒë·ªïi th·ª© t·ª±</p>
      <div id="column-checkbox-list" class="column-list"></div>
      <div class="modal-footer">
        <button class="btn-confirm" onclick="applyColumnVisibility()">X√°c nh·∫≠n</button>
        <button class="btn-cancel" onclick="closeColumnModal()">H·ªßy</button>
      </div>
    </div>
  </div>

  <div class="field-nav">
    <div class="nav-zone" onclick="changeField(-1)">
      <span id="btn-prev-field" class="nav-arrow-small">‚ùÆ</span>
      <span id="prev-field" class="field-label-side"></span>
    </div>
    <div class="nav-zone-active">
      <span id="curr-field" class="field-active"></span>
    </div>
    <div class="nav-zone" onclick="changeField(1)">
      <span id="next-field" class="field-label-side"></span>
      <span id="btn-next-field" class="nav-arrow-small">‚ùØ</span>
    </div>
  </div>

  <div class="card">
    <div class="card-touch-zone">
      <div id="display-text" class="card-content">---</div>
      <div id="speaker-hint" style="position:absolute;bottom:15px;left:50%;transform:translateX(-50%);font-size:11px;color:#cbd5e1;letter-spacing:1px;pointer-events:none;text-transform:uppercase;font-weight:bold">Ch·∫°m ƒë·ªÉ ƒë·ªçc</div>
    </div>
  </div>

  <div class="voice-settings">
    <span>T·ªëc ƒë·ªô: <input type="range" id="voiceRate" min=".25" max="3" step=".25" value="1" oninput="document.getElementById('speed-display').innerText=this.value+'x'">
      <span id="speed-display" class="speed-val">1x</span>
    </span>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <label><input type="checkbox" id="autoSpeak" checked> T·ª± ƒë·ªông ƒë·ªçc</label>
      <label id="random-multi-wrap"><input type="checkbox" id="randomMulti" checked> Random</label>
      <button onclick="enterEditMode()" style="background:#f59e0b;color:white;border:none;border-radius:8px;padding:6px 12px;font-size:.8rem;font-weight:bold">‚úèÔ∏è Edit</button>
    </div>
    <div style="display:flex;gap:5px;width:100%;margin-top:5px">
      <button id="furiganaToggle" onclick="toggleFurigana()" style="flex:1;background:#e2e8f0;color:#475569;padding:8px;border-radius:8px;font-size:.8rem;font-weight:bold;border:1px solid #cbd5e1">Furigana: OFF</button>
      <button onclick="toggleDataMenu()" id="btn-data-toggle" style="flex:1;background:#334155;color:white;padding:8px;border-radius:8px;font-size:.8rem;font-weight:bold;border:none">Data ‚ñæ</button>
    </div>
  </div>

  <div id="data-controls-wrapper" class="hidden" style="margin-top:10px;background:#f1f5f9;padding:15px;border-radius:12px;border:1px solid #e2e8f0">
    <div class="action-panel" style="margin-top:0;border-top:none;padding:0">
      <button class="btn-sync" onclick="exportFullBackup()" style="background:#6366f1">üíæ Backup (.json)</button>
      <button class="btn-sync" onclick="showAddFromFile()" style="background:#8b5cf6">‚ûï Th√™m t·ª´</button>
    </div>
    <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px;align-items:center">
      <button style="background:#1e293b;color:white;width:100%;padding:12px;border-radius:10px;font-weight:bold" onclick="showDatabaseView()">üìä Xem & Qu·∫£n l√Ω DB</button>
      <button onclick="resetDatabase()" style="background:none;color:#ef4444;font-size:11px;border:none;text-decoration:underline;cursor:pointer">[X√≥a s·∫°ch Database]</button>
    </div>
  </div>

  <div id="review-controls" class="hidden" style="margin-top:10px">
    <button id="btn-autoplay" class="btn-autoplay" onclick="toggleAutoPlay()" style="width:100%">‚ñ∂ T·ª± ƒë·ªông ph√°t</button>
  </div>

  <div id="add-file-panel" class="hidden" style="margin-top:20px;padding:15px;background:#fefce8;border:1px solid #fef08a;border-radius:12px">
    <h4 style="margin:0 0 10px 0">‚ûï Th√™m t·ª´ v·ª±ng t·ª´ File</h4>
    <input type="file" id="addWordsFileInput" accept=".xlsx" style="font-size:.8rem;margin-bottom:10px;width:100%">
    <div style="display:flex;gap:10px">
      <button onclick="confirmAddFromFile()" style="background:var(--success);color:white;padding:8px;flex:1">X√°c nh·∫≠n</button>
      <button onclick="hideAddFromFile()" style="background:#94a3b8;color:white;padding:8px;flex:1">H·ªßy</button>
    </div>
  </div>
</div>

<div id="db-view-screen" class="container db-view-container hidden">
  <h3>üìä Qu·∫£n l√Ω Database Vocab</h3>
  <button class="btn-add-row" onclick="addRowToExcel()">‚ûï Th√™m h√†ng</button>
  <div class="excel-table-wrapper">
    <table class="excel-table"><thead id="excel-thead"></thead><tbody id="excel-tbody"></tbody></table>
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end">
    <button class="btn-db-action btn-confirm" onclick="saveExcelChanges()">L∆∞u</button>
    <button class="btn-db-action btn-cancel" onclick="exitDatabaseView()">Tho√°t</button>
  </div>
</div>

<div id="quiz-screen" class="container hidden">
  <h2 id="quiz-header-title">üìù Tr·∫Øc nghi·ªám</h2>
  <div id="quiz-setup">
    <div style="margin-bottom:15px">
      S·ªë c√¢u: <input type="number" id="quizCount" placeholder="T·∫•t c·∫£" style="width:80px;padding:8px;border:1px solid #cbd5e1;border-radius:8px">
      TGian/c√¢u(s): <input type="number" id="timePerQuestion" value="10" style="width:60px;padding:8px;border:1px solid #cbd5e1;border-radius:8px">
      <button onclick="addScenario()" style="background:var(--primary);color:white;padding:8px 15px;font-size:.8rem;margin-left:10px">+ K·ªãch b·∫£n</button>
    </div>
    <div id="scenarios-list"></div>
    <div style="margin-top:20px;display:flex;gap:10px">
      <button onclick="startQuiz()" style="background:var(--success);color:white;flex:1">B·∫Øt ƒë·∫ßu</button>
      <button onclick="exitQuiz()" style="background:#94a3b8;color:white;flex:1">H·ªßy</button>
    </div>
  </div>
  <div id="quiz-playing" class="hidden">
    <div id="quiz-timer-box">‚è± <span id="time-left">00:00</span></div>
    <div id="quiz-result-summary" class="hidden"></div>
    <div id="quiz-container"></div>
    <button id="quiz-finish-btn" class="btn-finish" onclick="finishQuiz()">N·ªôp b√†i</button>
    <button class="btn-finish" style="background:#64748b;margin-top:10px" onclick="exitQuiz()">Quay l·∫°i</button>
  </div>
</div>

<script>
const SUPABASE_URL='https://isjerizfpgwigrpmqmla.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzamVyaXpmcGd3aWdycG1xbWxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzM0MjUsImV4cCI6MjA4Njg0OTQyNX0._ioIsdMwyh7YqbOH9gtEoUycYW-b5SznnFBYT8du9CI';
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let rawData=[],headers=[],currentWordIndex=0,currentFieldIndex=1;
let reviewPool=[],reviewIndex=0;
let stats=JSON.parse(localStorage.getItem('vocab_stats'))||{};
let currentMode='study';
let scenarios=JSON.parse(localStorage.getItem('quiz_scenarios'))||[];
const synth=window.speechSynthesis;
let isAutoPlaying=false,quizInterval,quizData=[],userAnswers={};
let isDataChanged=false,availableVoices=[];
let isEditing=false,editOriginalText='';
let hotkeys=JSON.parse(localStorage.getItem('vocab_hotkeys'))||{next:'arrowright',prev:'arrowleft',learned:'1',mastered:'2',forgot:'3',speak:'r',fieldNext:'arrowdown',fieldPrev:'arrowup'};
let hiddenColumns=JSON.parse(localStorage.getItem('vocab_hidden_cols'))||{study:[],review:[]};
let fieldOrder=JSON.parse(localStorage.getItem('vocab_field_order'))||null;
let sheetData={};
let allFields=[];
let editingSheetItems=null;
let screentipEditing=false,screentipOriginalVi='',screentipEditInfo=null;
let isFuriganaEnabled=false;
try{isFuriganaEnabled=JSON.parse(localStorage.getItem('vocab_furigana'))||false;}catch(e){}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const cleanStr=s=>String(s==null?'':s).replace(/\\n/g,'\n');
function escapeHtml(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
// Convert text to HTML for display: escape HTML then newlines‚Üí<br>
function textToHtml(s){return escapeHtml(s||'').replace(/\n/g,'<br>');}

function buildAllFields(){
  if(!headers.length){allFields=[];return;}
  const def=[];
  headers.forEach(h=>def.push({type:'vocab',key:h}));
  Object.keys(sheetData).forEach(sn=>def.push({type:'sheet',key:sn}));
  if(fieldOrder&&fieldOrder.length){
    const STT=def[0],rest=def.slice(1),ordered=[];
    fieldOrder.forEach(k=>{const f=rest.find(f=>f.key===k);if(f)ordered.push(f);});
    rest.forEach(f=>{if(!ordered.find(o=>o.key===f.key))ordered.push(f);});
    allFields=[STT,...ordered];
  }else allFields=def;
  if(currentFieldIndex>=allFields.length||currentFieldIndex<1)currentFieldIndex=1;
}

function getFieldContent(word,idx){
  const f=allFields[idx];
  if(!f)return{isSheet:false,content:''};
  if(f.type==='vocab')return{isSheet:false,content:cleanStr(word[f.key]||'')};
  const stt=String(word[headers[0]]);
  return{isSheet:true,items:(sheetData[f.key]||[]).filter(r=>String(r.stt)===stt),sheetName:f.key};
}

function formatFurigana(text){
  if(!text)return'';
  return text.replace(/([‰∏Ä-Èæ†„ÄÖa-zA-Z0-9]+)\(([^)]+)\)/g,(_,k,f)=>`<ruby>${k}<rt>${f}</rt></ruby>`);
}
function renderJpHtmlSafe(jp){
  if(!jp)return'';
  if(isFuriganaEnabled){
    // formatFurigana returns HTML with ruby tags - need to protect them
    return formatFurigana(jp).replace(/\n/g,'<br>');
  }
  return escapeHtml(jp.replace(/\(.*?\)/g,'')).replace(/\n/g,'<br>');
}

// ‚îÄ‚îÄ SCREENTIP ‚îÄ‚îÄ
let screentipTimer=null;

function showScreentip(anchorEl,text){
  if(screentipEditing)return;
  const tip=document.getElementById('screentip');
  screentipEditInfo={
    sheetName:anchorEl.getAttribute('data-sheet'),
    rowIdx:parseInt(anchorEl.getAttribute('data-row-idx'))
  };
  // FIX 1: use innerHTML so \n renders as line break
  tip.innerHTML=textToHtml(text);
  tip.style.display='block';
  positionScreentip(tip,anchorEl);
  clearTimeout(screentipTimer);
  screentipTimer=setTimeout(hideScreentip,6000);
}

function positionScreentip(tip,anchorEl){
  const rect=anchorEl.getBoundingClientRect();
  const VW=window.innerWidth,VH=window.innerHeight;
  const maxW=Math.min(VW*0.85,360);
  tip.style.maxWidth=maxW+'px';

  // FIX 2: calculate available space above and below, pick the bigger side
  const spaceBelow=VH-rect.bottom-10;
  const spaceAbove=rect.top-10;
  const tipH=Math.min(tip.scrollHeight||200, VH*0.55);

  let top,left=Math.max(10,Math.min(rect.left,VW-maxW-10));

  if(spaceBelow>=tipH||spaceBelow>=spaceAbove){
    // place below
    top=rect.bottom+6;
  }else{
    // place above
    top=rect.top-tipH-6;
  }
  // clamp top so it stays in viewport
  top=Math.max(10,Math.min(top,VH-tipH-10));

  tip.style.top=top+'px';
  tip.style.left=left+'px';
  tip.style.maxHeight=Math.min(VH*0.55,VH-top-10)+'px';
}

function hideScreentip(){
  if(screentipEditing)return;
  document.getElementById('screentip').style.display='none';
  clearTimeout(screentipTimer);
}

function enterScreentipEdit(){
  if(screentipEditing||!screentipEditInfo)return;
  screentipEditing=true;
  const tip=document.getElementById('screentip');
  // store original as plain text (innerText converts <br> back to \n)
  screentipOriginalVi=tip.innerText;
  // switch to plain text for editing
  tip.textContent=tip.innerText;
  clearTimeout(screentipTimer);
  tip.setAttribute('contenteditable','true');
  tip.focus();
  const btnDiv=document.getElementById('screentip-btns');
  btnDiv.classList.remove('hidden');
  // position buttons below tip
  const rect=tip.getBoundingClientRect();
  btnDiv.style.top=(rect.bottom+6)+'px';
  btnDiv.style.left=rect.left+'px';
  btnDiv.innerHTML=`
    <button onclick="saveScreentipEdit()" style="padding:8px 14px;background:var(--success);color:white;border-radius:8px;font-weight:bold;font-size:.85rem">üíæ L∆∞u</button>
    <button onclick="cancelScreentipEdit()" style="padding:8px 14px;background:#94a3b8;color:white;border-radius:8px;font-weight:bold;font-size:.85rem">‚ùå H·ªßy</button>`;
}

async function saveScreentipEdit(){
  const tip=document.getElementById('screentip');
  const newVi=tip.innerText.trim();
  if(screentipEditInfo&&newVi!==screentipOriginalVi){
    const{sheetName,rowIdx}=screentipEditInfo;
    if(sheetData[sheetName]?.[rowIdx]){
      sheetData[sheetName][rowIdx].vi=newVi;
      await syncToCloud();
      const jpLine=document.querySelector(`.jp-line[data-sheet="${CSS.escape(sheetName)}"][data-row-idx="${rowIdx}"]`);
      if(jpLine)jpLine.setAttribute('data-vi',escapeHtml(newVi));
    }
  }
  exitScreentipEdit();
}
function cancelScreentipEdit(){exitScreentipEdit();}
function exitScreentipEdit(){
  screentipEditing=false;
  screentipOriginalVi='';
  const tip=document.getElementById('screentip');
  tip.removeAttribute('contenteditable');
  document.getElementById('screentip-btns').classList.add('hidden');
  hideScreentip();
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('screentip').addEventListener('click',function(e){
    e.stopPropagation();
    if(!screentipEditing)enterScreentipEdit();
  });

  document.getElementById('display-text').addEventListener('click',function(e){
    if(isEditing)return;
    // FIX 3: jp-speak-btn click ‚Üí speak single line only
    const speakBtn=e.target.closest('.jp-speak-btn');
    if(speakBtn){
      e.stopPropagation();
      const jpLine=speakBtn.closest('.jp-line');
      const jpText=(speakBtn.getAttribute('data-jp')||'').trim();
      const viRaw=(jpLine?.getAttribute('data-vi')||'').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&lt;/g,'<').replace(/&gt;/g,'>').trim();
      if(jpText){
        const mySession=++_speechSession; // new session for this one-off speak
        _speakSingle(jpText,mySession,()=>{
          if(viRaw&&viRaw!=='N.A')setTimeout(()=>_speakSingle(viRaw,mySession,null),200);
        });
      }
      return;
    }
    const jpLine=e.target.closest('.jp-line');
    if(jpLine){
      // tapping jp-line body ‚Üí show screentip
      const raw=jpLine.getAttribute('data-vi')||'';
      // unescape for display
      const vi=raw.replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
      if(vi)showScreentip(jpLine,vi);
      return;
    }
    // FIX 4: clicking card (not jp-line) when it's a sheet field ‚Üí speak all
    const fc=getFieldContent(
      currentMode==='study'?rawData[currentWordIndex]:reviewPool[reviewIndex],
      currentFieldIndex
    );
    if(!fc.isSheet)speakText();
    // if sheet field, card tap does nothing (use speaker icons or autoplay)
  });
});

window.onclick=function(e){
  if(!e.target.closest('.mode-menu-container'))document.getElementById('mode-dropdown').classList.remove('show');
  if(!e.target.closest('#screentip')&&!e.target.closest('#screentip-btns')&&!e.target.closest('.jp-line')){
    if(!screentipEditing)hideScreentip();
  }
};

// ‚îÄ‚îÄ VOICE ‚îÄ‚îÄ
function loadVoices(){availableVoices=synth.getVoices();}
if(speechSynthesis.onvoiceschanged!==undefined)speechSynthesis.onvoiceschanged=loadVoices;
loadVoices();
function unlockAudio(){synth.speak(new SpeechSynthesisUtterance(''));document.getElementById('audio-unlock').classList.add('hidden');initApp();}

// ‚îÄ‚îÄ CLOUD ‚îÄ‚îÄ
window.onload=async function(){
  loadVoices();
  try{
    const{data:prog}=await supabaseClient.from('user_progress').select('*').eq('id','current_user').single();
    if(prog){stats=prog.stats||{};headers=prog.headers||[];currentWordIndex=prog.current_index||0;if(prog.sheet_data)sheetData=prog.sheet_data;}
    const{data:vocab,error:vErr}=await supabaseClient.from('hoc_tap').select('*').order('row_index',{ascending:true});
    if(vErr){console.error(vErr);return;}
    if(vocab&&vocab.length>0&&headers.length>0){
      rawData=vocab.map(row=>{let obj={row_index:row.row_index};headers.forEach((h,i)=>{obj[h]=cleanStr(row[`col${i+1}`]);});return obj;});
      buildAllFields();initApp();
    }
  }catch(err){console.error(err);}
};

async function syncToCloud(){
  const{error}=await supabaseClient.from('user_progress').upsert({id:'current_user',stats,headers,current_index:currentWordIndex,sheet_data:sheetData},{onConflict:'id'});
  if(error)console.error('Sync:',error.message);
}

// ‚îÄ‚îÄ FILE INPUT ‚îÄ‚îÄ
document.getElementById('fileInput').addEventListener('change',async e=>{
  const reader=new FileReader();
  reader.onload=async event=>{
    const wb=XLSX.read(new Uint8Array(event.target.result),{type:'array'});
    const sheetNames=wb.SheetNames;
    const vocabSN=sheetNames.find(n=>n.toLowerCase()==='vocab')||sheetNames[0];
    const rawRows=XLSX.utils.sheet_to_json(wb.Sheets[vocabSN],{defval:'N.A'});
    if(!rawRows.length){alert('Sheet vocab tr·ªëng!');return;}
    headers=Object.keys(rawRows[0]);
    rawData=rawRows.map(row=>{let o={};headers.forEach(h=>{o[h]=cleanStr(row[h]);});return o;});
    sheetData={};
    sheetNames.forEach(sn=>{
      if(sn===vocabSN)return;
      const rows=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:''});
      if(!rows.length)return;
      const keys=Object.keys(rows[0]);
      const find=c=>keys.find(k=>c.includes(k.toLowerCase().trim()))||keys[0];
      const cm={stt:find(['stt','id','no','s·ªë']),idx:find(['idx','index']),jp:find(['jp','japanese','ja','kanji','t·ª´']),vi:find(['vi','vietnamese','vn','nghƒ©a','nghia','meaning','d·ªãch'])};
      let lastStt='';const items=[];
      rows.forEach(r=>{
        const rawStt=r[cm.stt];
        const stt=(rawStt===null||rawStt===undefined||rawStt==='')?lastStt:String(rawStt);
        if(stt)lastStt=stt;
        const jp=cleanStr(r[cm.jp]),vi=cleanStr(r[cm.vi]);
        if(stt||jp)items.push({stt,idx:r[cm.idx]||'',jp,vi});
      });
      sheetData[sn]=items;
    });
    buildAllFields();
    const toInsert=rawData.map((row,i)=>{let d={row_index:i};headers.forEach((h,idx)=>{d[`col${idx+1}`]=row[h]||'N.A';});return d;});
    try{
      await supabaseClient.from('hoc_tap').delete().neq('row_index',-1);
      const{error}=await supabaseClient.from('hoc_tap').insert(toInsert);
      if(error)throw error;
      await syncToCloud();
      alert(`‚úÖ ƒê·ªìng b·ªô ${rawData.length} t·ª´ + ${Object.keys(sheetData).length} sheet ph·ª•!`);
      document.getElementById('audio-unlock').classList.remove('hidden');
    }catch(err){alert('L·ªói: '+err.message);}
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function initApp(){
  if(rawData&&rawData.length>0){
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('study-screen').classList.remove('hidden');
    updateDisplay();
  }
}

// ‚îÄ‚îÄ MODE MENU ‚îÄ‚îÄ
function toggleModeMenu(e){if(e)e.stopPropagation();const dd=document.getElementById('mode-dropdown'),ar=document.getElementById('menu-arrow');const show=dd.classList.toggle('show');if(ar)ar.style.transform=show?'rotate(180deg)':'rotate(0deg)';}
function selectMode(mode,e){if(e)e.stopPropagation();document.getElementById('mode-dropdown').classList.remove('show');const ar=document.getElementById('menu-arrow');if(ar)ar.style.transform='rotate(0deg)';if(mode==='study'||mode==='review'){if(currentMode!==mode)switchMode(mode);}else showQuizScreen();}

// ‚îÄ‚îÄ COLUMN MODAL ‚îÄ‚îÄ
function openColumnModal(){
  const lc=document.getElementById('column-checkbox-list');lc.innerHTML='';
  const ch=hiddenColumns[currentMode]||[];
  allFields.slice(1).forEach(f=>{
    const label=f.key,isSheet=f.type==='sheet';
    const div=document.createElement('div');div.className='column-item';div.setAttribute('data-key',label);
    div.innerHTML=`<div class="reorder-btns"><button onclick="moveModalItem(this,-1)">‚Üë</button><button onclick="moveModalItem(this,1)">‚Üì</button></div><input type="checkbox" id="chk-${label}" value="${label}" ${ch.includes(label)?'checked':''}><label for="chk-${label}" style="flex:1;cursor:pointer">${label}${isSheet?'<span class="sheet-badge">sheet</span>':''}</label>`;
    div.querySelector('label').addEventListener('click',e=>{e.preventDefault();div.querySelector('input').checked=!div.querySelector('input').checked;});
    lc.appendChild(div);
  });
  document.getElementById('column-modal-root').classList.remove('hidden');
}
function moveModalItem(btn,dir){const item=btn.closest('.column-item'),list=item.parentElement;if(dir===-1&&item.previousElementSibling)list.insertBefore(item,item.previousElementSibling);else if(dir===1&&item.nextElementSibling)list.insertBefore(item.nextElementSibling,item);}
function closeColumnModal(){document.getElementById('column-modal-root').classList.add('hidden');}
function applyColumnVisibility(){
  const items=document.querySelectorAll('#column-checkbox-list .column-item');
  fieldOrder=Array.from(items).map(i=>i.getAttribute('data-key'));
  localStorage.setItem('vocab_field_order',JSON.stringify(fieldOrder));
  hiddenColumns[currentMode]=Array.from(document.querySelectorAll('#column-checkbox-list input:checked')).map(i=>i.value);
  localStorage.setItem('vocab_hidden_cols',JSON.stringify(hiddenColumns));
  buildAllFields();validateCurrentField();closeColumnModal();updateDisplay();
}
function validateCurrentField(){
  const h=hiddenColumns[currentMode]||[];const label=allFields[currentFieldIndex]?.key;
  if(label&&h.includes(label)){
    let found=false;
    for(let i=1;i<allFields.length;i++){if(!h.includes(allFields[i].key)){currentFieldIndex=i;found=true;break;}}
    if(!found)currentFieldIndex=1; // all hidden, reset to 1 (will show hidden but won't crash)
  }
}

// ‚îÄ‚îÄ FURIGANA ‚îÄ‚îÄ
function toggleFurigana(){isFuriganaEnabled=!isFuriganaEnabled;localStorage.setItem('vocab_furigana',JSON.stringify(isFuriganaEnabled));updateFuriganaBtn();updateDisplay();}
function updateFuriganaBtn(){const btn=document.getElementById('furiganaToggle');if(btn){btn.innerText=isFuriganaEnabled?'Furigana: ON':'Furigana: OFF';btn.style.background=isFuriganaEnabled?'var(--primary)':'#e2e8f0';btn.style.color=isFuriganaEnabled?'white':'#475569';}}

function toggleDataMenu(){
  const w=document.getElementById('data-controls-wrapper'),btn=document.getElementById('btn-data-toggle');
  if(w.classList.contains('hidden')){w.classList.remove('hidden');btn.innerText='Data ‚ñ¥';btn.style.background='var(--primary)';setTimeout(()=>w.scrollIntoView({behavior:'smooth',block:'nearest'}),100);}
  else{w.classList.add('hidden');btn.innerText='Data ‚ñæ';btn.style.background='#334155';}
}

// ‚îÄ‚îÄ DISPLAY ‚îÄ‚îÄ
function updateDisplay(shouldSpeak=false){
  if(!rawData.length||!allFields.length)return;
  const word=currentMode==='study'?rawData[currentWordIndex]:reviewPool[reviewIndex];
  if(!word)return;
  const total=currentMode==='study'?rawData.length:reviewPool.length;
  const sttExcel=word[headers[0]];
  document.getElementById('word-counter-top').innerText=`${sttExcel} / ${total}`;

  const hidden=hiddenColumns[currentMode]||[];
  let prevLabel='',nextLabel='';
  for(let i=currentFieldIndex-1;i>=1;i--){if(!hidden.includes(allFields[i].key)){prevLabel=allFields[i].key;break;}}
  for(let i=currentFieldIndex+1;i<allFields.length;i++){if(!hidden.includes(allFields[i].key)){nextLabel=allFields[i].key;break;}}
  document.getElementById('prev-field').innerText=prevLabel;
  document.getElementById('curr-field').innerText=allFields[currentFieldIndex]?.key||'';
  document.getElementById('next-field').innerText=nextLabel;
  document.getElementById('btn-prev-field').style.visibility=prevLabel?'visible':'hidden';
  document.getElementById('btn-next-field').style.visibility=nextLabel?'visible':'hidden';

  const displayEl=document.getElementById('display-text');
  const hintEl=document.getElementById('speaker-hint');
  const fc=getFieldContent(word,currentFieldIndex);

  if(!fc.isSheet){
    const txt=fc.content||'';
    displayEl.innerHTML=isFuriganaEnabled?formatFurigana(txt).replace(/\n/g,'<br>'):escapeHtml(txt.replace(/\(.*?\)/g,'')).replace(/\n/g,'<br>');
    hintEl.innerText='Ch·∫°m ƒë·ªÉ ƒë·ªçc';
  }else{
    const items=fc.items||[];
    const fullRows=sheetData[fc.sheetName]||[];
    if(!items.length){
      displayEl.innerHTML='<span style="color:#94a3b8;font-size:1.1rem;font-weight:normal">‚Äî Kh√¥ng c√≥ d·ªØ li·ªáu ‚Äî</span>';
    }else{
      // FIX 3: each jp-line has jp-text + speak btn + vi icon
      displayEl.innerHTML=items.map(item=>{
        const rowIdx=fullRows.indexOf(item);
        const viEsc=escapeHtml(item.vi||'');
        const jpHtml=renderJpHtmlSafe(item.jp||'');
        const jpRaw=escapeHtml((item.jp||'').replace(/\(.*?\)/g,'').trim());
        return `<span class="jp-line" data-vi="${viEsc}" data-sheet="${escapeHtml(fc.sheetName)}" data-row-idx="${rowIdx}">
          <span class="jp-text">${jpHtml||'&nbsp;'}</span>
          <button class="jp-speak-btn" data-jp="${jpRaw}" title="Ph√°t √¢m d√≤ng n√†y">üîä</button>
          <span class="jp-vi-icon">üí¨</span>
        </span>`;
      }).join('');
    }
    hintEl.innerText=isEditing?'S·ª≠a jp tr·ª±c ti·∫øp':'üîä = ph√°t √¢m ¬∑ üí¨ = xem nghƒ©a';
  }

  const st=stats[sttExcel];
  document.getElementById('status-display-top').innerHTML=st==='learned'?'‚úÖ':st==='mastered'?'‚≠ê':'<span style="opacity:.2">‚Ä¢</span>';

  if(shouldSpeak&&!isAutoPlaying&&document.getElementById('autoSpeak').checked)setTimeout(()=>speakText(),100);
  updateFuriganaBtn();
}

// ‚îÄ‚îÄ NAVIGATION (FIX 4: cancel speech on navigate) ‚îÄ‚îÄ
function stopSpeech(){_speechSession++;synth.cancel();}
function clearFieldTimer(){if(fieldClickTimer!==null){clearTimeout(fieldClickTimer);fieldClickTimer=null;}}

async function moveWord(step){
  clearFieldTimer();stopSpeech();
  currentWordIndex=(currentWordIndex+step+rawData.length)%rawData.length;
  currentFieldIndex=1;updateDisplay(true);
  syncToCloud().catch(e=>console.error(e));
}
function nextReviewWord(){clearFieldTimer();stopSpeech();if(reviewIndex<reviewPool.length-1)reviewIndex++;else{prepareReviewPool();reviewIndex=0;}currentFieldIndex=1;updateDisplay(true);}
function prevReviewWord(){clearFieldTimer();stopSpeech();reviewIndex=(reviewIndex-1+reviewPool.length)%reviewPool.length;currentFieldIndex=1;updateDisplay(true);}
function handleNext(){if(currentMode==='study')moveWord(1);else nextReviewWord();}
function handlePrev(){if(currentMode==='study')moveWord(-1);else prevReviewWord();}

function changeField(dir){
  clearFieldTimer();stopSpeech();
  const h=hiddenColumns[currentMode]||[];let next=currentFieldIndex;
  while(true){next+=dir;if(next<1||next>=allFields.length)return false;if(!h.includes(allFields[next].key)){currentFieldIndex=next;updateDisplay(true);return true;}}
}

async function setStatus(status){
  const word=currentMode==='study'?rawData[currentWordIndex]:reviewPool[reviewIndex];
  if(!word)return;
  const key=word[headers[0]];
  const el=document.getElementById('curr-field');
  if(el){el.style.transition='none';el.style.color=status==='learned'?'#22c55e':status==='mastered'?'#eab308':'#ef4444';el.style.transform='scale(1.1)';setTimeout(()=>{el.style.transition='all .3s ease';el.style.color='';el.style.transform='scale(1)';},200);}
  if(status===null)delete stats[key];else stats[key]=status;
  await syncToCloud();
  if(currentMode==='review'&&(status==='mastered'||status===null)){
    reviewPool.splice(reviewIndex,1);
    if(!reviewPool.length){stopAutoPlay();alert('Ho√†n th√†nh √¥n t·∫≠p!');switchMode('study');return;}
    if(reviewIndex>=reviewPool.length)reviewIndex=0;
    updateDisplay();
  }else{updateDisplay();if(currentMode==='review')nextReviewWord();}
}

let fieldClickTimer=null;
document.getElementById('curr-field').onclick=function(e){
  e.stopPropagation();
  if(fieldClickTimer===null){fieldClickTimer=setTimeout(()=>{fieldClickTimer=null;setStatus('learned');},300);}
  else{clearTimeout(fieldClickTimer);fieldClickTimer=null;setStatus('mastered');}
};

window.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.contentEditable==='true')return;
  const k=e.key.toLowerCase();
  if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(k))e.preventDefault();
  if(k===hotkeys.next)handleNext();
  else if(k===hotkeys.prev)handlePrev();
  else if(k===hotkeys.learned)setStatus('learned');
  else if(k===hotkeys.mastered)setStatus('mastered');
  else if(k===hotkeys.forgot)setStatus(null);
  else if(k===hotkeys.speak)speakText();
  else if(k===hotkeys.fieldNext)changeField(1);
  else if(k===hotkeys.fieldPrev)changeField(-1);
});

// ‚îÄ‚îÄ MODE ‚îÄ‚îÄ
function switchMode(mode){
  stopSpeech();stopAutoPlay();currentMode=mode;
  const t=document.getElementById('mode-title');
  if(mode==='review'){
    prepareReviewPool();
    if(!reviewPool.length){alert('Tr·ªëng!');currentMode='study';return;}
    t.innerHTML='Ch·∫ø ƒë·ªô √¥n t·∫≠p <span id="menu-arrow">‚ñæ</span>';
    document.getElementById('review-controls').classList.remove('hidden');
    document.getElementById('random-multi-wrap').classList.remove('hidden');
    reviewIndex=0;currentFieldIndex=1;updateDisplay(true);
  }else{
    t.innerHTML='Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span>';
    document.getElementById('review-controls').classList.add('hidden');
    document.getElementById('random-multi-wrap').classList.add('hidden');
    currentFieldIndex=1;updateDisplay(true);
  }
  document.getElementById('mode-dropdown').style.display='none';
}

function prepareReviewPool(){
  const learned=rawData.filter(w=>stats[w[headers[0]]]==='learned');
  const mastered=rawData.filter(w=>stats[w[headers[0]]]==='mastered');
  if(document.getElementById('randomMulti').checked){
    const lim=Math.max(1,Math.floor(learned.length*.05));
    reviewPool=[...learned,...[...mastered].sort(()=>Math.random()-.5).slice(0,lim)].sort(()=>Math.random()-.5);
  }else{
    const seen=new Set();const pool=[];
    [...learned,...mastered].sort(()=>Math.random()-.5).forEach(w=>{
      const stt=String(w[headers[0]]);if(seen.has(stt))return;
      const m=stt.match(/^(\d+)([a-z])$/);
      if(m){rawData.filter(x=>String(x[headers[0]]).startsWith(m[1])&&/^\d+[a-z]$/.test(String(x[headers[0]]))).sort((a,b)=>String(a[headers[0]]).localeCompare(String(b[headers[0]]))).forEach(x=>{pool.push(x);seen.add(String(x[headers[0]]));});}
      else{pool.push(w);seen.add(stt);}
    });
    reviewPool=pool;
  }
}

// ‚îÄ‚îÄ SPEECH ‚îÄ‚îÄ
let _speechSession=0; // increment on stopSpeech to invalidate ongoing chains

function speakText(callback){
  const session=++_speechSession;
  _doSpeakText(callback,session);
}

function _doSpeakText(callback,session){
  if(_speechSession!==session){if(callback)callback();return;}
  const word=currentMode==='study'?rawData[currentWordIndex]:reviewPool[reviewIndex];
  if(!word){if(callback)callback();return;}
  const fc=getFieldContent(word,currentFieldIndex);
  if(fc.isSheet){
    const items=(fc.items||[]).filter(it=>(it.jp||'').trim()&&it.jp!=='N.A');
    if(!items.length){if(callback)callback();return;}
    let i=0;
    const nextItem=()=>{
      if(_speechSession!==session){if(callback)callback();return;}
      if(i>=items.length){if(callback)callback();return;}
      const item=items[i++];
      const jpText=cleanStr(item.jp||'').replace(/\(.*?\)/g,'').trim();
      const viText=cleanStr(item.vi||'').trim();
      _speakSingle(jpText,session,()=>{
        if(_speechSession!==session)return;
        if(!viText||viText==='N.A'){setTimeout(nextItem,200);return;}
        setTimeout(()=>_speakSingle(viText,session,()=>setTimeout(nextItem,200)),200);
      });
    };
    nextItem();
    return;
  }
  const displayEl=document.getElementById('display-text');if(!displayEl){if(callback)callback();return;}
  const tmp=displayEl.cloneNode(true);tmp.querySelectorAll('rt').forEach(r=>r.remove());
  let text=tmp.innerText.replace(/\(.*?\)/g,'').trim();
  if(!text||text==='N.A'||text==='---'){if(callback)callback();return;}
  _speakSingle(text,session,callback);
}

function speakSingle(text,callback){
  // Public API for one-off speaks (speaker button): always gets new session
  const session=++_speechSession;
  _speakSingle(text,session,callback);
}

function _speakSingle(text,session,callback){
  if(_speechSession!==session)return; // stale session, abort
  const isVN=/[√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªáƒë√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµ]/i.test(text);
  const isJP=/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(text);
  const lang=isVN?'vi-VN':isJP?'ja-JP':'en-US';
  synth.cancel();
  const utter=new SpeechSynthesisUtterance(text);utter.lang=lang;
  const voices=synth.getVoices();let voice=null;
  if(lang==='vi-VN')
    voice=voices.find(v=>v.lang.startsWith('vi')&&v.name.includes('Linh')&&v.name.includes('Enhanced'))
         ||voices.find(v=>v.lang.startsWith('vi')&&(v.name.includes('Linh')||v.name.includes('An')))
         ||voices.find(v=>v.lang.startsWith('vi'));
  else if(lang==='ja-JP')
    voice=voices.find(v=>v.lang.startsWith('ja')&&v.name.includes('Kyoko')&&v.name.includes('Enhanced'))
         ||voices.find(v=>v.lang.startsWith('ja')&&(v.name.includes('Kyoko')||v.name.includes('Haruka')||v.name.includes('Ichiro')))
         ||voices.find(v=>v.lang.startsWith('ja'));
  else
    voice=voices.find(v=>v.lang.startsWith('en')&&(v.name.includes('Allison')||v.name.includes('Samantha'))&&v.name.includes('Enhanced'))
         ||voices.find(v=>v.lang.startsWith('en')&&(v.name.includes('Samantha')||v.name.includes('Zira')||v.name.includes('David')))
         ||voices.find(v=>v.lang.startsWith('en'));
  if(voice)utter.voice=voice;
  utter.rate=document.getElementById('voiceRate').value||1;
  utter.onend=()=>{if(_speechSession===session&&callback)callback();};
  utter.onerror=()=>{/* cancelled - session invalidated, chain stops */};
  setTimeout(()=>{if(_speechSession===session)synth.speak(utter);},100);
}

// ‚îÄ‚îÄ AUTOPLAY ‚îÄ‚îÄ
function toggleAutoPlay(){if(isAutoPlaying)stopAutoPlay();else startAutoPlay();}
function startAutoPlay(){
  isAutoPlaying=true;
  document.getElementById('btn-autoplay').innerText='‚èπ D·ª´ng ph√°t';
  document.getElementById('btn-autoplay').style.background='var(--danger)';
  currentFieldIndex=1;updateDisplay();playSequence();
}
function stopAutoPlay(){
  isAutoPlaying=false;synth.cancel();
  const btn=document.getElementById('btn-autoplay');
  if(btn){btn.innerText='‚ñ∂ T·ª± ƒë·ªông ph√°t';btn.style.background='#8b5cf6';}
}
function playSequence(){
  if(!isAutoPlaying)return;
  const session=_speechSession; // capture current session
  const uh=new SpeechSynthesisUtterance(allFields[currentFieldIndex]?.key||'');
  uh.lang='vi-VN';uh.rate=document.getElementById('voiceRate').value;
  if(availableVoices.length){const v=availableVoices.find(v=>v.lang.startsWith('vi-VN'));if(v)uh.voice=v;}
  uh.onend=()=>{
    if(!isAutoPlaying||_speechSession!==session)return;
    speakText(()=>{
      if(!isAutoPlaying)return;
      setTimeout(()=>{
        if(!isAutoPlaying)return;
        if(currentFieldIndex<allFields.length-1){currentFieldIndex++;updateDisplay();playSequence();}
        else if(reviewIndex<reviewPool.length-1){reviewIndex++;currentFieldIndex=1;updateDisplay();playSequence();}
        else stopAutoPlay();
      },800);
    });
  };
  uh.onerror=()=>{/* cancelled */};
  synth.speak(uh);
}

// ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ
function enterEditMode(){
  if(isEditing)return;
  stopSpeech();stopAutoPlay(); // FIX 4: stop speech when editing
  const f=allFields[currentFieldIndex];
  if(f&&f.type==='sheet')enterSheetJpEditMode(f.key);
  else enterVocabEditMode();
}

function enterVocabEditMode(){
  isEditing=true;
  const el=document.getElementById('display-text');
  editOriginalText=el.innerText;
  el.setAttribute('contenteditable','true');el.focus();
  el.style.userSelect='text';el.style.webkitUserSelect='text';el.style.cursor='text';
  disableSwipe();
  showEditPopup([{label:'üíæ L∆∞u',color:'var(--success)',fn:'saveVocabEdit()'},{label:'‚ùå H·ªßy',color:'#94a3b8',fn:'cancelVocabEdit()'}]);
}

function enterSheetJpEditMode(sheetName){
  isEditing=true;disableSwipe();
  const jpLines=document.querySelectorAll('.jp-line');
  editingSheetItems=[];
  jpLines.forEach(span=>{
    const rowIdx=parseInt(span.getAttribute('data-row-idx'));
    const jpTextEl=span.querySelector('.jp-text');
    editingSheetItems.push({rowIdx,originalJp:jpTextEl?.innerText.trim()||''});
    // Only make the text span editable, not the whole jp-line (which has buttons/icons)
    if(jpTextEl){
      jpTextEl.setAttribute('contenteditable','true');
      jpTextEl.style.userSelect='text';jpTextEl.style.webkitUserSelect='text';
      jpTextEl.style.outline='none';jpTextEl.style.cursor='text';
    }
    span.setAttribute('data-editing','true'); // mark for CSS
  });
  if(jpLines.length){
    const firstText=jpLines[0].querySelector('.jp-text');
    if(firstText)firstText.focus();
  }
  showEditPopup([{label:'üíæ L∆∞u jp',color:'var(--success)',fn:'saveSheetJpEdit()'},{label:'‚ùå H·ªßy',color:'#94a3b8',fn:'cancelSheetJpEdit()'}]);
}

function showEditPopup(buttons){
  const container=document.getElementById('display-text').parentElement;
  const old=document.getElementById('edit-popup');if(old)old.remove();
  const popup=document.createElement('div');popup.id='edit-popup';
  popup.style.cssText='position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:100%;display:flex;justify-content:space-between;padding:0 10px;box-sizing:border-box;z-index:1001;pointer-events:none';
  popup.innerHTML=buttons.map(b=>`<button onclick="${b.fn}" style="pointer-events:auto;min-width:90px;background:${b.color};color:white;padding:10px;border-radius:8px;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,.2)">${b.label}</button>`).join('');
  container.style.position='relative';container.appendChild(popup);
}

async function saveVocabEdit(){
  const el=document.getElementById('display-text');const newValue=el.innerText.trim();
  const word=currentMode==='study'?rawData[currentWordIndex]:reviewPool[reviewIndex];
  // Find which header field matches the original text
  let fieldName='';
  headers.forEach(h=>{if(cleanStr(word[h])===editOriginalText)fieldName=h;});
  // Fallback: use current field only if it's a vocab field
  if(!fieldName){
    const cf=allFields[currentFieldIndex];
    fieldName=(cf&&cf.type==='vocab')?cf.key:headers[1]||headers[0];
  }
  const fieldIdx=headers.indexOf(fieldName);
  if(fieldIdx<0){alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c c·ªôt ƒë·ªÉ l∆∞u.');exitEditMode();return;}
  const rowIndex=parseInt(word.row_index);
  if(isNaN(rowIndex)){alert('L·ªói row_index');return;}
  try{
    const{data,error}=await supabaseClient.from('hoc_tap').update({[`col${fieldIdx+1}`]:newValue}).eq('row_index',rowIndex).select();
    if(error)throw error;
    if(data&&data.length>0){word[fieldName]=newValue;exitEditMode();updateDisplay(true);}
    else alert('Kh√¥ng t√¨m th·∫•y d√≤ng.');
  }catch(err){alert('L·ªói: '+err.message);}
}
function cancelVocabEdit(){document.getElementById('display-text').innerText=editOriginalText;exitEditMode();}

async function saveSheetJpEdit(){
  if(!editingSheetItems)return;
  const sheetName=allFields[currentFieldIndex]?.key;if(!sheetName){exitEditMode();return;}
  document.querySelectorAll('.jp-line[data-editing]').forEach((span,i)=>{
    const info=editingSheetItems[i];if(!info)return;
    const jpTextEl=span.querySelector('.jp-text');
    const newJp=(jpTextEl?jpTextEl.innerText:span.innerText).trim();
    if(sheetData[sheetName]?.[info.rowIdx]!==undefined)sheetData[sheetName][info.rowIdx].jp=newJp;
  });
  await syncToCloud();exitEditMode();updateDisplay(true);
}
function cancelSheetJpEdit(){exitEditMode();updateDisplay();}

function exitEditMode(){
  isEditing=false;editOriginalText='';editingSheetItems=null;
  const el=document.getElementById('display-text');
  el.removeAttribute('contenteditable');el.style.userSelect='';el.style.webkitUserSelect='';el.style.cursor='';
  // Remove contenteditable from jp-text children, and clear data-editing from jp-lines
  document.querySelectorAll('.jp-line[data-editing]').forEach(span=>{
    span.removeAttribute('data-editing');
    const jpTextEl=span.querySelector('.jp-text');
    if(jpTextEl){jpTextEl.removeAttribute('contenteditable');jpTextEl.style.userSelect='';jpTextEl.style.webkitUserSelect='';jpTextEl.style.outline='';jpTextEl.style.cursor='';}
  });
  enableSwipe();
  const popup=document.getElementById('edit-popup');if(popup)popup.remove();
}

// ‚îÄ‚îÄ DB VIEW ‚îÄ‚îÄ
function showDatabaseView(){isDataChanged=false;document.getElementById('study-screen').classList.add('hidden');document.getElementById('db-view-screen').classList.remove('hidden');renderExcelTable();}
function renderExcelTable(){
  const thead=document.getElementById('excel-thead'),tbody=document.getElementById('excel-tbody');thead.innerHTML='';tbody.innerHTML='';
  let trH=document.createElement('tr');headers.forEach(h=>{let th=document.createElement('th');th.innerText=h;trH.appendChild(th);});let thA=document.createElement('th');thA.innerText='Thao t√°c';trH.appendChild(thA);thead.appendChild(trH);
  rawData.forEach(row=>{
    let tr=document.createElement('tr');headers.forEach(h=>{let td=document.createElement('td');td.contentEditable='true';td.innerText=row[h]||'';td.oninput=()=>{isDataChanged=true;};tr.appendChild(td);});
    let tdA=document.createElement('td');tdA.style.textAlign='center';tdA.innerHTML=`<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;tr.appendChild(tdA);tbody.appendChild(tr);
  });
}
function deleteExcelRow(btn){if(confirm('X√≥a h√†ng?')){btn.closest('tr').remove();isDataChanged=true;}}
function addRowToExcel(){const tbody=document.getElementById('excel-tbody');let tr=document.createElement('tr');headers.forEach(()=>{let td=document.createElement('td');td.contentEditable='true';td.oninput=()=>{isDataChanged=true;};tr.appendChild(td);});let tdA=document.createElement('td');tdA.style.textAlign='center';tdA.innerHTML=`<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;tr.appendChild(tdA);tbody.appendChild(tr);isDataChanged=true;}
function saveExcelChanges(){
  if(isDataChanged&&!confirm('L∆∞u?'))return;
  const rows=document.querySelectorAll('#excel-tbody tr');let nd=[];
  rows.forEach(tr=>{let obj={};const cells=tr.querySelectorAll('td');headers.forEach((h,i)=>{obj[h]=cells[i]?cells[i].innerText.trim():'';});if(Object.values(obj).some(v=>v!==''))nd.push(obj);});
  rawData=nd;isDataChanged=false;alert('ƒê√£ l∆∞u!');initApp();exitDatabaseView();
}
function exitDatabaseView(){if(isDataChanged&&confirm('Ch∆∞a l∆∞u, l∆∞u tr∆∞·ªõc?')){saveExcelChanges();return;}document.getElementById('db-view-screen').classList.add('hidden');document.getElementById('study-screen').classList.remove('hidden');}

// ‚îÄ‚îÄ ADD FROM FILE ‚îÄ‚îÄ
function showAddFromFile(){document.getElementById('add-file-panel').classList.remove('hidden');}
function hideAddFromFile(){document.getElementById('add-file-panel').classList.add('hidden');}
function confirmAddFromFile(){
  const fi=document.getElementById('addWordsFileInput');if(!fi.files.length){alert('Ch·ªçn file!');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const sn=wb.SheetNames.find(n=>n.toLowerCase()==='vocab')||wb.SheetNames[0];
    const inc=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:'N.A'});
    if(inc.length){
      const iH=Object.keys(inc[0]);if(iH.length!==headers.length){alert('S·ªë c·ªôt kh√¥ng kh·ªõp!');return;}
      const std=inc.map(row=>{let o={};iH.forEach((h,i)=>{o[headers[i]]=cleanStr(row[h]);});return o;});
      rawData=[...rawData,...std];alert(`ƒê√£ th√™m ${std.length} t·ª´!`);hideAddFromFile();initApp();
    }
  };reader.readAsArrayBuffer(fi.files[0]);
}

// ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ
async function exportFullBackup(){
  if(!rawData.length){alert('Ch∆∞a c√≥ d·ªØ li·ªáu!');return;}
  const allKeys=Object.keys(rawData[0]);
  const overlay=document.createElement('div');overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box';
  const modal=document.createElement('div');modal.style.cssText='background:white;padding:25px;border-radius:15px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto';
  modal.innerHTML=`<h3 style="margin-top:0">Export JSON</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div><strong style="color:#ef4444">Lo·∫°i b·ªè</strong><div style="margin-top:8px;display:flex;flex-direction:column;gap:5px">${allKeys.map(k=>`<label style="display:flex;align-items:center;gap:8px;font-size:13px"><input type="checkbox" value="${k}" class="ex-key"> ${k}</label>`).join('')}</div></div><div><strong style="color:#6366f1">Reformat Kanji</strong><div style="margin-top:8px;display:flex;flex-direction:column;gap:5px">${allKeys.map(k=>`<label style="display:flex;align-items:center;gap:8px;font-size:13px"><input type="checkbox" value="${k}" class="rf-key"> ${k}</label>`).join('')}</div></div></div><div style="display:flex;gap:10px;margin-top:20px"><button id="btn-ce" style="flex:2;padding:12px;background:#6366f1;color:white;border:none;border-radius:8px;font-weight:bold">T·∫£i v·ªÅ</button><button id="btn-cx" style="flex:1;padding:12px;background:#eee;border:none;border-radius:8px">H·ªßy</button></div>`;
  overlay.appendChild(modal);document.body.appendChild(overlay);
  document.getElementById('btn-cx').onclick=()=>overlay.remove();
  document.getElementById('btn-ce').onclick=()=>{
    const ex=Array.from(document.querySelectorAll('.ex-key:checked')).map(c=>c.value);
    const rf=Array.from(document.querySelectorAll('.rf-key:checked')).map(c=>c.value);
    const data=rawData.map(item=>{let n={...item};ex.forEach(k=>delete n[k]);rf.forEach(k=>{if(n[k]&&typeof n[k]==='string'&&n[k].includes('(')){const d=n[k].replace(/\(.*?\)/g,'');const r=n[k].replace(/[^\u3040-\u309F\u30A0-\u30FF]/g,'');n[k]=`${d}(${r})`;}});return n;});
    const blob=new Blob([JSON.stringify({vocab_data:data,vocab_headers:headers.filter(h=>!ex.includes(h)),vocab_stats:stats,quiz_scenarios:scenarios,sheet_data:sheetData,field_order:fieldOrder,export_date:new Date().toLocaleString()},null,4)],{type:'application/json'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`Vocab_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);overlay.remove();
  };
}

function importFullBackup(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      headers=data.vocab_headers||[];
      rawData=(data.vocab_data||[]).map(r=>{let o={};headers.forEach(h=>{o[h]=cleanStr(r[h]);});return o;});
      stats=data.vocab_stats||{};sheetData=data.sheet_data||{};fieldOrder=data.field_order||null;scenarios=data.quiz_scenarios||[];
      buildAllFields();
      syncToCloud().then(()=>{alert('Nh·∫≠p th√†nh c√¥ng!');initApp();}).catch(err=>alert('Sync l·ªói: '+err.message));
    }catch(err){alert('L·ªói JSON: '+err.message);}
  };reader.readAsText(file);
}

async function resetDatabase(){
  if(!confirm('X√ìA S·∫†CH? Kh√¥ng ho√†n t√°c ƒë∆∞·ª£c!'))return;
  try{await supabaseClient.from('hoc_tap').delete().neq('row_index',-1);await supabaseClient.from('user_progress').upsert({id:'current_user',stats:{},headers:[],current_index:0,sheet_data:{}});localStorage.clear();alert('ƒê√£ x√≥a.');location.reload();}
  catch(err){alert('L·ªói: '+err.message);}
}

// ‚îÄ‚îÄ QUIZ ‚îÄ‚îÄ
function showQuizScreen(event){
  if(event)event.stopPropagation();
  document.getElementById('mode-dropdown').classList.remove('show');
  const ar=document.getElementById('menu-arrow');if(ar)ar.style.transform='rotate(0deg)';
  stopSpeech();stopAutoPlay();
  document.getElementById('study-screen').classList.add('hidden');document.getElementById('quiz-screen').classList.remove('hidden');document.getElementById('quiz-setup').classList.remove('hidden');document.getElementById('quiz-playing').classList.add('hidden');
  document.getElementById('quiz-header-title').innerText=`üìù Tr·∫Øc nghi·ªám (${rawData.filter(w=>stats[w[headers[0]]]).length} t·ª´ ƒë√£ h·ªçc)`;
  if(!scenarios.length){scenarios.push({root:allFields[1]?.key||headers[1],exclude:[]});saveScenarios();}
  renderScenarios();
}
function addScenario(){scenarios.push({root:allFields[1]?.key||headers[1],exclude:[]});saveScenarios();renderScenarios();}
function removeScenario(idx){scenarios.splice(idx,1);if(!scenarios.length)addScenario();else{saveScenarios();renderScenarios();}}
function saveScenarios(){localStorage.setItem('quiz_scenarios',JSON.stringify(scenarios));}
function renderScenarios(){
  const list=document.getElementById('scenarios-list');list.innerHTML='';
  const pool=rawData.filter(w=>stats[w[headers[0]]]==='learned'||stats[w[headers[0]]]==='mastered');
  const qf=allFields.slice(1);
  scenarios.forEach((sc,idx)=>{
    if(!qf.find(f=>f.key===sc.root))sc.root=qf[0]?.key||'';
    const box=document.createElement('div');box.className='scenario-box';
    let est=0;qf.filter(f=>f.key!==sc.root&&!sc.exclude.includes(f.key)).forEach(f=>{if(f.type==='vocab')est+=pool.length;else pool.forEach(w=>{est+=(sheetData[f.key]||[]).filter(r=>String(r.stt)===String(w[headers[0]])&&r.jp&&r.vi).length;});});
    box.innerHTML=`<span class="remove-scenario" onclick="removeScenario(${idx})">‚úñ X√≥a</span><span class="scenario-title">K·ªãch b·∫£n ${idx+1}</span><div style="font-size:.8rem;color:var(--primary);margin-bottom:8px">∆Ø·ªõc t√≠nh: <strong>${est}</strong> c√¢u</div>
      <div class="select-group"><label>C·ªôt g·ªëc (ƒë·ªÅ):</label><select onchange="updateRoot(${idx},this.value)" style="width:100%;padding:5px;border-radius:5px">${qf.map(f=>`<option value="${f.key}" ${f.key===sc.root?'selected':''}>${f.key}${f.type==='sheet'?' üìã':''}</option>`).join('')}</select></div>
      <div class="select-group"><label>C·ªôt lo·∫°i tr·ª´:</label><div class="exclude-list">${qf.filter(f=>f.key!==sc.root).map(f=>`<label class="exclude-item"><input type="checkbox" ${sc.exclude.includes(f.key)?'checked':''} onchange="toggleExclude(${idx},'${f.key}')">${f.key}${f.type==='sheet'?' üìã':''}</label>`).join('')}</div></div>`;
    list.appendChild(box);
  });
}
function updateRoot(idx,val){scenarios[idx].root=val;saveScenarios();renderScenarios();}
function toggleExclude(idx,val){const i=scenarios[idx].exclude.indexOf(val);if(i>-1)scenarios[idx].exclude.splice(i,1);else scenarios[idx].exclude.push(val);saveScenarios();renderScenarios();}

function startQuiz(){
  const Q=parseInt(document.getElementById('quizCount').value)||null;
  const timeVal=parseInt(document.getElementById('timePerQuestion').value)||10;
  const pool=rawData.filter(w=>stats[w[headers[0]]]);
  if(!pool.length){alert('H·ªçc th√™m t·ª´ ƒëi!');return;}
  quizData=[];userAnswers={};
  const qf=allFields.slice(1);
  scenarios.forEach(sc=>{
    const targets=qf.filter(f=>f.key!==sc.root&&!sc.exclude.includes(f.key));
    pool.forEach(word=>{
      targets.forEach(tf=>{
        if(tf.type==='vocab'){
          const cV=cleanStr(word[tf.key]||'');if(cV&&cV!=='N.A')quizData.push({rH:sc.root,tH:tf.key,rV:cleanStr(word[sc.root]||''),cV,isSheetQ:false});
        }else{
          const stt=String(word[headers[0]]);
          (sheetData[tf.key]||[]).filter(r=>String(r.stt)===stt&&r.jp&&r.vi).forEach(item=>{quizData.push({rH:sc.root,tH:tf.key,rV:cleanStr(word[sc.root]||''),cV:cleanStr(item.vi),jpHint:cleanStr(item.jp),isSheetQ:true});});
        }
      });
    });
  });
  quizData.sort(()=>Math.random()-.5);if(Q&&Q<quizData.length)quizData=quizData.slice(0,Q);
  document.getElementById('quiz-setup').classList.add('hidden');document.getElementById('quiz-playing').classList.remove('hidden');document.getElementById('quiz-result-summary').classList.add('hidden');document.getElementById('quiz-finish-btn').classList.remove('hidden');
  const container=document.getElementById('quiz-container');container.innerHTML='';
  quizData.forEach((q,idx)=>{
    const item=document.createElement('div');item.className='quiz-item';item.id=`quiz-q-${idx}`;
    let allVals,choices;
    if(q.isSheetQ){
      allVals=[...new Set((sheetData[q.tH]||[]).map(r=>cleanStr(r.vi)))].filter(Boolean);
      choices=[q.cV,...allVals.filter(v=>v!==q.cV).sort(()=>Math.random()-.5).slice(0,3)].sort(()=>Math.random()-.5);
      item.innerHTML=`<div class="jp-hint-box">${escapeHtml(q.jpHint)}</div><h4 style="cursor:pointer;color:var(--primary);font-size:.95rem" onclick="document.getElementById('quiz-result-summary').scrollIntoView({behavior:'smooth'})">C√¢u ${idx+1}: Nghƒ©a c·ªßa c√¢u tr√™n (${escapeHtml(q.tH)} ¬∑ ${escapeHtml(q.rV)})?</h4>`;
    }else{
      allVals=[...new Set(rawData.map(w=>cleanStr(w[q.tH]||'')))].filter(Boolean);
      choices=[q.cV,...allVals.filter(v=>v!==q.cV).sort(()=>Math.random()-.5).slice(0,3)].sort(()=>Math.random()-.5);
      item.innerHTML=`<h4 style="cursor:pointer;color:var(--primary)" onclick="document.getElementById('quiz-result-summary').scrollIntoView({behavior:'smooth'})">C√¢u ${idx+1}: "${escapeHtml(q.tH)}" c·ªßa <u>${escapeHtml(q.rV)}</u>?</h4>`;
    }
    choices.forEach(c=>{const b=document.createElement('button');b.className='option-btn';b.innerText=c;b.onclick=()=>{if(document.getElementById('quiz-finish-btn').classList.contains('hidden'))return;Array.from(item.querySelectorAll('.option-btn')).forEach(x=>x.classList.remove('selected'));b.classList.add('selected');userAnswers[idx]=c;};item.appendChild(b);});
    container.appendChild(item);
  });
  let timeLeft=quizData.length*timeVal;clearInterval(quizInterval);
  quizInterval=setInterval(()=>{timeLeft--;const m=Math.floor(timeLeft/60),s=timeLeft%60;document.getElementById('time-left').innerText=`${m}:${s<10?'0':''}${s}`;if(timeLeft<=0){clearInterval(quizInterval);finishQuiz();}},1000);
}

function restartQuiz(){clearInterval(quizInterval);document.getElementById('quiz-result-summary').classList.add('hidden');document.getElementById('quiz-finish-btn').classList.remove('hidden');startQuiz();window.scrollTo({top:0,behavior:'smooth'});}
function finishQuiz(){
  clearInterval(quizInterval);document.getElementById('quiz-finish-btn').classList.add('hidden');
  const summary=document.getElementById('quiz-result-summary');summary.classList.remove('hidden');let score=0;
  quizData.forEach((q,idx)=>{const item=document.getElementById(`quiz-q-${idx}`);item.querySelectorAll('.option-btn').forEach(b=>{b.style.pointerEvents='none';if(b.innerText===q.cV)b.classList.add('correct-ans');if(userAnswers[idx]===b.innerText&&b.innerText!==q.cV)b.classList.add('wrong-ans');});if(userAnswers[idx]===q.cV)score++;});
  summary.innerHTML=`<h3 style="margin-top:0">K·∫øt qu·∫£: ${score}/${quizData.length}</h3><div style="display:flex;gap:10px;margin-bottom:15px"><button onclick="restartQuiz()" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:8px;font-weight:bold">üîÑ L√†m l·∫°i</button><button onclick="exitQuiz(true)" style="flex:1;padding:12px;background:#64748b;color:white;border:none;border-radius:8px;font-weight:bold">üè† Tho√°t</button></div>`;
  quizData.forEach((_,i)=>{const d=document.createElement('span');d.className='dot-nav';d.style.background=userAnswers[i]===quizData[i].cV?'var(--success)':'var(--danger)';d.innerText=i+1;d.onclick=()=>document.getElementById(`quiz-q-${i}`).scrollIntoView({behavior:'smooth'});summary.appendChild(d);});
  window.scrollTo({top:0,behavior:'smooth'});
}
function exitQuiz(forceQuit=false){
  clearInterval(quizInterval);
  const setup=document.getElementById('quiz-setup'),playing=document.getElementById('quiz-playing'),result=document.getElementById('quiz-result-summary');
  if(forceQuit){document.getElementById('quiz-screen').classList.add('hidden');document.getElementById('study-screen').classList.remove('hidden');playing.classList.add('hidden');result.classList.add('hidden');setup.classList.remove('hidden');return;}
  if(!result.classList.contains('hidden')||!playing.classList.contains('hidden')){playing.classList.add('hidden');result.classList.add('hidden');setup.classList.remove('hidden');const fb=document.getElementById('quiz-finish-btn');if(fb)fb.classList.remove('hidden');window.scrollTo({top:0,behavior:'smooth'});}
  else{document.getElementById('quiz-screen').classList.add('hidden');document.getElementById('study-screen').classList.remove('hidden');}
}

// ‚îÄ‚îÄ SWIPE ‚îÄ‚îÄ
function disableSwipe(){if(cardElement)cardElement.style.touchAction='none';}
function enableSwipe(){if(cardElement)cardElement.style.touchAction='';}
let touchstartX=0,touchstartY=0;
const cardElement=document.querySelector('.card');
const scrollArea=document.querySelector('.card-content');
if(cardElement){
  cardElement.addEventListener('touchstart',e=>{touchstartX=e.changedTouches[0].screenX;touchstartY=e.changedTouches[0].screenY;},{passive:true});
  cardElement.addEventListener('touchmove',e=>{
    if(isEditing)return;
    const dX=Math.abs(e.changedTouches[0].screenX-touchstartX),dY=Math.abs(e.changedTouches[0].screenY-touchstartY);
    if(dX>dY&&dX>10){if(e.cancelable)e.preventDefault();}
    else if(dY>dX){const sc=scrollArea.scrollHeight>scrollArea.clientHeight;if(sc)e.stopPropagation();else if(e.cancelable)e.preventDefault();}
  },{passive:false});
  cardElement.addEventListener('touchend',e=>{
    const dX=e.changedTouches[0].screenX-touchstartX,dY=e.changedTouches[0].screenY-touchstartY;
    if(Math.abs(dX)>40&&Math.abs(dX)>Math.abs(dY)){if(dX<0)handleNext();else handlePrev();}
  },{passive:true});
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="VocabMaster">
	<link rel="apple-touch-icon" href="https://via.placeholder.com/180">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Master Pro - Multi-Sheet</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #ef4444; --bg: #f1f5f9; }
html, body { margin: 0; padding: 0; width: 100%; min-height: 100%; background: var(--bg); }
body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.container { width: 95%; max-width: 700px; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin: 20px 0; position: relative; }
.hidden { display: none !important; }
.status-badge { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; display: flex; gap: 5px; z-index: 10; }
.field-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; min-height: 60px; background: #f8fafc; border-radius: 10px; padding: 0 5px; overflow: hidden; }
.nav-zone { flex: 1; display: flex; align-items: center; justify-content: center; height: 100%; cursor: pointer; gap: 8px; transition: background 0.2s; -webkit-tap-highlight-color: transparent; }
.nav-zone:active { background: #f1f5f9; }
.field-label-side { font-size: 0.75rem; color: #94a3b8; padding: 5px; opacity: 0.6; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.nav-arrow-small { font-size: 1.1rem; font-weight: bold; color: var(--primary); flex-shrink: 0; }
.nav-zone-active { flex: 1.2; text-align: center; }
.field-active { color: var(--primary); font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); display: inline-block; padding-bottom: 2px; }
.card { height: 450px; border: 2px solid #e2e8f0; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; background: #fff; position: relative; margin-bottom: 20px; touch-action: pan-y; }
.card-touch-zone { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.1s; }
.card-touch-zone:active { background-color: #f8fafc; }
.card-content { font-size: 2.2rem; text-align: left; padding: 20px; font-weight: bold; color: #1e293b; word-break: break-word; flex: 1; width: 100%; display: block; white-space: pre-wrap; overflow-y: auto !important; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; box-sizing: border-box; }
.card-content::-webkit-scrollbar { width: 5px; }
.card-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

/* JP LINE & SCREENTIP */
.jp-line { display: block; padding: 10px 14px; margin: 6px 0; background: #f0f7ff; border-left: 4px solid var(--primary); border-radius: 10px; cursor: pointer; font-size: 1.9rem; font-weight: bold; color: #1e293b; transition: background 0.15s; position: relative; user-select: none; -webkit-user-select: none; }
.jp-line::after { content: 'üí¨'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; opacity: 0.35; }
.jp-line:active { background: #dbeafe; }
.screentip { position: fixed; z-index: 9999; background: #1e293b; color: white; padding: 12px 16px; border-radius: 12px; font-size: 1.05rem; font-weight: normal; line-height: 1.6; max-width: 85vw; box-shadow: 0 10px 25px rgba(0,0,0,0.35); pointer-events: none; white-space: pre-wrap; word-break: break-word; display: none; }

.btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
button { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
button:active { transform: scale(0.98); }
.btn-learned { background: var(--success); color: white; }
.btn-mastered { background: var(--warning); color: white; }
.btn-forgot { background: #64748b; color: white; }
.btn-next-prev { background: var(--primary); color: white; grid-column: span 3; display: flex; justify-content: space-between; align-items: center; padding: 0; overflow: hidden; border-radius: 10px; }
.btn-next-prev button { background: none !important; color: white !important; border: none; height: 100%; padding: 14px 25px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
#word-counter, #review-counter { color: white; font-weight: bold; min-width: 60px; text-align: center; }
.menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
.btn-menu { background: #334155; color: white; padding: 12px; }
.voice-settings { margin-top: 10px; font-size: 0.8rem; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; color: #64748b; }
.quiz-item { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; scroll-margin-top: 80px; }
.option-btn { width: 100%; text-align: left; padding: 12px; margin-top: 8px; border: 1px solid #cbd5e1; background: #fff; border-radius: 8px; }
.option-btn.selected { border: 2px solid var(--primary); background: #f0f7ff; }
.option-btn.correct-ans { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534; }
.option-btn.wrong-ans { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
#quiz-timer-box { position: sticky; top: 10px; z-index: 100; background: var(--danger); color: white; padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
#quiz-result-summary { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
.dot-nav { display: inline-block; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 50%; margin: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 0.8rem; }
.btn-finish { background: #1e293b; color: white; width: 100%; padding: 15px; margin-top: 20px; font-size: 1.1rem; }
.speed-val { font-weight: bold; color: var(--primary); min-width: 35px; display: inline-block; }
.action-panel { margin-top: 20px; padding: 15px; border-top: 2px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.btn-sync { background: #16a34a; color: white; font-size: 0.8rem; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; }
.sync-section { margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; }
.scenario-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-top: 15px; background: #f8fafc; position: relative; }
.scenario-title { font-weight: bold; color: #334155; margin-bottom: 10px; display: block; }
.remove-scenario { position: absolute; top: 10px; right: 10px; color: var(--danger); cursor: pointer; font-size: 0.8rem; }
.select-group { margin-bottom: 10px; }
.select-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
.exclude-list { display: flex; flex-wrap: wrap; gap: 8px; }
.exclude-item { font-size: 0.75rem; background: #fff; border: 1px solid #cbd5e1; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
.btn-autoplay { background: #8b5cf6; color: white; grid-column: span 3; margin-top: 5px; }
.status-star { color: var(--warning); }
.status-check { color: var(--success); }
.review-mastered { background: var(--warning); color: white; }
.db-view-container { max-width: 95% !important; width: 1200px !important; }
.excel-table-wrapper { overflow: auto; max-height: 500px; border: 1px solid #ddd; margin-bottom: 15px; }
.excel-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
.excel-table th { position: sticky; top: 0; background: #f1f5f9; z-index: 5; border: 1px solid #cbd5e1; padding: 8px; }
.excel-table td { border: 1px solid #cbd5e1; padding: 5px; min-width: 100px; outline: none; }
.excel-table td:focus { background: #fffbeb; box-shadow: inset 0 0 0 2px var(--primary); }
.btn-db-action { padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; }
.btn-confirm { background: var(--success); color: white; }
.btn-cancel { background: #94a3b8; color: white; }
.btn-add-row { background: var(--primary); color: white; margin-bottom: 10px; }
.btn-delete-row { background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
#audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
ruby { display: inline-flex; flex-direction: column-reverse; vertical-align: bottom; align-items: center; ruby-align: space-between; text-indent: 0; margin: 0 1px; }
rt { display: block; font-size: 0.45em; line-height: 1; color: var(--primary); text-align: center; width: 100%; white-space: nowrap; overflow: visible; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
.column-modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
.column-list { max-height: 300px; overflow-y: auto; margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
.column-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f8fafc; border-radius: 8px; cursor: pointer; }
.column-item input { width: 20px; height: 20px; }
.modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.btn-hide-cols { background: #64748b; color: white; padding: 5px 12px; font-size: 0.8rem; border-radius: 6px; }
.mode-menu-container { position: relative; cursor: pointer; }
.mode-dropdown { position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 10px 15px rgba(0,0,0,0.2); border-radius: 8px; z-index: 2000; width: 180px; display: none; border: 1px solid #e2e8f0; }
.mode-dropdown.show { display: block !important; }
.mode-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.9rem; font-weight: bold; }
.mode-item:last-child { border-bottom: none; color: var(--danger); }
.mode-item:active { background: #f8fafc; }
.sheet-badge { font-size: 0.6rem; background: #6366f1; color: white; padding: 2px 5px; border-radius: 4px; margin-left: 5px; font-weight: bold; vertical-align: middle; }
</style>
</head>
<body>

<div id="screentip" class="screentip"></div>

<div id="audio-unlock" class="hidden">
    <h2>üîä S·∫µn s√†ng h·ªçc t·∫≠p</h2>
    <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ k√≠ch ho·∫°t √¢m thanh tr√™n thi·∫øt b·ªã n√†y.</p>
    <button onclick="unlockAudio()" style="background: var(--success); color: white; padding: 20px 40px; font-size: 1.2rem;">B·∫ÆT ƒê·∫¶U NGAY</button>
</div>

<div id="setup-screen" class="container">
    <h2 style="text-align: center;">üìÇ C√†i ƒë·∫∑t Database</h2>
    <div style="border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 12px;">
        <p style="margin-top:0; color:#64748b;">N·∫°p file Excel (.xlsx)</p>
        <p style="font-size: 0.7rem; color: #94a3b8; line-height: 1.5;">Sheet <b>vocab</b>: C·ªôt 1 = STT, c√°c c·ªôt = tr∆∞·ªùng vocab<br>C√°c sheet kh√°c: c√≥ c·ªôt <b>STT, idx, jp, vi</b></p>
        <input type="file" id="fileInput" accept=".xlsx" />
    </div>
    <div class="sync-section">
        <h4 style="margin:0 0 10px 0; color:#16a34a;">üîÑ ƒê·ªìng b·ªô gi·ªØa c√°c m√°y</h4>
        <button class="btn-sync" onclick="exportFullBackup()">üíæ Xu·∫•t to√†n b·ªô d·ªØ li·ªáu (Backup)</button>
        <button class="btn-sync" style="background:#0891b2; margin-top:8px;" onclick="document.getElementById('backupInput').click()">üì• Nh·∫≠p t·ª´ file Backup (.json)</button>
        <input type="file" id="backupInput" accept=".json" class="hidden" onchange="importFullBackup(event)" />
    </div>
</div>

<div id="study-screen" class="container hidden">
    <div id="status-display" class="status-badge"></div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;">
        <div style="flex: 1;">
            <div class="mode-menu-container" onclick="toggleModeMenu(event)">
                <h3 id="mode-title" style="margin: 0; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; display: flex; align-items: center; gap: 5px;">
                    Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span>
                </h3>
                <div id="mode-dropdown" class="mode-dropdown">
                    <div class="mode-item" onclick="selectMode('study', event)">üìö Ch·∫ø ƒë·ªô H·ªçc t·∫≠p</div>
                    <div class="mode-item" onclick="selectMode('review', event)">üîÑ Ch·∫ø ƒë·ªô √în t·∫≠p</div>
                    <div class="mode-item" onclick="showQuizScreen(event)">üìù Tr·∫Øc nghi·ªám</div>
                </div>
            </div>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;">
            <span id="word-counter-top" style="font-weight: 800; font-size: 0.9rem; color: #1e293b;">0 / 0</span>
            <div id="status-display-top" onclick="setStatus(null)" style="font-size: 1.2rem; height: 1.4rem;"></div>
        </div>
        <div style="flex: 1; text-align: right;">
            <button class="btn-hide-cols" onclick="openColumnModal()" style="padding: 6px 10px; font-size: 0.75rem; background: #64748b; color: white; border-radius: 6px; border: none;">üëÅÔ∏è ·∫®n c·ªôt</button>
        </div>
    </div>
    
    <div id="column-modal-root" class="modal-overlay hidden">
        <div class="column-modal">
            <h3 style="margin-top: 0;">Thi·∫øt l·∫≠p hi·ªÉn th·ªã</h3>
            <p style="font-size: 0.8rem; color: #64748b;">Tick ƒë·ªÉ <b>·∫®N</b> c·ªôt khi h·ªçc/√¥n t·∫≠p.</p>
            <div id="column-checkbox-list" class="column-list"></div>
            <div class="modal-footer">
                <button class="btn-confirm" onclick="applyColumnVisibility()">X√°c nh·∫≠n</button>
                <button class="btn-cancel" onclick="closeColumnModal()">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>

    <div class="field-nav">
        <div id="nav-left" class="nav-zone" onclick="changeField(-1)">
            <span id="btn-prev-field" class="nav-arrow-small">‚ùÆ</span>
            <span id="prev-field" class="field-label-side"></span>
        </div>
        <div id="nav-center" class="nav-zone-active">
            <span id="curr-field" class="field-active"></span>
        </div>
        <div id="nav-right" class="nav-zone" onclick="changeField(1)">
            <span id="next-field" class="field-label-side"></span>
            <span id="btn-next-field" class="nav-arrow-small">‚ùØ</span>
        </div>
    </div>

    <div class="card">
        <div class="card-touch-zone">
            <div id="display-text" class="card-content">---</div>
            <div id="speaker-hint" style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #cbd5e1; letter-spacing: 1px; pointer-events: none; text-transform: uppercase; font-weight: bold;">Ch·∫°m ƒë·ªÉ ƒë·ªçc</div>
        </div>
    </div>

    <div class="voice-settings">
        <span>T·ªëc ƒë·ªô: <input type="range" id="voiceRate" min="0.25" max="3" step="0.25" value="1" oninput="document.getElementById('speed-display').innerText = this.value + 'x'">
            <span id="speed-display" class="speed-val">1x</span>
        </span>
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
            <label><input type="checkbox" id="autoSpeak" checked> T·ª± ƒë·ªông ƒë·ªçc</label>
            <label id="random-multi-wrap"><input type="checkbox" id="randomMulti" checked> Random</label>
            <button id="btn-edit" onclick="enterEditMode()" style="background:#f59e0b; color:white; border:none; border-radius:8px; padding:6px 12px; font-size:0.8rem; font-weight:bold;">‚úèÔ∏è Edit</button>
        </div>
        <div style="display: flex; gap: 5px; width: 100%; margin-top: 5px;">
            <button id="furiganaToggle" onclick="toggleFurigana()" style="flex: 1; background: #e2e8f0; color: #475569; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; border: 1px solid #cbd5e1;">Furigana: OFF</button>
            <button id="btn-data-toggle" onclick="toggleDataMenu()" style="flex: 1; background: #334155; color: white; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; border: none;">Data ‚ñæ</button>
        </div>
    </div>

    <div id="data-controls-wrapper" class="hidden" style="margin-top: 10px; background: #f1f5f9; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
        <div class="action-panel" style="margin-top: 0; border-top: none; padding: 0;">
            <button class="btn-sync" onclick="exportFullBackup()" style="background:#6366f1">üíæ Backup nhanh (.json)</button>
            <button class="btn-sync" onclick="showAddFromFile()" style="background:#8b5cf6">‚ûï Th√™m t·ª´ v√†o DB</button>
        </div>
        <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
            <button class="btn-db-action" style="background: #1e293b; color: white; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold;" onclick="showDatabaseView()">üìä Xem & Qu·∫£n l√Ω Database (DB)</button>
            <button onclick="resetDatabase()" style="background:none; color:#ef4444; font-size:11px; border:none; text-decoration: underline; cursor: pointer;">[X√≥a s·∫°ch Database h·ªá th·ªëng]</button>
        </div>
    </div>

    <div id="study-controls" class="hidden" style="margin-top: 10px;"></div>
    <div id="review-controls" class="hidden" style="margin-top: 10px;">
        <button id="btn-autoplay" class="btn-autoplay" onclick="toggleAutoPlay()" style="width: 100%;">‚ñ∂ T·ª± ƒë·ªông ph√°t</button>
    </div>

    <div id="add-file-panel" class="hidden" style="margin-top: 20px; padding: 15px; background: #fefce8; border: 1px solid #fef08a; border-radius: 12px;">
        <h4 style="margin: 0 0 10px 0;">‚ûï Th√™m t·ª´ v·ª±ng t·ª´ File</h4>
        <input type="file" id="addWordsFileInput" accept=".xlsx" style="font-size: 0.8rem; margin-bottom: 10px; width: 100%;">
        <div style="display: flex; gap: 10px;">
            <button onclick="confirmAddFromFile()" style="background: var(--success); color: white; padding: 8px; flex: 1;">X√°c nh·∫≠n Th√™m</button>
            <button onclick="hideAddFromFile()" style="background: #94a3b8; color: white; padding: 8px; flex: 1;">H·ªßy b·ªè</button>
        </div>
    </div>
</div>

<div id="db-view-screen" class="container db-view-container hidden">
    <h3>üìä Qu·∫£n l√Ω Database Vocab</h3>
    <button class="btn-add-row" onclick="addRowToExcel()">‚ûï Th√™m h√†ng m·ªõi</button>
    <div class="excel-table-wrapper">
        <table class="excel-table" id="excel-table">
            <thead id="excel-thead"></thead>
            <tbody id="excel-tbody"></tbody>
        </table>
    </div>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn-db-action btn-confirm" onclick="saveExcelChanges()">X√°c nh·∫≠n (L∆∞u)</button>
        <button class="btn-db-action btn-cancel" onclick="exitDatabaseView()">Tho√°t</button>
    </div>
</div>

<div id="quiz-screen" class="container hidden">
    <h2 id="quiz-header-title">üìù Tr·∫Øc nghi·ªám</h2>
    <div id="quiz-setup">
        <div style="margin-bottom: 15px;">
            S·ªë c√¢u: <input type="number" id="quizCount" placeholder="T·∫•t c·∫£" style="width: 80px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px;">
            TGian/c√¢u (s): <input type="number" id="timePerQuestion" value="10" style="width: 60px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px;">
            <button onclick="addScenario()" style="background: var(--primary); color: white; padding: 8px 15px; font-size: 0.8rem; margin-left: 10px;">+ Th√™m k·ªãch b·∫£n</button>
        </div>
        <div id="scenarios-list"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="startQuiz()" style="background: var(--success); color: white; flex: 1;">B·∫Øt ƒë·∫ßu</button>
            <button onclick="exitQuiz()" style="background: #94a3b8; color: white; flex: 1;">H·ªßy</button>
        </div>
    </div>
    <div id="quiz-playing" class="hidden">
        <div id="quiz-timer-box">‚è± Th·ªùi gian c√≤n l·∫°i: <span id="time-left">00:00</span></div>
        <div id="quiz-result-summary" class="hidden"></div>
        <div id="quiz-container"></div>
        <button id="quiz-finish-btn" class="btn-finish" onclick="finishQuiz()">Xong (N·ªôp b√†i)</button>
        <button id="quiz-back-btn" class="btn-finish" style="background: #64748b; margin-top: 10px;" onclick="exitQuiz()">Quay l·∫°i</button>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://isjerizfpgwigrpmqmla.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzamVyaXpmcGd3aWdycG1xbWxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNzM0MjUsImV4cCI6MjA4Njg0OTQyNX0._ioIsdMwyh7YqbOH9gtEoUycYW-b5SznnFBYT8du9CI';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let rawData = [], headers = [], currentWordIndex = 0, currentFieldIndex = 1;
let reviewPool = [], reviewIndex = 0;
let stats = JSON.parse(localStorage.getItem('vocab_stats')) || {};
let currentMode = 'study';
let scenarios = JSON.parse(localStorage.getItem('quiz_scenarios')) || [];
const synth = window.speechSynthesis;
let isAutoPlaying = false;
let quizInterval;
let quizData = [];
let userAnswers = {};
let isDataChanged = false;
let availableVoices = [];
let isEditing = false;
let editOriginalText = "";
let hotkeys = JSON.parse(localStorage.getItem('vocab_hotkeys')) || { 'next': 'arrowright', 'prev': 'arrowleft', 'learned': '1', 'mastered': '2', 'forgot': '3', 'speak': 'r', 'fieldNext': 'arrowdown', 'fieldPrev': 'arrowup' };
let hiddenColumns = JSON.parse(localStorage.getItem('vocab_hidden_cols')) || { study: [], review: [] };

// MULTI-SHEET DATA
let sheetData = {};
let allFields = [];

function buildAllFields() {
    allFields = [];
    headers.forEach(h => allFields.push({ type: 'vocab', key: h }));
    Object.keys(sheetData).forEach(sn => allFields.push({ type: 'sheet', key: sn }));
    if (currentFieldIndex >= allFields.length) currentFieldIndex = 1;
}

function getFieldContent(word, idx) {
    const f = allFields[idx];
    if (!f) return { isSheet: false, content: '' };
    if (f.type === 'vocab') return { isSheet: false, content: word[f.key] || '' };
    const stt = String(word[headers[0]]);
    const rows = (sheetData[f.key] || []).filter(r => String(r.stt) === stt);
    return { isSheet: true, items: rows };
}

let screentipTimer = null;
function showScreentip(anchorEl, text) {
    const tip = document.getElementById('screentip');
    if (!tip || !text) return;
    tip.textContent = text;
    tip.style.display = 'block';
    const rect = anchorEl.getBoundingClientRect();
    const tipMaxW = Math.min(window.innerWidth * 0.85, 360);
    tip.style.maxWidth = tipMaxW + 'px';
    let top = rect.bottom + window.scrollY + 8;
    let left = rect.left + window.scrollX;
    if (left + tipMaxW > window.innerWidth - 10) left = window.innerWidth - tipMaxW - 10;
    if (left < 10) left = 10;
    if (rect.bottom + 90 > window.innerHeight) top = rect.top + window.scrollY - 90;
    tip.style.top = top + 'px';
    tip.style.left = left + 'px';
    clearTimeout(screentipTimer);
    screentipTimer = setTimeout(hideScreentip, 5000);
}

function hideScreentip() {
    const tip = document.getElementById('screentip');
    if (tip) tip.style.display = 'none';
    clearTimeout(screentipTimer);
}

document.addEventListener('DOMContentLoaded', () => {
    const displayEl = document.getElementById('display-text');
    if (displayEl) {
        displayEl.addEventListener('click', function(e) {
            if (isEditing) return;
            const jpLine = e.target.closest ? e.target.closest('.jp-line') : null;
            if (jpLine) {
                const viText = jpLine.getAttribute('data-vi') || '';
                if (viText) showScreentip(jpLine, viText);
                return;
            }
            speakText();
        });
    }
});

function loadVoices() { availableVoices = synth.getVoices(); }
if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

window.onload = async function() {
    loadVoices();
    console.log("1. B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu t·ª´ Cloud...");
    try {
        const { data: prog, error: pErr } = await supabaseClient.from('user_progress').select('*').eq('id', 'current_user').single();
        if (pErr) console.warn("Ch∆∞a c√≥ ti·∫øn ƒë·ªô c≈©");
        if (prog) {
            stats = prog.stats || {};
            headers = prog.headers || [];
            currentWordIndex = prog.current_index || 0;
            if (prog.sheet_data) sheetData = prog.sheet_data;
            console.log("2. Headers:", headers, "SheetData keys:", Object.keys(sheetData));
        }
        const { data: vocab, error: vErr } = await supabaseClient.from('hoc_tap').select('*').order('row_index', { ascending: true });
        if (vErr) { console.error("L·ªói t·∫£i vocab:", vErr); return; }
        if (vocab && vocab.length > 0 && headers.length > 0) {
            console.log("3. vocab:", vocab.length, "t·ª´");
            rawData = vocab.map(row => {
                let obj = { row_index: row.row_index };
                headers.forEach((h, i) => { obj[h] = row[`col${i+1}`]; });
                return obj;
            });
            buildAllFields();
            console.log("4. allFields:", allFields.map(f => f.key));
            initApp();
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('study-screen').classList.remove('hidden');
        } else {
            console.log("5. Cloud tr·ªëng ‚Üí gi·ªØ m√†n h√¨nh Setup");
        }
    } catch (err) {
        console.error("6. L·ªói h·ªá th·ªëng:", err);
    }
};

async function syncToCloud() {
    console.log("Sync l√™n Cloud...");
    const { error } = await supabaseClient.from('user_progress').upsert({
        id: 'current_user', stats: stats, headers: headers,
        current_index: currentWordIndex, sheet_data: sheetData
    }, { onConflict: 'id' });
    if (error) console.error("L·ªói Supabase:", error.message);
}

function unlockAudio() {
    synth.speak(new SpeechSynthesisUtterance(""));
    document.getElementById('audio-unlock').classList.add('hidden');
    initApp();
}

document.getElementById('fileInput').addEventListener('change', async (e) => {
    const reader = new FileReader();
    reader.onload = async (event) => {
        const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
        const sheetNames = workbook.SheetNames;
        const vocabSN = sheetNames.find(n => n.toLowerCase() === 'vocab') || sheetNames[0];
        rawData = XLSX.utils.sheet_to_json(workbook.Sheets[vocabSN], { defval: 'N.A' });
        if (!rawData.length) { alert("Sheet vocab tr·ªëng!"); return; }
        headers = Object.keys(rawData[0]);

        sheetData = {};
        sheetNames.forEach(sn => {
            if (sn === vocabSN) return;
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sn], { defval: '' });
            if (!rows.length) return;
            const keys = Object.keys(rows[0]);
            const find = (c) => keys.find(k => c.includes(k.toLowerCase().trim())) || keys[0];
            const cm = {
                stt: find(['stt','id','no','s·ªë']),
                idx: find(['idx','index','i']),
                jp:  find(['jp','japanese','ja','kanji','t·ª´','tu']),
                vi:  find(['vi','vietnamese','vn','nghƒ©a','nghia','meaning','d·ªãch'])
            };
            sheetData[sn] = rows.map(r => ({
                stt: String(r[cm.stt]||''), idx: r[cm.idx]||'',
                jp:  String(r[cm.jp]||''),  vi:  String(r[cm.vi]||'')
            })).filter(r => r.stt || r.jp);
        });

        buildAllFields();
        console.log("File n·∫°p xong. allFields:", allFields.map(f=>f.key), "sheetData:", Object.keys(sheetData));

        const toInsert = rawData.map((row, i) => {
            let dbRow = { row_index: i };
            headers.forEach((h, idx) => { dbRow[`col${idx+1}`] = String(row[h] || 'N.A'); });
            return dbRow;
        });
        try {
            await supabaseClient.from('hoc_tap').delete().neq('row_index', -1);
            const { error } = await supabaseClient.from('hoc_tap').insert(toInsert);
            if (error) throw error;
            await syncToCloud();
            alert(`‚úÖ ƒê√£ ƒë·ªìng b·ªô ${rawData.length} t·ª´ (${Object.keys(sheetData).length} sheet ph·ª•) l√™n Cloud!`);
            document.getElementById('audio-unlock').classList.remove('hidden');
        } catch (err) {
            console.error("L·ªói Supabase:", err);
            alert("C√≥ l·ªói: " + err.message);
        }
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

function initApp() {
    console.log("initApp...");
    if (rawData && rawData.length > 0) {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
        updateDisplay();
    }
}

function toggleModeMenu(event) {
    if (event) event.stopPropagation();
    const dropdown = document.getElementById('mode-dropdown');
    const arrow = document.getElementById('menu-arrow');
    const isShowing = dropdown.classList.toggle('show');
    if (arrow) arrow.style.transform = isShowing ? "rotate(180deg)" : "rotate(0deg)";
}

function selectMode(mode, event) {
    if (event) event.stopPropagation();
    document.getElementById('mode-dropdown').classList.remove('show');
    const arrow = document.getElementById('menu-arrow');
    if (arrow) arrow.style.transform = "rotate(0deg)";
    if (mode === 'study' || mode === 'review') {
        if (currentMode !== mode) switchMode(mode);
    } else {
        showQuizScreen();
    }
}

window.onclick = function(event) {
    if (!event.target.closest('.mode-menu-container')) document.getElementById('mode-dropdown').classList.remove('show');
    if (!event.target.closest('.jp-line')) hideScreentip();
};

function openColumnModal() {
    const listContainer = document.getElementById('column-checkbox-list');
    listContainer.innerHTML = "";
    const currentHidden = hiddenColumns[currentMode] || [];
    allFields.slice(1).forEach(f => {
        const label = f.key;
        const isSheet = f.type === 'sheet';
        const div = document.createElement('div');
        div.className = 'column-item';
        div.innerHTML = `
            <input type="checkbox" id="chk-${label}" value="${label}" ${currentHidden.includes(label) ? 'checked' : ''}>
            <label for="chk-${label}">${label}${isSheet ? '<span class="sheet-badge">sheet</span>' : ''}</label>
        `;
        div.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
                const chk = div.querySelector('input');
                chk.checked = !chk.checked;
            }
        };
        listContainer.appendChild(div);
    });
    document.getElementById('column-modal-root').classList.remove('hidden');
}

function closeColumnModal() { document.getElementById('column-modal-root').classList.add('hidden'); }

function applyColumnVisibility() {
    const checked = document.querySelectorAll('#column-checkbox-list input:checked');
    const selectedHidden = Array.from(checked).map(input => input.value);
    hiddenColumns[currentMode] = selectedHidden;
    localStorage.setItem('vocab_hidden_cols', JSON.stringify(hiddenColumns));
    validateCurrentField();
    closeColumnModal();
    updateDisplay();
}

function validateCurrentField() {
    const currentHidden = hiddenColumns[currentMode] || [];
    const label = allFields[currentFieldIndex] ? allFields[currentFieldIndex].key : null;
    if (label && currentHidden.includes(label)) {
        for (let i = 1; i < allFields.length; i++) {
            if (!currentHidden.includes(allFields[i].key)) {
                currentFieldIndex = i;
                break;
            }
        }
    }
}

let isFuriganaEnabled = false;
try {
    const savedFurigana = localStorage.getItem('vocab_furigana');
    isFuriganaEnabled = savedFurigana ? JSON.parse(savedFurigana) : false;
} catch (e) { isFuriganaEnabled = false; }

function toggleFurigana() {
    isFuriganaEnabled = !isFuriganaEnabled;
    localStorage.setItem('vocab_furigana', JSON.stringify(isFuriganaEnabled));
    updateFuriganaButtons();
    updateDisplay();
}

function updateFuriganaButtons() {
    const btn = document.getElementById('furiganaToggle');
    if (btn) {
        btn.innerText = isFuriganaEnabled ? "Furigana: ON" : "Furigana: OFF";
        btn.style.background = isFuriganaEnabled ? "var(--primary)" : "#e2e8f0";
        btn.style.color = isFuriganaEnabled ? "white" : "#475569";
    }
}

function toggleDataMenu() {
    const wrapper = document.getElementById('data-controls-wrapper');
    const btn = document.getElementById('btn-data-toggle');
    if (wrapper.classList.contains('hidden')) {
        wrapper.classList.remove('hidden');
        btn.innerText = 'Data ‚ñ¥';
        btn.style.background = 'var(--primary)';
        setTimeout(() => wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
    } else {
        wrapper.classList.add('hidden');
        btn.innerText = 'Data ‚ñæ';
        btn.style.background = '#334155';
    }
}

function formatFurigana(text) {
    if (!text) return "";
    return text.replace(/([‰∏Ä-Èæ†„ÄÖa-zA-Z0-9]+)\(([^)]+)\)/g, (match, kanji, furigana) => {
        return `<ruby>${kanji}<rt>${furigana}</rt></ruby>`;
    });
}

function updateDisplay(shouldSpeak = false) {
    if (!rawData.length || !allFields.length) return;
    const word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    const total = currentMode === 'study' ? rawData.length : reviewPool.length;
    if (!word) return;

    const sttExcel = word[headers[0]];
    document.getElementById('word-counter-top').innerText = `${sttExcel} / ${total}`;

    const currentHidden = (hiddenColumns && hiddenColumns[currentMode]) ? hiddenColumns[currentMode] : [];
    let prevLabel = "";
    for (let i = currentFieldIndex - 1; i >= 1; i--) {
        if (!currentHidden.includes(allFields[i].key)) { prevLabel = allFields[i].key; break; }
    }
    let nextLabel = "";
    for (let i = currentFieldIndex + 1; i < allFields.length; i++) {
        if (!currentHidden.includes(allFields[i].key)) { nextLabel = allFields[i].key; break; }
    }
    document.getElementById('prev-field').innerText = prevLabel;
    document.getElementById('curr-field').innerText = allFields[currentFieldIndex] ? allFields[currentFieldIndex].key : '';
    document.getElementById('next-field').innerText = nextLabel;
    document.getElementById('btn-prev-field').style.visibility = prevLabel ? 'visible' : 'hidden';
    document.getElementById('btn-next-field').style.visibility = nextLabel ? 'visible' : 'hidden';

    const displayEl = document.getElementById('display-text');
    const hintEl = document.getElementById('speaker-hint');
    const fc = getFieldContent(word, currentFieldIndex);

    if (!fc.isSheet) {
        let rawContent = fc.content || "";
        displayEl.innerHTML = isFuriganaEnabled ? formatFurigana(rawContent) : rawContent.replace(/\(.*?\)/g, '');
        hintEl.innerText = "Ch·∫°m ƒë·ªÉ ƒë·ªçc";
    } else {
        const items = fc.items || [];
        if (!items.length) {
            displayEl.innerHTML = '<span style="color:#94a3b8; font-size:1.1rem; font-weight:normal;">‚Äî Kh√¥ng c√≥ d·ªØ li·ªáu ‚Äî</span>';
        } else {
            displayEl.innerHTML = items.map(item => {
                let jp = item.jp || '';
                jp = isFuriganaEnabled ? formatFurigana(jp) : jp.replace(/\(.*?\)/g, '');
                const viSafe = (item.vi||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                return `<span class="jp-line" data-vi="${viSafe}">${jp||'&nbsp;'}</span>`;
            }).join('');
        }
        hintEl.innerText = "Ch·∫°m v√†o d√≤ng ƒë·ªÉ xem nghƒ©a";
    }

    const statusDivTop = document.getElementById('status-display-top');
    const currentStatus = stats[sttExcel];
    if (currentStatus === 'learned') statusDivTop.innerHTML = "‚úÖ";
    else if (currentStatus === 'mastered') statusDivTop.innerHTML = "‚≠ê";
    else statusDivTop.innerHTML = '<span style="opacity: 0.2;">‚Ä¢</span>';

    if (shouldSpeak && !isAutoPlaying && document.getElementById('autoSpeak').checked) {
        setTimeout(() => speakText(), 100);
    }
    updateFuriganaButtons();
}

async function moveWord(step) {
    currentWordIndex = (currentWordIndex + step + rawData.length) % rawData.length;
    currentFieldIndex = 1;
    updateDisplay(true);
    syncToCloud().catch(err => console.error("L·ªói l∆∞u cloud:", err));
}

function nextReviewWord() {
    if (reviewIndex < reviewPool.length - 1) reviewIndex++;
    else { prepareReviewPool(); reviewIndex = 0; }
    currentFieldIndex = 1;
    updateDisplay(true);
}

function prevReviewWord() {
    reviewIndex = (reviewIndex - 1 + reviewPool.length) % reviewPool.length;
    currentFieldIndex = 1;
    updateDisplay(true);
}

function changeField(dir) {
    const currentHidden = hiddenColumns[currentMode] || [];
    let nextIdx = currentFieldIndex;
    while (true) {
        nextIdx += dir;
        if (nextIdx < 1 || nextIdx >= allFields.length) return false;
        if (!currentHidden.includes(allFields[nextIdx].key)) {
            currentFieldIndex = nextIdx;
            updateDisplay(true);
            return true;
        }
    }
}

async function setStatus(status) {
    let word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    if (!word) return;
    const wordKey = word[headers[0]];

    const currFieldEl = document.getElementById('curr-field');
    if (currFieldEl) {
        let flashColor = '#475569';
        if (status === 'learned') flashColor = '#22c55e';
        else if (status === 'mastered') flashColor = '#eab308';
        else if (status === null) flashColor = '#ef4444';
        currFieldEl.style.transition = 'none';
        currFieldEl.style.color = flashColor;
        currFieldEl.style.transform = 'scale(1.1)';
        setTimeout(() => {
            currFieldEl.style.transition = 'all 0.3s ease';
            currFieldEl.style.color = '';
            currFieldEl.style.transform = 'scale(1)';
        }, 200);
    }

    if (status === null) delete stats[wordKey];
    else stats[wordKey] = status;
    await syncToCloud();

    if (currentMode === 'review' && (status === 'mastered' || status === null)) {
        reviewPool.splice(reviewIndex, 1);
        if (reviewPool.length === 0) { stopAutoPlay(); alert("ƒê√£ ho√†n th√†nh m·ª•c ti√™u √¥n t·∫≠p!"); switchMode('study'); return; }
        if (reviewIndex >= reviewPool.length) reviewIndex = 0;
        updateDisplay();
    } else {
        updateDisplay();
        if (currentMode === 'review') nextReviewWord();
    }
}

let fieldClickTimer = null;
document.getElementById('curr-field').onclick = function(e) {
    e.stopPropagation();
    if (fieldClickTimer === null) {
        fieldClickTimer = setTimeout(() => { fieldClickTimer = null; setStatus('learned'); }, 300);
    } else {
        clearTimeout(fieldClickTimer);
        fieldClickTimer = null;
        setStatus('mastered');
    }
};

window.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.contentEditable === "true") return;
    const key = e.key.toLowerCase();
    if (['arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(key)) e.preventDefault();
    if (key === hotkeys.next) handleNext();
    else if (key === hotkeys.prev) handlePrev();
    else if (key === hotkeys.learned) setStatus('learned');
    else if (key === hotkeys.mastered) setStatus('mastered');
    else if (key === hotkeys.forgot) setStatus(null);
    else if (key === hotkeys.speak) speakText();
    else if (key === hotkeys.fieldNext) changeField(1);
    else if (key === hotkeys.fieldPrev) changeField(-1);
});

function handleNext() { if (currentMode === 'study') moveWord(1); else nextReviewWord(); }
function handlePrev() { if (currentMode === 'study') moveWord(-1); else prevReviewWord(); }

function switchMode(mode) {
    stopAutoPlay();
    currentMode = mode;
    const titleEl = document.getElementById('mode-title');
    if (mode === 'review') {
        prepareReviewPool();
        if (reviewPool.length === 0) { alert("Tr·ªëng!"); currentMode = 'study'; return; }
        titleEl.innerHTML = 'Ch·∫ø ƒë·ªô √¥n t·∫≠p <span id="menu-arrow">‚ñæ</span>';
        document.getElementById('study-controls').classList.add('hidden');
        document.getElementById('review-controls').classList.remove('hidden');
        document.getElementById('random-multi-wrap').classList.remove('hidden');
        reviewIndex = 0;
        currentFieldIndex = 1;
        updateDisplay(true);
    } else {
        titleEl.innerHTML = 'Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span>';
        document.getElementById('study-controls').classList.remove('hidden');
        document.getElementById('review-controls').classList.add('hidden');
        document.getElementById('random-multi-wrap').classList.add('hidden');
        currentFieldIndex = 1;
        updateDisplay(true);
    }
    document.getElementById('mode-dropdown').style.display = 'none';
}

function prepareReviewPool() {
    const learned = rawData.filter(w => stats[w[headers[0]]] === 'learned');
    const mastered = rawData.filter(w => stats[w[headers[0]]] === 'mastered');
    let pool = [];
    const isRandomMulti = document.getElementById('randomMulti').checked;
    if (isRandomMulti) {
        let tempMastered = [...mastered].sort(() => Math.random() - 0.5);
        let limitMastered = Math.max(1, Math.floor(learned.length * 0.05));
        pool = [...learned, ...tempMastered.slice(0, limitMastered)].sort(() => Math.random() - 0.5);
    } else {
        let processedSTT = new Set(), groupedPool = [];
        let validWords = [...learned, ...mastered].sort(() => Math.random() - 0.5);
        validWords.forEach(word => {
            let stt = String(word[headers[0]]);
            if (processedSTT.has(stt)) return;
            let match = stt.match(/^(\d+)([a-z])$/);
            if (match) {
                let numPart = match[1];
                let group = rawData.filter(w => String(w[headers[0]]).startsWith(numPart) && String(w[headers[0]]).match(/^\d+[a-z]$/)).sort((a, b) => String(a[headers[0]]).localeCompare(String(b[headers[0]])));
                group.forEach(g => { groupedPool.push(g); processedSTT.add(String(g[headers[0]])); });
            } else { groupedPool.push(word); processedSTT.add(stt); }
        });
        pool = groupedPool;
    }
    reviewPool = pool;
}

function speakText(callback) {
    const word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    if (!word) { if (callback) callback(); return; }
    const fc = getFieldContent(word, currentFieldIndex);

    if (fc.isSheet) {
        const texts = (fc.items||[]).map(it=>(it.jp||'').replace(/\(.*?\)/g,'').trim()).filter(t=>t&&t!=='N.A');
        if (!texts.length) { if (callback) callback(); return; }
        let i = 0;
        function next() {
            if (i >= texts.length) { if (callback) callback(); return; }
            speakSingle(texts[i++], () => setTimeout(next, 350));
        }
        next();
        return;
    }

    const displayEl = document.getElementById('display-text');
    if (!displayEl) { if (callback) callback(); return; }
    const tempEl = displayEl.cloneNode(true);
    tempEl.querySelectorAll('rt').forEach(rt => rt.remove());
    let text = tempEl.innerText.replace(/\(.*?\)/g, '').trim();
    if (!text || text === "N.A" || text === "---") { if (callback) callback(); return; }
    speakSingle(text, callback);
}

function speakSingle(text, callback) {
    const isVN = /[√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªáƒë√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµ]/i.test(text);
    const isJP = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(text);
    let langCode = isVN ? 'vi-VN' : (isJP ? 'ja-JP' : 'en-US');
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langCode;
    let allVoices = synth.getVoices();
    let selectedVoice = null;
    if (langCode === 'vi-VN') {
        selectedVoice = allVoices.find(v => v.lang.startsWith('vi') && v.name.includes('Linh') && v.name.includes('Enhanced'))
            || allVoices.find(v => v.lang.startsWith('vi') && (v.name.includes('Linh') || v.name.includes('An')))
            || allVoices.find(v => v.lang.startsWith('vi'));
    } else if (langCode === 'ja-JP') {
        selectedVoice = allVoices.find(v => v.lang.startsWith('ja') && v.name.includes('Kyoko') && v.name.includes('Enhanced'))
            || allVoices.find(v => v.lang.startsWith('ja') && (v.name.includes('Kyoko') || v.name.includes('Haruka') || v.name.includes('Ichiro')))
            || allVoices.find(v => v.lang.startsWith('ja'));
    } else {
        selectedVoice = allVoices.find(v => v.lang.startsWith('en') && (v.name.includes('Allison') || v.name.includes('Samantha')) && v.name.includes('Enhanced'))
            || allVoices.find(v => v.lang.startsWith('en') && (v.name.includes('Samantha') || v.name.includes('Zira') || v.name.includes('David')))
            || allVoices.find(v => v.lang.startsWith('en'));
    }
    if (selectedVoice) utter.voice = selectedVoice;
    utter.rate = document.getElementById('voiceRate').value || 1;
    utter.onend = () => { if (callback) callback(); };
    utter.onerror = () => { if (callback) callback(); };
    setTimeout(() => synth.speak(utter), 100);
}

function toggleAutoPlay() { if (isAutoPlaying) stopAutoPlay(); else startAutoPlay(); }
function startAutoPlay() {
    isAutoPlaying = true;
    document.getElementById('btn-autoplay').innerText = "‚èπ D·ª´ng ph√°t";
    document.getElementById('btn-autoplay').style.background = "var(--danger)";
    currentFieldIndex = 1;
    updateDisplay();
    playSequence();
}
function stopAutoPlay() {
    isAutoPlaying = false;
    synth.cancel();
    document.getElementById('btn-autoplay').innerText = "‚ñ∂ T·ª± ƒë·ªông ph√°t";
    document.getElementById('btn-autoplay').style.background = "#8b5cf6";
}

function playSequence() {
    if (!isAutoPlaying) return;
    const headerText = allFields[currentFieldIndex] ? allFields[currentFieldIndex].key : '';
    const utterHeader = new SpeechSynthesisUtterance(headerText);
    utterHeader.lang = 'vi-VN';
    if (availableVoices.length > 0) {
        const viVoice = availableVoices.find(v => v.lang.startsWith('vi-VN'));
        if (viVoice) utterHeader.voice = viVoice;
    }
    utterHeader.rate = document.getElementById('voiceRate').value;
    utterHeader.onend = () => {
        if (!isAutoPlaying) return;
        speakText(() => {
            if (!isAutoPlaying) return;
            setTimeout(() => {
                if (!isAutoPlaying) return;
                if (currentFieldIndex < allFields.length - 1) {
                    currentFieldIndex++;
                    updateDisplay();
                    playSequence();
                } else {
                    if (reviewIndex < reviewPool.length - 1) {
                        reviewIndex++;
                        currentFieldIndex = 1;
                        updateDisplay();
                        playSequence();
                    } else { stopAutoPlay(); }
                }
            }, 800);
        });
    };
    synth.speak(utterHeader);
}

function showDatabaseView() {
    isDataChanged = false;
    document.getElementById('study-screen').classList.add('hidden');
    document.getElementById('db-view-screen').classList.remove('hidden');
    renderExcelTable();
}

function renderExcelTable() {
    const thead = document.getElementById('excel-thead');
    const tbody = document.getElementById('excel-tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    let trH = document.createElement('tr');
    headers.forEach(h => { let th = document.createElement('th'); th.innerText = h; trH.appendChild(th); });
    let thAct = document.createElement('th');
    thAct.innerText = "Thao t√°c";
    trH.appendChild(thAct);
    thead.appendChild(trH);
    rawData.forEach((row) => {
        let trB = document.createElement('tr');
        headers.forEach(h => {
            let td = document.createElement('td');
            td.contentEditable = "true";
            td.innerText = row[h] || "";
            td.oninput = () => { isDataChanged = true; };
            trB.appendChild(td);
        });
        let tdAct = document.createElement('td');
        tdAct.style.textAlign = "center";
        tdAct.innerHTML = `<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;
        trB.appendChild(tdAct);
        tbody.appendChild(trB);
    });
}

function deleteExcelRow(btn) {
    if (confirm("X√≥a h√†ng n√†y?")) { btn.closest('tr').remove(); isDataChanged = true; }
}

function addRowToExcel() {
    const tbody = document.getElementById('excel-tbody');
    let trB = document.createElement('tr');
    headers.forEach(() => {
        let td = document.createElement('td');
        td.contentEditable = "true";
        td.oninput = () => { isDataChanged = true; };
        trB.appendChild(td);
    });
    let tdAct = document.createElement('td');
    tdAct.style.textAlign = "center";
    tdAct.innerHTML = `<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;
    trB.appendChild(tdAct);
    tbody.appendChild(trB);
    isDataChanged = true;
}

function saveExcelChanges() {
    if (isDataChanged && !confirm("L∆∞u c√°c thay ƒë·ªïi?")) return;
    const rows = document.querySelectorAll('#excel-tbody tr');
    let newData = [];
    rows.forEach(tr => {
        let rowObj = {};
        const cells = tr.querySelectorAll('td');
        headers.forEach((h, i) => { rowObj[h] = cells[i] ? cells[i].innerText.trim() : ''; });
        if (Object.values(rowObj).some(v => v !== "")) newData.push(rowObj);
    });
    rawData = newData;
    localStorage.setItem('vocab_data', JSON.stringify(rawData));
    isDataChanged = false;
    alert("ƒê√£ l∆∞u d·ªØ li·ªáu!");
    initApp();
    exitDatabaseView();
}

function exitDatabaseView() {
    if (isDataChanged && confirm("D·ªØ li·ªáu ch∆∞a l∆∞u, l∆∞u tr∆∞·ªõc khi tho√°t?")) { saveExcelChanges(); return; }
    document.getElementById('db-view-screen').classList.add('hidden');
    document.getElementById('study-screen').classList.remove('hidden');
}

function showAddFromFile() { document.getElementById('add-file-panel').classList.remove('hidden'); }
function hideAddFromFile() { document.getElementById('add-file-panel').classList.add('hidden'); }

function confirmAddFromFile() {
    const fileInput = document.getElementById('addWordsFileInput');
    if (!fileInput.files.length) { alert("Vui l√≤ng ch·ªçn file!"); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const vocabSN = workbook.SheetNames.find(n => n.toLowerCase() === 'vocab') || workbook.SheetNames[0];
        const incomingData = XLSX.utils.sheet_to_json(workbook.Sheets[vocabSN], { defval: "N.A" });
        if (incomingData.length > 0) {
            const incomingHeaders = Object.keys(incomingData[0]);
            if (incomingHeaders.length !== headers.length) { alert(`L·ªói: S·ªë c·ªôt kh√¥ng kh·ªõp!`); return; }
            const standardizedData = incomingData.map(row => {
                let newRow = {};
                incomingHeaders.forEach((h, i) => { newRow[headers[i]] = row[h]; });
                return newRow;
            });
            rawData = [...rawData, ...standardizedData];
            localStorage.setItem('vocab_data', JSON.stringify(rawData));
            alert(`ƒê√£ n·ªëi th√™m ${standardizedData.length} t·ª´!`);
            hideAddFromFile();
            initApp();
        }
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
}

async function exportFullBackup() {
    if (!rawData.length) { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); return; }
    const allKeys = Object.keys(rawData[0]);
    const overlay = document.createElement('div');
    overlay.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;font-family:sans-serif;`;
    const modal = document.createElement('div');
    modal.style.cssText = `background:white;padding:25px;border-radius:15px;max-width:550px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,0.2);`;
    modal.innerHTML = `
        <h3 style="margin-top:0;color:#1f2937;">C·∫•u h√¨nh Export JSON</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <div>
                <strong style="font-size:14px;color:#ef4444;">1. LO·∫†I B·ªé (Exclude)</strong>
                <p style="font-size:11px;color:#666;margin:5px 0 10px;">Tick ƒë·ªÉ x√≥a kh·ªèi file JSON</p>
                <div style="display:flex;flex-direction:column;gap:5px;">
                    ${allKeys.map(key => `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;"><input type="checkbox" value="${key}" class="export-exclude-key"> ${key}</label>`).join('')}
                </div>
            </div>
            <div>
                <strong style="font-size:14px;color:#6366f1;">2. REFORMAT KANJI</strong>
                <p style="font-size:11px;color:#666;margin:5px 0 10px;">A(B)C -> AC(B+C)</p>
                <div style="display:flex;flex-direction:column;gap:5px;">
                    ${allKeys.map(key => `<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;"><input type="checkbox" value="${key}" class="export-reformat-key"> ${key}</label>`).join('')}
                </div>
            </div>
        </div>
        <div style="margin-top:25px;display:flex;gap:10px;">
            <button id="btn-confirm-export" style="flex:2;padding:12px;background:#6366f1;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">X√°c nh·∫≠n & T·∫£i v·ªÅ</button>
            <button id="btn-cancel-export" style="flex:1;padding:12px;background:#eee;border:none;border-radius:8px;cursor:pointer;">H·ªßy</button>
        </div>`;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    document.getElementById('btn-cancel-export').onclick = () => overlay.remove();
    document.getElementById('btn-confirm-export').onclick = () => {
        const excludedKeys = Array.from(document.querySelectorAll('.export-exclude-key:checked')).map(cb => cb.value);
        const reformatKeys = Array.from(document.querySelectorAll('.export-reformat-key:checked')).map(cb => cb.value);
        const filteredVocabData = rawData.map(item => {
            let newItem = { ...item };
            excludedKeys.forEach(key => delete newItem[key]);
            reformatKeys.forEach(key => {
                if (newItem[key] && typeof newItem[key] === 'string' && newItem[key].includes('(')) {
                    const original = newItem[key];
                    const displayWord = original.replace(/\(.*?\)/g, '');
                    const reading = original.replace(/[^\u3040-\u309F\u30A0-\u30FF]/g, '');
                    newItem[key] = `${displayWord}(${reading})`;
                }
            });
            return newItem;
        });
        const fullData = {
            vocab_data: filteredVocabData,
            vocab_headers: headers.filter(h => !excludedKeys.includes(h)),
            vocab_stats: stats,
            vocab_hotkeys: hotkeys,
            quiz_scenarios: scenarios,
            sheet_data: sheetData,
            export_date: new Date().toLocaleString()
        };
        const blob = new Blob([JSON.stringify(fullData, null, 4)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Vocab_Backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        overlay.remove();
    };
}

function importFullBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            localStorage.setItem('vocab_data', JSON.stringify(data.vocab_data));
            localStorage.setItem('vocab_headers', JSON.stringify(data.vocab_headers));
            localStorage.setItem('vocab_stats', JSON.stringify(data.vocab_stats || {}));
            alert("Th√†nh c√¥ng!");
            location.reload();
        } catch (err) { alert("L·ªói!"); }
    };
    reader.readAsText(file);
}

function showQuizScreen(event) {
    if (event) event.stopPropagation();
    document.getElementById('mode-dropdown').classList.remove('show');
    const arrow = document.getElementById('menu-arrow');
    if (arrow) arrow.style.transform = "rotate(0deg)";
    stopAutoPlay();
    document.getElementById('study-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('quiz-setup').classList.remove('hidden');
    document.getElementById('quiz-playing').classList.add('hidden');
    const pool = rawData.filter(w => stats[w[headers[0]]]);
    document.getElementById('quiz-header-title').innerText = `üìù Tr·∫Øc nghi·ªám (${pool.length})`;
    if (scenarios.length === 0) { scenarios.push({ root: headers[1], exclude: [headers[0]] }); saveScenarios(); }
    renderScenarios();
}

function addScenario() { scenarios.push({ root: headers[1], exclude: [headers[0]] }); saveScenarios(); renderScenarios(); }
function removeScenario(idx) { scenarios.splice(idx, 1); if (scenarios.length === 0) addScenario(); else { saveScenarios(); renderScenarios(); } }
function saveScenarios() { localStorage.setItem('quiz_scenarios', JSON.stringify(scenarios)); }

function renderScenarios() {
    const list = document.getElementById('scenarios-list');
    list.innerHTML = "";
    const poolCount = rawData.filter(w => stats[w[headers[0]]] === 'learned' || stats[w[headers[0]]] === 'mastered').length;
    const vocabHeaders = headers.slice(1);
    scenarios.forEach((sc, idx) => {
        const box = document.createElement('div');
        box.className = 'scenario-box';
        let rootOpts = vocabHeaders.map(h => `<option value="${h}" ${h === sc.root ? 'selected' : ''}>${h}</option>`).join('');
        let exOpts = vocabHeaders.filter(h => h !== sc.root).map(h => `<label class="exclude-item"><input type="checkbox" ${sc.exclude.includes(h) ? 'checked' : ''} onchange="toggleExclude(${idx}, '${h}')"> ${h}</label>`).join('');
        const targetCount = vocabHeaders.filter(h => h !== sc.root && !sc.exclude.includes(h)).length;
        box.innerHTML = `
            <span class="remove-scenario" onclick="removeScenario(${idx})">‚úñ X√≥a</span>
            <span class="scenario-title">K·ªãch b·∫£n ${idx + 1}</span>
            <div style="font-size:0.8rem;color:var(--primary);margin-bottom:10px;">T·ªëi ƒëa: <strong>${poolCount * targetCount}</strong> c√¢u h·ªèi</div>
            <div class="select-group"><label>C·ªôt g·ªëc:</label><select onchange="updateRoot(${idx}, this.value)" style="width:100%;padding:5px;border-radius:5px;">${rootOpts}</select></div>
            <div class="select-group"><label>C·ªôt lo·∫°i tr·ª´:</label><div class="exclude-list">${exOpts}</div></div>`;
        list.appendChild(box);
    });
}

function updateRoot(idx, val) { scenarios[idx].root = val; saveScenarios(); renderScenarios(); }
function toggleExclude(idx, val) {
    const i = scenarios[idx].exclude.indexOf(val);
    if (i > -1) scenarios[idx].exclude.splice(i, 1);
    else scenarios[idx].exclude.push(val);
    saveScenarios();
    renderScenarios();
}

function startQuiz() {
    const Q = parseInt(document.getElementById('quizCount').value) || null;
    const timeVal = parseInt(document.getElementById('timePerQuestion').value) || 10;
    const pool = rawData.filter(w => stats[w[headers[0]]]);
    if (!pool.length) { alert("H·ªçc th√™m t·ª´ ƒëi!"); return; }
    quizData = [];
    userAnswers = {};
    scenarios.forEach(sc => {
        const targets = headers.filter((h, i) => i !== 0 && h !== sc.root && !sc.exclude.includes(h));
        pool.forEach(word => { targets.forEach(t => { quizData.push({ rH: sc.root, tH: t, rV: word[sc.root], cV: word[t] }); }); });
    });
    quizData.sort(() => Math.random() - 0.5);
    if (Q && Q < quizData.length) quizData = quizData.slice(0, Q);
    document.getElementById('quiz-setup').classList.add('hidden');
    document.getElementById('quiz-playing').classList.remove('hidden');
    document.getElementById('quiz-result-summary').classList.add('hidden');
    document.getElementById('quiz-finish-btn').classList.remove('hidden');
    const container = document.getElementById('quiz-container');
    container.innerHTML = "";
    quizData.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = 'quiz-item';
        item.id = `quiz-q-${idx}`;
        let allVals = [...new Set(rawData.map(w => w[q.tH]))];
        let choices = [q.cV, ...allVals.filter(v => v !== q.cV).sort(() => Math.random() - 0.5).slice(0, 3)].sort(() => Math.random() - 0.5);
        item.innerHTML = `<h4 onclick="document.getElementById('quiz-result-summary').scrollIntoView({behavior:'smooth'})" style="cursor:pointer;color:var(--primary);text-decoration:underline;">C√¢u ${idx + 1}: "${q.tH}" c·ªßa <u>${q.rV}</u>?</h4>`;
        choices.forEach(c => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = c;
            b.onclick = () => {
                if (document.getElementById('quiz-finish-btn').classList.contains('hidden')) return;
                Array.from(item.querySelectorAll('.option-btn')).forEach(btn => btn.classList.remove('selected'));
                b.classList.add('selected');
                userAnswers[idx] = c;
            };
            item.appendChild(b);
        });
        container.appendChild(item);
    });
    let timeLeft = quizData.length * timeVal;
    clearInterval(quizInterval);
    quizInterval = setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft / 60),
            s = timeLeft % 60;
        document.getElementById('time-left').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if (timeLeft <= 0) { clearInterval(quizInterval); finishQuiz(); }
    }, 1000);
}

function restartQuiz() {
    clearInterval(quizInterval);
    document.getElementById('quiz-result-summary').classList.add('hidden');
    document.getElementById('quiz-finish-btn').classList.remove('hidden');
    startQuiz();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function finishQuiz() {
    clearInterval(quizInterval);
    document.getElementById('quiz-finish-btn').classList.add('hidden');
    const summary = document.getElementById('quiz-result-summary');
    summary.classList.remove('hidden');
    let score = 0;
    quizData.forEach((q, idx) => {
        const item = document.getElementById(`quiz-q-${idx}`);
        item.querySelectorAll('.option-btn').forEach(b => {
            b.style.pointerEvents = 'none';
            if (b.innerText === q.cV) b.classList.add('correct-ans');
            if (userAnswers[idx] === b.innerText && b.innerText !== q.cV) b.classList.add('wrong-ans');
        });
        if (userAnswers[idx] === q.cV) score++;
    });
    summary.innerHTML = `<h3 style="margin-top:0">K·∫øt qu·∫£: ${score}/${quizData.length}</h3>
    <div style="display:flex;gap:10px;margin-bottom:20px;">
        <button onclick="restartQuiz()" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:8px;font-weight:bold;">üîÑ L√†m l·∫°i</button>
        <button onclick="exitQuiz(true)" style="flex:1;padding:12px;background:#64748b;color:white;border:none;border-radius:8px;font-weight:bold;">üè† Tho√°t</button>
    </div>`;
    quizData.forEach((_, i) => {
        const dot = document.createElement('span');
        dot.className = 'dot-nav';
        dot.style.background = (userAnswers[i] === quizData[i].cV) ? 'var(--success)' : 'var(--danger)';
        dot.innerText = i + 1;
        dot.onclick = () => document.getElementById(`quiz-q-${i}`).scrollIntoView({ behavior: 'smooth' });
        summary.appendChild(dot);
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function exitQuiz(forceQuit = false) {
    clearInterval(quizInterval);
    const quizSetup = document.getElementById('quiz-setup');
    const quizPlaying = document.getElementById('quiz-playing');
    const quizResult = document.getElementById('quiz-result-summary');
    if (forceQuit) {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
        quizPlaying.classList.add('hidden');
        quizResult.classList.add('hidden');
        quizSetup.classList.remove('hidden');
        return;
    }
    if (!quizResult.classList.contains('hidden') || !quizPlaying.classList.contains('hidden')) {
        quizPlaying.classList.add('hidden');
        quizResult.classList.add('hidden');
        quizSetup.classList.remove('hidden');
        const finishBtn = document.getElementById('quiz-finish-btn');
        if (finishBtn) finishBtn.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
    }
}

async function resetDatabase() {
    if (confirm("X√≥a S·∫†CH d·ªØ li·ªáu tr√™n Cloud? Kh√¥ng th·ªÉ ho√†n t√°c!")) {
        try {
            await supabaseClient.from('hoc_tap').delete().neq('row_index', -1);
            await supabaseClient.from('user_progress').upsert({ id: 'current_user', stats: {}, headers: [], current_index: 0, sheet_data: {} });
            localStorage.clear();
            alert("ƒê√£ x√≥a s·∫°ch! Trang web s·∫Ω t·∫£i l·∫°i.");
            location.reload();
        } catch (err) {
            console.error(err);
            alert("C√≥ l·ªói: " + err.message);
        }
    }
}

function enterEditMode() {
    if (isEditing) return;
    const f = allFields[currentFieldIndex];
    if (f && f.type === 'sheet') {
        alert("Tr∆∞·ªùng sheet kh√¥ng th·ªÉ s·ª≠a tr·ª±c ti·∫øp t·∫°i ƒë√¢y.\nH√£y s·ª≠a file Excel v√† n·∫°p l·∫°i.");
        return;
    }
    stopAutoPlay();
    isEditing = true;
    const el = document.getElementById('display-text');
    if (!el) return;
    editOriginalText = el.innerText;
    el.setAttribute('contenteditable', 'true');
    el.focus();
    el.style.userSelect = 'text';
    el.style.webkitUserSelect = 'text';
    el.style.cursor = 'text';
    disableSwipe();
    showEditPopup();
}

function showEditPopup() {
    const container = document.getElementById('display-text').parentElement;
    const oldPopup = document.getElementById('edit-popup');
    if (oldPopup) oldPopup.remove();
    const popup = document.createElement('div');
    popup.id = 'edit-popup';
    popup.style.cssText = `position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:100%;display:flex;justify-content:space-between;padding:0 10px;box-sizing:border-box;z-index:1001;pointer-events:none;`;
    popup.innerHTML = `
        <button class="btn-save" onclick="saveEdit()" style="pointer-events:auto;min-width:90px;box-shadow:0 4px 6px rgba(0,0,0,0.2);background:var(--success);color:white;padding:10px;border-radius:8px;font-weight:bold;">üíæ L∆∞u</button>
        <button class="btn-cancel" onclick="cancelEdit()" style="pointer-events:auto;min-width:90px;box-shadow:0 4px 6px rgba(0,0,0,0.2);background:#94a3b8;color:white;padding:10px;border-radius:8px;font-weight:bold;">‚ùå H·ªßy</button>`;
    container.style.position = 'relative';
    container.appendChild(popup);
}

async function saveEdit() {
    console.log("--- B·∫ÆT ƒê·∫¶U L∆ØU ---");
    const el = document.getElementById('display-text');
    if (!el) return;
    const newValue = el.innerText.trim();
    const word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    let actualField = "";
    headers.forEach((h) => { if (word[h] === editOriginalText) actualField = h; });
    const fieldName = actualField || headers[currentFieldIndex];
    const fieldIdx = headers.indexOf(fieldName);
    const dbFieldName = `col${fieldIdx + 1}`;
    const rowIndex = parseInt(word.row_index);
    if (isNaN(rowIndex)) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y ID d√≤ng!"); return; }
    try {
        const { data, error } = await supabaseClient.from('hoc_tap').update({ [dbFieldName]: newValue }).eq('row_index', rowIndex).select();
        if (error) throw error;
        if (data && data.length > 0) {
            word[fieldName] = newValue;
            alert("ƒê√£ l∆∞u th√†nh c√¥ng v√†o c·ªôt: " + fieldName);
            exitEditMode();
            updateDisplay(true);
        } else { alert("L·ªói: Kh√¥ng t√¨m th·∫•y d√≤ng ƒë·ªÉ update."); }
    } catch (err) {
        alert("L·ªói: " + err.message);
        console.error(err);
    }
}

function cancelEdit() {
    const el = document.getElementById('display-text');
    el.innerText = editOriginalText;
    exitEditMode();
}

function exitEditMode() {
    const el = document.getElementById('display-text');
    el.removeAttribute('contenteditable');
    isEditing = false;
    editOriginalText = "";
    enableSwipe();
    const popup = document.getElementById('edit-popup');
    if (popup) popup.remove();
}

function disableSwipe() { if (cardElement) cardElement.style.touchAction = 'none'; }
function enableSwipe() { if (cardElement) cardElement.style.touchAction = ''; }

let touchstartX = 0,
    touchstartY = 0;
const cardElement = document.querySelector('.card');
const scrollArea = document.querySelector('.card-content');

if (cardElement) {
    cardElement.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX;
        touchstartY = e.changedTouches[0].screenY;
    }, { passive: true });

    cardElement.addEventListener('touchmove', e => {
        if (isEditing) return;
        let currX = e.changedTouches[0].screenX,
            currY = e.changedTouches[0].screenY;
        let diffX = Math.abs(currX - touchstartX),
            diffY = Math.abs(currY - touchstartY);
        if (diffX > diffY && diffX > 10) {
            if (e.cancelable) e.preventDefault();
        } else if (diffY > diffX) {
            const isScrollable = scrollArea.scrollHeight > scrollArea.clientHeight;
            if (isScrollable) e.stopPropagation();
            else if (e.cancelable) e.preventDefault();
        }
    }, { passive: false });

    cardElement.addEventListener('touchend', e => {
        let touchendX = e.changedTouches[0].screenX,
            touchendY = e.changedTouches[0].screenY;
        const diffX = touchendX - touchstartX,
            diffY = touchendY - touchstartY;
        if (Math.abs(diffX) > 40 && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX < 0) handleNext();
            else handlePrev();
        }
    }, { passive: true });
}
</script>
</body>
</html>
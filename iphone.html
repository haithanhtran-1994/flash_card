<!DOCTYPE html>
<html lang="vi">
<head>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="VocabMaster">
	<link rel="apple-touch-icon" href="https://via.placeholder.com/180">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Master Pro - Study & Review</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --primary: #2563eb; --success: #16a34a; --warning: #ca8a04; --danger: #ef4444; --bg: #f1f5f9; }

    html, body { 
        margin: 0; 
        padding: 0; 
        width: 100%; 
        /* X√ìA height: 100% v√† position: fixed ƒë·ªÉ m√†n h√¨nh c√≥ th·ªÉ cu·ªôn t·ª± nhi√™n */
        min-height: 100%; 
        background: var(--bg);
    }

    body { 
        font-family: 'Segoe UI', sans-serif; 
        display: flex; 
        flex-direction: column; 
        align-items: center;
        /* Cho ph√©p cu·ªôn trang khi n·ªôi dung d√†i (nh∆∞ tr·∫Øc nghi·ªám) */
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    .container { width: 95%; max-width: 700px; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin: 20px 0; position: relative; }
    .hidden { display: none !important; }
    .status-badge { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; display: flex; gap: 5px; z-index: 10; }

    /* --- C·∫¨P NH·∫¨T FIELD-NAV: ƒê∆ØA M≈®I T√äN L√äN ƒê√ÇY --- */
    .field-nav { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        min-height: 60px; 
        background: #f8fafc; 
        border-radius: 10px; 
        padding: 0 5px; 
        overflow: hidden;
    }
    /* V√πng ch·∫°m ƒë·ªÉ chuy·ªÉn c·ªôt (Tr√°i & Ph·∫£i) */
    .nav-zone {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        cursor: pointer;
        gap: 8px;
        transition: background 0.2s;
        -webkit-tap-highlight-color: transparent;
    }
    .nav-zone:active { background: #f1f5f9; }
    
    .field-label-side { font-size: 0.75rem; color: #94a3b8; padding: 5px; opacity: 0.6; }
    .nav-arrow-small { font-size: 1.1rem; font-weight: bold; color: var(--primary); }

    /* C·ªôt hi·ªán t·∫°i ·ªü gi·ªØa */
    .nav-zone-active { flex: 1.2; text-align: center; }
    .field-active { color: var(--primary); font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); display: inline-block; padding-bottom: 2px; }

    /* --- C·∫¨P NH·∫¨T TH·∫∫ CARD: S·∫†CH S·∫º, KH√îNG M≈®I T√äN --- */
.card { 
    height: 450px; 
    border: 2px solid #e2e8f0; 
    border-radius: 20px; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
    background: #fff; 
    position: relative;
    margin-bottom: 20px;
    /* X√≥a touch-action: none c≈© ƒë·ªÉ cho ph√©p s·ª± ki·ªán truy·ªÅn ƒëi c√≥ ki·ªÉm so√°t */
    touch-action: pan-y; 
}

    .card-touch-zone {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.1s;
    }
    .card-touch-zone:active { background-color: #f8fafc;}
.card-content { 
    font-size: 2.2rem; 
    text-align: left; 
    padding: 20px; 
    font-weight: bold; 
    color: #1e293b; 
    word-break: break-word; 
    
    flex: 1;
    width: 100%;       
    display: block; /* Chuy·ªÉn t·ª´ flex sang block ƒë·ªÉ scroll ·ªïn ƒë·ªãnh */
    
	white-space: pre-wrap;
	
    /* Logic cu·ªôn n·ªôi b·ªô quan tr·ªçng */
    overflow-y: auto !important; 
    -webkit-overflow-scrolling: touch; 
    overscroll-behavior: contain; 
    box-sizing: border-box; /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m h·ªèng layout */
}

    /* T√πy ch·ªânh thanh cu·ªôn cho tinh t·∫ø */
    .card-content::-webkit-scrollbar { width: 5px; }
    .card-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* --- GI·ªÆ NGUY√äN TO√ÄN B·ªò PH·∫¶N C√íN L·∫†I --- */
    .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    button { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
    button:active { transform: scale(0.98); }
    .btn-learned { background: var(--success); color: white; }
    .btn-mastered { background: var(--warning); color: white; }
    .btn-forgot { background: #64748b; color: white; }
    .btn-next-prev { background: var(--primary); color: white; grid-column: span 3; display: flex; justify-content: space-between; align-items: center; padding: 0; overflow: hidden; border-radius: 10px;}
    .btn-next-prev button { background: none !important; color: white !important; border: none; height: 100%; padding: 14px 25px; cursor: pointer; font-weight: bold; font-size: 0.9rem }
    #word-counter, #review-counter { color: white; font-weight: bold; min-width: 60px; text-align: center; }
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn-menu { background: #334155; color: white; padding: 12px; }
    .voice-settings { margin-top: 10px; font-size: 0.8rem; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; color: #64748b; }
    .quiz-item { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; scroll-margin-top: 80px; }
    .option-btn { width: 100%; text-align: left; padding: 12px; margin-top: 8px; border: 1px solid #cbd5e1; background: #fff; border-radius: 8px; }
    .option-btn.selected { border: 2px solid var(--primary); background: #f0f7ff; }
    .option-btn.correct-ans { background: #dcfce7 !important; border-color: #22c55e !important; color: #166534; }
    .option-btn.wrong-ans { background: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b; }
    #quiz-timer-box { position: sticky; top: 10px; z-index: 100; background: var(--danger); color: white; padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #quiz-result-summary { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
    .dot-nav { display: inline-block; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 50%; margin: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 0.8rem; }
    .btn-finish { background: #1e293b; color: white; width: 100%; padding: 15px; margin-top: 20px; font-size: 1.1rem; }
    .speed-val { font-weight: bold; color: var(--primary); min-width: 35px; display: inline-block; }
    .action-panel { margin-top: 20px; padding: 15px; border-top: 2px solid #e2e8f0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-sync { background: #16a34a; color: white; font-size: 0.8rem; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold;}
    .sync-section { margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; }
    .scenario-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 10px; margin-top: 15px; background: #f8fafc; position: relative; }
    .scenario-title { font-weight: bold; color: #334155; margin-bottom: 10px; display: block; }
    .remove-scenario { position: absolute; top: 10px; right: 10px; color: var(--danger); cursor: pointer; font-size: 0.8rem; }
    .select-group { margin-bottom: 10px; }
    .select-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
    .exclude-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .exclude-item { font-size: 0.75rem; background: #fff; border: 1px solid #cbd5e1; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
    .btn-autoplay { background: #8b5cf6; color: white; grid-column: span 3; margin-top: 5px; }
    .status-star { color: var(--warning); }
    .status-check { color: var(--success); }
    .review-mastered { background: var(--warning); color: white; }
    .db-view-container { max-width: 95% !important; width: 1200px !important; }
    .excel-table-wrapper { overflow: auto; max-height: 500px; border: 1px solid #ddd; margin-bottom: 15px; }
    .excel-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; }
    .excel-table th { position: sticky; top: 0; background: #f1f5f9; z-index: 5; border: 1px solid #cbd5e1; padding: 8px; }
    .excel-table td { border: 1px solid #cbd5e1; padding: 5px; min-width: 100px; outline: none; }
    .excel-table td:focus { background: #fffbeb; box-shadow: inset 0 0 0 2px var(--primary); }
    .btn-db-action { padding: 8px 16px; border-radius: 6px; font-size: 0.85rem; }
    .btn-confirm { background: var(--success); color: white; }
    .btn-cancel { background: #94a3b8; color: white; }
    .btn-add-row { background: var(--primary); color: white; margin-bottom: 10px; }
    .btn-delete-row { background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;}
    #audio-unlock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
    
    /* Ruby & Furigana */
    ruby {
        display: inline-flex;
        flex-direction: column-reverse;
        vertical-align: bottom;
        align-items: center; 
        ruby-align: space-between;
        text-indent: 0;
        margin: 0 1px; 
    }
    rt {
        display: block; 
        font-size: 0.45em; 
        line-height: 1; 
        color: var(--primary);
        text-align: center;
        width: 100%; 
        white-space: nowrap; 
        overflow: visible;
    }   
	/* --- CSS CHO MODAL ·∫®N C·ªòT --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
}
.column-modal {
    background: white; width: 90%; max-width: 400px; padding: 20px;
    border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
}
.column-list {
    max-height: 300px; overflow-y: auto; margin: 15px 0;
    display: flex; flex-direction: column; gap: 10px;
}
.column-item {
    display: flex; align-items: center; gap: 12px; padding: 10px;
    background: #f8fafc; border-radius: 8px; cursor: pointer;
}
.column-item input { width: 20px; height: 20px; }
.modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.btn-hide-cols { background: #64748b; color: white; padding: 5px 12px; font-size: 0.8rem; border-radius: 6px; }
/* Menu th·∫£ xu·ªëng cho ti√™u ƒë·ªÅ */
.mode-menu-container { position: relative; cursor: pointer; }
.mode-dropdown {
    position: absolute; top: 100%; left: 0; background: white;
    box-shadow: 0 10px 15px rgba(0,0,0,0.2); border-radius: 8px;
    z-index: 2000; width: 180px; display: none; border: 1px solid #e2e8f0;
}
.mode-dropdown.show { display: block !important; }
.mode-item {
    padding: 12px 15px; border-bottom: 1px solid #f1f5f9;
    color: #334155; font-size: 0.9rem; font-weight: bold;
}
.mode-item:last-child { border-bottom: none; color: var(--danger); }
.mode-item:active { background: #f8fafc; }

</style>
</head>
<body>

    <div id="audio-unlock" class="hidden">
        <h2>üîä S·∫µn s√†ng h·ªçc t·∫≠p</h2>
        <p>Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ k√≠ch ho·∫°t √¢m thanh tr√™n thi·∫øt b·ªã n√†y.</p>
        <button onclick="unlockAudio()" style="background: var(--success); color: white; padding: 20px 40px; font-size: 1.2rem;">B·∫ÆT ƒê·∫¶U NGAY</button>
    </div>

    <div id="setup-screen" class="container">
        <h2 style="text-align: center;">üìÇ C√†i ƒë·∫∑t Database</h2>
        <div style="border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 12px;">
            <p style="margin-top:0; color:#64748b;">N·∫°p file Excel (.xlsx)</p>
            <p style="font-size: 0.7rem; color: #94a3b8;">(C·ªôt 1: STT, C·ªôt 2: T·ª´ v·ª±ng ch√≠nh)</p>
            <input type="file" id="fileInput" accept=".xlsx" />
        </div>
        <div class="sync-section">
            <h4 style="margin:0 0 10px 0; color:#16a34a;">üîÑ ƒê·ªìng b·ªô gi·ªØa c√°c m√°y</h4>
            <button class="btn-sync" onclick="exportFullBackup()">üíæ Xu·∫•t to√†n b·ªô d·ªØ li·ªáu (Backup)</button>
            <button class="btn-sync" style="background:#0891b2" onclick="document.getElementById('backupInput').click()">üì• Nh·∫≠p t·ª´ file Backup (.json)</button>
            <input type="file" id="backupInput" accept=".json" class="hidden" onchange="importFullBackup(event)" />
        </div>
    </div>

    <div id="study-screen" class="container hidden">
        <div id="status-display" class="status-badge"></div>
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;">
			<div style="flex: 1;">
				<div class="mode-menu-container" onclick="toggleModeMenu(event)">
					<h3 id="mode-title" style="margin: 0; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; display: flex; align-items: center; gap: 5px;">
						Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span>
					</h3>
					<div id="mode-dropdown" class="mode-dropdown">
						<div class="mode-item" onclick="selectMode('study', event)">üìö Ch·∫ø ƒë·ªô H·ªçc t·∫≠p</div>
						<div class="mode-item" onclick="selectMode('review', event)">üîÑ Ch·∫ø ƒë·ªô √în t·∫≠p</div>
						<div class="mode-item" onclick="showQuizScreen(event)">üìù Tr·∫Øc nghi·ªám</div>
					</div>
				</div>
			</div>
		
			<div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;">
				<span id="word-counter-top" style="font-weight: 800; font-size: 0.9rem; color: #1e293b;">0 / 0</span>
				<div id="status-display-top" onclick="setStatus(null)" style="font-size: 1.2rem; height: 1.4rem;"></div>
			</div>
		
			<div style="flex: 1; text-align: right;">
				<button class="btn-hide-cols" onclick="openColumnModal()" style="padding: 6px 10px; font-size: 0.75rem; background: #64748b; color: white; border-radius: 6px; border: none;">üëÅÔ∏è ·∫®n c·ªôt</button>
			</div>
		</div>
		<div id="column-modal-root" class="modal-overlay hidden">
			<div class="column-modal">
				<h3 style="margin-top: 0;">Thi·∫øt l·∫≠p hi·ªÉn th·ªã</h3>
				<p style="font-size: 0.8rem; color: #64748b;">Tick ƒë·ªÉ <b>·∫®N</b> c·ªôt khi h·ªçc/√¥n t·∫≠p.</p>
				<div id="column-checkbox-list" class="column-list"></div>
				<div class="modal-footer">
					<button class="btn-confirm" onclick="applyColumnVisibility()">X√°c nh·∫≠n</button>
					<button class="btn-cancel" onclick="closeColumnModal()">H·ªßy b·ªè</button>
				</div>
			</div>
		</div>
        
<div class="field-nav">
    <div id="nav-left" class="nav-zone" onclick="changeField(-1)">
        <span id="btn-prev-field" class="nav-arrow-small">‚ùÆ</span>
        <span id="prev-field" class="field-label-side"></span>
    </div>

    <div id="nav-center" class="nav-zone-active">
        <span id="curr-field" class="field-active"></span>
    </div>

    <div id="nav-right" class="nav-zone" onclick="changeField(1)">
        <span id="next-field" class="field-label-side"></span>
        <span id="btn-next-field" class="nav-arrow-small">‚ùØ</span>
    </div>
</div>

<div class="card">
    <div class="card-touch-zone">
        <div id="display-text" class="card-content" onclick="speakText()">
            ---
        </div>
        <div id="speaker-hint" style="position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #cbd5e1; letter-spacing: 1px; pointer-events: none; text-transform: uppercase; font-weight: bold;">Ch·∫°m ƒë·ªÉ ƒë·ªçc</div>
    </div>
</div>
		<div class="voice-settings">
			<span>T·ªëc ƒë·ªô: <input type="range" id="voiceRate" min="0.25" max="3" step="0.25" value="1" oninput="document.getElementById('speed-display').innerText = this.value + 'x'"> 
				<span id="speed-display" class="speed-val">1x</span>
			</span>
			<label><input type="checkbox" id="autoSpeak" checked> T·ª± ƒë·ªông ƒë·ªçc</label>
			<label id="random-multi-wrap"><input type="checkbox" id="randomMulti" checked> Random</label>
			<div style="display: flex; gap: 5px; width: 100%; margin-top: 5px;">
				<button id="furiganaToggle" onclick="toggleFurigana()" style="flex: 1; background: #e2e8f0; color: #475569; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; border: 1px solid #cbd5e1;">Furigana: OFF</button>
				<button id="btn-data-toggle" onclick="toggleDataMenu()" style="flex: 1; background: #334155; color: white; padding: 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; border: none;">Data ‚ñæ</button>
			</div>
		</div>
		<div id="data-controls-wrapper" class="hidden" style="margin-top: 10px; background: #f1f5f9; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
			<div class="action-panel" style="margin-top: 0; border-top: none; padding: 0;">
				<button class="btn-sync" onclick="exportFullBackup()" style="background:#6366f1">üíæ Backup nhanh (.json)</button>
				<button class="btn-sync" onclick="showAddFromFile()" style="background:#8b5cf6">‚ûï Th√™m t·ª´ v√†o DB</button>
			</div>
			
			<div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
				<button class="btn-db-action" style="background: #1e293b; color: white; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold;" onclick="showDatabaseView()">üìä Xem & Qu·∫£n l√Ω Database (DB)</button>
				<button onclick="resetDatabase()" style="background:none; color:#ef4444; font-size:11px; border:none; text-decoration: underline; cursor: pointer;">[X√≥a s·∫°ch Database h·ªá th·ªëng]</button>
			</div>
		</div>
		<div id="study-controls" class="hidden"></div> 
		
		<div id="review-controls" class="hidden" style="margin-top: 10px;">
			<button id="btn-autoplay" class="btn-autoplay" onclick="toggleAutoPlay()" style="width: 100%;">‚ñ∂ T·ª± ƒë·ªông ph√°t</button>
		</div>

        
        <div id="add-file-panel" class="hidden" style="margin-top: 20px; padding: 15px; background: #fefce8; border: 1px solid #fef08a; border-radius: 12px;">
            <h4 style="margin: 0 0 10px 0;">‚ûï Th√™m t·ª´ v·ª±ng t·ª´ File</h4>
            <input type="file" id="addWordsFileInput" accept=".xlsx" style="font-size: 0.8rem; margin-bottom: 10px; width: 100%;">
            <div style="display: flex; gap: 10px;">
                <button onclick="confirmAddFromFile()" style="background: var(--success); color: white; padding: 8px; flex: 1;">X√°c nh·∫≠n Th√™m</button>
                <button onclick="hideAddFromFile()" style="background: #94a3b8; color: white; padding: 8px; flex: 1;">H·ªßy b·ªè</button>
            </div>
        </div>

    </div>

    <div id="db-view-screen" class="container db-view-container hidden">
        <h3>üìä Qu·∫£n l√Ω Database Vocab</h3>
        <button class="btn-add-row" onclick="addRowToExcel()">‚ûï Th√™m h√†ng m·ªõi</button>
        <div class="excel-table-wrapper">
            <table class="excel-table" id="excel-table">
                <thead id="excel-thead"></thead>
                <tbody id="excel-tbody"></tbody>
            </table>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn-db-action btn-confirm" onclick="saveExcelChanges()">X√°c nh·∫≠n (L∆∞u)</button>
            <button class="btn-db-action btn-cancel" onclick="exitDatabaseView()">Tho√°t</button>
        </div>
    </div>

    <div id="quiz-screen" class="container hidden">
        <h2 id="quiz-header-title">üìù Tr·∫Øc nghi·ªám</h2>
        <div id="quiz-setup">
            <div style="margin-bottom: 15px;">
                S·ªë c√¢u: <input type="number" id="quizCount" placeholder="T·∫•t c·∫£" style="width: 80px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px;">
                TGian/c√¢u (s): <input type="number" id="timePerQuestion" value="10" style="width: 60px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px;">
                <button onclick="addScenario()" style="background: var(--primary); color: white; padding: 8px 15px; font-size: 0.8rem; margin-left: 10px;">+ Th√™m k·ªãch b·∫£n</button>
            </div>
            <div id="scenarios-list"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="startQuiz()" style="background: var(--success); color: white; flex: 1;">B·∫Øt ƒë·∫ßu</button>
                <button onclick="exitQuiz()" style="background: #94a3b8; color: white; flex: 1;">H·ªßy</button>
            </div>
        </div>

        <div id="quiz-playing" class="hidden">
            <div id="quiz-timer-box">‚è± Th·ªùi gian c√≤n l·∫°i: <span id="time-left">00:00</span></div>
            <div id="quiz-result-summary" class="hidden"></div>
            <div id="quiz-container"></div>
            <button id="quiz-finish-btn" class="btn-finish" onclick="finishQuiz()">Xong (N·ªôp b√†i)</button>
            <button id="quiz-back-btn" class="btn-finish" style="background: #64748b; margin-top: 10px;" onclick="exitQuiz()">Quay l·∫°i</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://xolhvdgltrhkixuwaipp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvbGh2ZGdsdHJoa2l4dXdhaXBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTk4MTMsImV4cCI6MjA4MzE5NTgxM30.A-o0LI-LkorVerHMkDjCwNTJLONeYJAnZdEB1GLgaco';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let rawData = [], headers = [], currentWordIndex = 0, currentFieldIndex = 1;
    let reviewPool = [], reviewIndex = 0;
    let stats = JSON.parse(localStorage.getItem('vocab_stats')) || {}; 
    let currentMode = 'study';
    let scenarios = JSON.parse(localStorage.getItem('quiz_scenarios')) || [];
    const synth = window.speechSynthesis;
    let isAutoPlaying = false;
    let quizInterval;
    let quizData = [];
    let userAnswers = {};
    let isDataChanged = false;
    let availableVoices = [];

    let hotkeys = JSON.parse(localStorage.getItem('vocab_hotkeys')) || {
        'next': 'arrowright', 'prev': 'arrowleft', 'learned': '1', 'mastered': '2',
        'forgot': '3', 'speak': 'r', 'fieldNext': 'arrowdown', 'fieldPrev': 'arrowup'
    };

// Khai b√°o bi·∫øn l∆∞u tr·ªØ (D√°n d∆∞·ªõi ch·ªó let currentMode)
let hiddenColumns = JSON.parse(localStorage.getItem('vocab_hidden_cols')) || { study: [], review: [] };

// 1. H√†m b·∫≠t/t·∫Øt Menu khi b·∫•m v√†o ti√™u ƒë·ªÅ
function toggleModeMenu(event) {
    if (event) event.stopPropagation();
    const dropdown = document.getElementById('mode-dropdown');
    const arrow = document.getElementById('menu-arrow');
    
    // Ch·ªâ d√πng duy nh·∫•t class 'show' ƒë·ªÉ ƒëi·ªÅu khi·ªÉn
    const isShowing = dropdown.classList.toggle('show');
    
    if(arrow) arrow.style.transform = isShowing ? "rotate(180deg)" : "rotate(0deg)";
}

// 2. H√†m ch·ªçn ch·∫ø ƒë·ªô (B·∫•m xong l√† T·∫ÆT)
function selectMode(mode, event) {
    if (event) event.stopPropagation(); // Ch·∫∑n ƒë·ªÉ kh√¥ng b·ªã n·∫£y ng∆∞·ª£c l·∫°i h√†m toggle

    // T·∫ÆT MENU b·∫±ng c√°ch x√≥a class show
    document.getElementById('mode-dropdown').classList.remove('show');
    const arrow = document.getElementById('menu-arrow');
    if(arrow) arrow.style.transform = "rotate(0deg)";

    // Logic chuy·ªÉn mode c·ªßa b·∫°n
    if (mode === 'study' || mode === 'review') {
        if (currentMode !== mode) switchMode(mode);
    } else {
        showQuizScreen();
    }
}

// Th√™m d√≤ng n√†y v√†o ƒë·∫ßu script ƒë·ªÉ click ra ngo√†i th√¨ ƒë√≥ng menu
window.onclick = function(event) {
    if (!event.target.closest('.mode-menu-container')) {
        document.getElementById('mode-dropdown').classList.remove('show');
    }
}

function openColumnModal() {
    const listContainer = document.getElementById('column-checkbox-list');
    listContainer.innerHTML = "";
    
    // L·∫•y danh s√°ch c·ªôt hi·ªán ƒëang b·ªã ·∫©n c·ªßa ch·∫ø ƒë·ªô hi·ªán t·∫°i
    const currentHidden = hiddenColumns[currentMode] || [];

    // B·ªè qua c·ªôt ƒë·∫ßu ti√™n (STT)
    headers.slice(1).forEach(h => {
        const div = document.createElement('div');
        div.className = 'column-item';
        div.innerHTML = `
            <input type="checkbox" id="chk-${h}" value="${h}" ${currentHidden.includes(h) ? 'checked' : ''}>
            <label for="chk-${h}">${h}</label>
        `;
        div.onclick = (e) => { if(e.target.tagName !== 'INPUT') { 
            const chk = div.querySelector('input');
            chk.checked = !chk.checked;
        }};
        listContainer.appendChild(div);
    });
    document.getElementById('column-modal-root').classList.remove('hidden');
}

function closeColumnModal() { document.getElementById('column-modal-root').classList.add('hidden'); }

function applyColumnVisibility() {
    const checked = document.querySelectorAll('#column-checkbox-list input:checked');
    const selectedHidden = Array.from(checked).map(input => input.value);
    
    // L∆∞u ri√™ng cho t·ª´ng ch·∫ø ƒë·ªô
    hiddenColumns[currentMode] = selectedHidden;
    localStorage.setItem('vocab_hidden_cols', JSON.stringify(hiddenColumns));
    
    // Sau khi ·∫©n, n·∫øu c·ªôt hi·ªán t·∫°i r∆°i v√†o c·ªôt b·ªã ·∫©n, ph·∫£i nh·∫£y sang c·ªôt h·ª£p l·ªá ƒë·∫ßu ti√™n
    validateCurrentField();
    
    closeColumnModal();
    updateDisplay();
}

// Ki·ªÉm tra n·∫øu ƒëang ƒë·ª©ng ·ªü c·ªôt b·ªã ·∫©n th√¨ nh·∫£y sang c·ªôt g·∫ßn nh·∫•t kh√¥ng b·ªã ·∫©n
function validateCurrentField() {
    const currentHidden = hiddenColumns[currentMode] || [];
    if (currentHidden.includes(headers[currentFieldIndex])) {
        // T√¨m c·ªôt ƒë·∫ßu ti√™n kh√¥ng b·ªã ·∫©n (b·∫Øt ƒë·∫ßu t·ª´ index 1)
        for (let i = 1; i < headers.length; i++) {
            if (!currentHidden.includes(headers[i])) {
                currentFieldIndex = i;
                break;
            }
        }
    }
}
// Thay th·∫ø ƒëo·∫°n g√¢y l·ªói c≈© b·∫±ng ƒëo·∫°n n√†y
let isFuriganaEnabled = false;
try {
    const savedFurigana = localStorage.getItem('vocab_furigana');
    isFuriganaEnabled = savedFurigana ? JSON.parse(savedFurigana) : false;
} catch (e) {
    isFuriganaEnabled = false;
}

function toggleFurigana() {
    isFuriganaEnabled = !isFuriganaEnabled;
    localStorage.setItem('vocab_furigana', JSON.stringify(isFuriganaEnabled));
    updateFuriganaButtons();
    updateDisplay();
}

function updateFuriganaButtons() {
    const btn = document.getElementById('furiganaToggle');
    if (btn) {
        btn.innerText = isFuriganaEnabled ? "Furigana: ON" : "Furigana: OFF";
        btn.style.background = isFuriganaEnabled ? "var(--primary)" : "#e2e8f0";
        btn.style.color = isFuriganaEnabled ? "white" : "#475569";
    }
}

function toggleDataMenu() {
    const wrapper = document.getElementById('data-controls-wrapper');
    const btn = document.getElementById('btn-data-toggle');
    
    if (wrapper.classList.contains('hidden')) {
        wrapper.classList.remove('hidden');
        btn.innerText = 'Data ‚ñ¥';
        btn.style.background = 'var(--primary)';
        // Cu·ªôn xu·ªëng m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y menu v·ª´a m·ªü
        setTimeout(() => wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
    } else {
        wrapper.classList.add('hidden');
        btn.innerText = 'Data ‚ñæ';
        btn.style.background = '#334155';
    }
}

function formatFurigana(text) {
    if (!text) return "";
    // H·ªó tr·ª£ Kanji, Hiragana, Katakana tr∆∞·ªõc d·∫•u ngo·∫∑c
    return text.replace(/([‰∏Ä-Èæ†„ÄÖa-zA-Z0-9]+)\(([^)]+)\)/g, (match, kanji, furigana) => {
        return `<ruby>${kanji}<rt>${furigana}</rt></ruby>`;
    });
}
    // Load voices cho iPhone
	function loadVoices() {
		availableVoices = synth.getVoices();
	}
	
	// Quan tr·ªçng: iOS c·∫ßn s·ª± ki·ªán n√†y
	if (speechSynthesis.onvoiceschanged !== undefined) {
		speechSynthesis.onvoiceschanged = loadVoices;
	}
	// Ch·∫°y ngay l·∫≠p t·ª©c m·ªôt l·∫ßn
	loadVoices();

	window.onload = async function() {
		loadVoices();
		console.log("1. B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu t·ª´ Cloud...");
	
		try {
			// T·∫£i Headers v√† Ti·∫øn ƒë·ªô
			const { data: prog, error: pErr } = await supabaseClient.from('user_progress').select('*').eq('id', 'current_user').single();
			if (pErr) console.warn("L∆∞u √Ω: Ch∆∞a c√≥ ti·∫øn ƒë·ªô c≈© (c√≥ th·ªÉ l√† user m·ªõi)");
			
			if (prog) {
				stats = prog.stats || {};
				headers = prog.headers || [];
				currentWordIndex = prog.current_index || 0;
				console.log("2. ƒê√£ t·∫£i Headers:", headers);
			}
	
			// T·∫£i T·ª´ v·ª±ng
			const { data: vocab, error: vErr } = await supabaseClient.from('hoc_tap').select('*').order('row_index', { ascending: true });
			
			if (vErr) {
				console.error("L·ªói t·∫£i vocab:", vErr);
				return;
			}
	
			if (vocab && vocab.length > 0 && headers.length > 0) {
				console.log("3. ƒê√£ th·∫•y vocab, s·ªë l∆∞·ª£ng:", vocab.length);
				
				rawData = vocab.map(row => {
					let obj = {};
					headers.forEach((h, i) => { obj[h] = row[`col${i+1}`]; });
					return obj;
				});
	
				// L·ªánh quan tr·ªçng nh·∫•t: √âP hi·ªán m√†n h√¨nh h·ªçc
				console.log("4. ƒêang k√≠ch ho·∫°t initApp...");
				initApp(); 
				
				// √âp th√™m m·ªôt l·∫ßn n·ªØa cho ch·∫Øc
				document.getElementById('setup-screen').classList.add('hidden');
				document.getElementById('study-screen').classList.remove('hidden');
			} else {
				console.log("5. Cloud tr·ªëng ho·∫∑c thi·∫øu Headers. Gi·ªØ nguy√™n m√†n h√¨nh Setup.");
			}
		} catch (err) {
			console.error("6. L·ªói h·ªá th·ªëng:", err);
		}
	};
async function syncToCloud() {
    // Th√™m log ƒë·ªÉ b·∫°n ki·ªÉm tra trong F12 Console xem n√≥ c√≥ ch·∫°y kh√¥ng
    console.log("ƒêang g·ª≠i d·ªØ li·ªáu l√™n Cloud...", stats);
    const { error } = await supabaseClient.from('user_progress').upsert({
        id: 'current_user',
        stats: stats,
        headers: headers,
        current_index: currentWordIndex
    }, { onConflict: 'id' }); // √âp bu·ªôc Supabase ki·ªÉm tra c·ªôt ID ƒë·ªÉ c·∫≠p nh·∫≠t

    if (error) {
        console.error("L·ªói Supabase:", error.message);
    }
}
    function unlockAudio() {
        // Ph√°t m·ªôt √¢m thanh r·ªóng ƒë·ªÉ "m·ªìi" iPhone
        const utter = new SpeechSynthesisUtterance("");
        synth.speak(utter);
        document.getElementById('audio-unlock').classList.add('hidden');
        initApp();
    }

    // --- DATABASE VIEW LOGIC ---
    function showDatabaseView() {
        isDataChanged = false;
        document.getElementById('study-screen').classList.add('hidden');
        document.getElementById('db-view-screen').classList.remove('hidden');
        renderExcelTable();
    }

    function renderExcelTable() {
        const thead = document.getElementById('excel-thead');
        const tbody = document.getElementById('excel-tbody');
        thead.innerHTML = ''; tbody.innerHTML = '';
        let trH = document.createElement('tr');
        headers.forEach(h => {
            let th = document.createElement('th');
            th.innerText = h;
            trH.appendChild(th);
        });
		let thAct = document.createElement('th');
		thAct.innerText = "Thao t√°c";
		trH.appendChild(thAct);
        thead.appendChild(trH);

        rawData.forEach((row, rIdx) => {
            let trB = document.createElement('tr');
            headers.forEach(h => {
                let td = document.createElement('td');
                td.contentEditable = "true";
                td.innerText = row[h] || "";
                td.oninput = () => { isDataChanged = true; };
                trB.appendChild(td);
            });
			let tdAct = document.createElement('td');
			tdAct.style.textAlign = "center";
			tdAct.innerHTML = `<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;
			trB.appendChild(tdAct);
            tbody.appendChild(trB);
        });
    }

	function deleteExcelRow(btn) {
		if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√†ng n√†y?")) {
			btn.closest('tr').remove();
			isDataChanged = true;
		}
	}

    function addRowToExcel() {
        const tbody = document.getElementById('excel-tbody');
        let trB = document.createElement('tr');
        headers.forEach(() => {
            let td = document.createElement('td');
            td.contentEditable = "true";
            td.oninput = () => { isDataChanged = true; };
            trB.appendChild(td);
        });
		let tdAct = document.createElement('td');
        tdAct.style.textAlign = "center";
        tdAct.innerHTML = `<button class="btn-delete-row" onclick="deleteExcelRow(this)">X√≥a</button>`;
        trB.appendChild(tdAct);
        tbody.appendChild(trB);
        isDataChanged = true;
    }

    function saveExcelChanges() {
        if (isDataChanged) {
            if (!confirm("B·∫°n c√≥ ƒë·ªìng √Ω l∆∞u c√°c thay ƒë·ªïi n√†y kh√¥ng?")) return;
        }
        const rows = document.querySelectorAll('#excel-tbody tr');
        let newData = [];
        rows.forEach(tr => {
            let rowObj = {};
            const cells = tr.querySelectorAll('td');
            headers.forEach((h, i) => {
                rowObj[h] = cells[i].innerText.trim();
            });
            if (Object.values(rowObj).some(v => v !== "")) {
                newData.push(rowObj);
            }
        });
        rawData = newData;
        localStorage.setItem('vocab_data', JSON.stringify(rawData));
        isDataChanged = false;
        alert("ƒê√£ l∆∞u d·ªØ li·ªáu!");
        initApp();
        exitDatabaseView();
    }

    function exitDatabaseView() {
        if (isDataChanged) {
            if (confirm("D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi, b·∫°n c√≥ mu·ªën L∆ØU tr∆∞·ªõc khi tho√°t kh√¥ng?")) {
                saveExcelChanges();
                return;
            }
        }
        document.getElementById('db-view-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
    }

    function showAddFromFile() { document.getElementById('add-file-panel').classList.remove('hidden'); }
    function hideAddFromFile() { document.getElementById('add-file-panel').classList.add('hidden'); }
    
    function confirmAddFromFile() {
        const fileInput = document.getElementById('addWordsFileInput');
        if (!fileInput.files.length) { alert("Vui l√≤ng ch·ªçn file!"); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const incomingData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: "N.A"});
            if (incomingData.length > 0) {
                const incomingHeaders = Object.keys(incomingData[0]);
                if (incomingHeaders.length !== headers.length) {
                    alert(`L·ªói: S·ªë c·ªôt kh√¥ng kh·ªõp!`);
                    return;
                }
                const standardizedData = incomingData.map(row => {
                    let newRow = {};
                    incomingHeaders.forEach((h, i) => { newRow[headers[i]] = row[h]; });
                    return newRow;
                });
                rawData = [...rawData, ...standardizedData];
                localStorage.setItem('vocab_data', JSON.stringify(rawData));
                alert(`ƒê√£ n·ªëi th√™m ${standardizedData.length} t·ª´!`);
                hideAddFromFile();
                initApp();
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function exportFullBackup() {
        if (!rawData.length) { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); return; }
        const fullData = {
            vocab_data: rawData, vocab_headers: headers, vocab_stats: stats,
            vocab_hotkeys: hotkeys, quiz_scenarios: scenarios, export_date: new Date().toLocaleString()
        };
        const blob = new Blob([JSON.stringify(fullData)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Vocab_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importFullBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem('vocab_data', JSON.stringify(data.vocab_data));
                localStorage.setItem('vocab_headers', JSON.stringify(data.vocab_headers));
                localStorage.setItem('vocab_stats', JSON.stringify(data.vocab_stats || {}));
                alert("Th√†nh c√¥ng!");
                location.reload();
            } catch (err) { alert("L·ªói!"); }
        };
        reader.readAsText(file);
    }

    window.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.contentEditable === "true") return;
        const key = e.key.toLowerCase();
        if (['arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(key)) e.preventDefault();
        if (key === hotkeys.next) handleNext();
        else if (key === hotkeys.prev) handlePrev();
        else if (key === hotkeys.learned) setStatus('learned');
        else if (key === hotkeys.mastered) setStatus('mastered');
        else if (key === hotkeys.forgot) setStatus(null);
        else if (key === hotkeys.speak) speakText();
        else if (key === hotkeys.fieldNext) changeField(1);
        else if (key === hotkeys.fieldPrev) changeField(-1);
    });

    function handleNext() { if (currentMode === 'study') moveWord(1); else nextReviewWord(); }
    function handlePrev() { if (currentMode === 'study') moveWord(-1); else prevReviewWord(); }

	document.getElementById('fileInput').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = async (event) => { // Th√™m async ·ªü ƒë√¢y
            const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
            rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: "N.A"});
            
            if (rawData.length > 0) {
                headers = Object.keys(rawData[0]);

                // 1. Chu·∫©n b·ªã d·ªØ li·ªáu chu·∫©n ƒë·ªÉ ƒë·∫©y l√™n b·∫£ng 'hoc_tap'
                const toInsert = rawData.map((row, i) => {
                    let dbRow = { row_index: i };
                    headers.forEach((h, index) => {
                        // √Ånh x·∫° c·ªôt Excel v√†o col1, col2, col3... trong Database
                        dbRow[`col${index+1}`] = String(row[h] || "N.A");
                    });
                    return dbRow;
                });

                try {
                    // 2. X√≥a d·ªØ li·ªáu c≈© tr√™n Cloud ƒë·ªÉ n·∫°p b·ªô m·ªõi ho√†n to√†n
                    await supabaseClient.from('hoc_tap').delete().neq('row_index', -1);
                    
                    // 3. ƒê·∫©y d·ªØ li·ªáu m·ªõi l√™n
                    const { error } = await supabaseClient.from('hoc_tap').insert(toInsert);
                    
                    if (error) throw error;

                    // 4. L∆∞u c·∫£ ti√™u ƒë·ªÅ c·ªôt (headers) l√™n Cloud
                    await syncToCloud(); 

                    alert("‚úÖ ƒê√£ ƒë·ªìng b·ªô " + rawData.length + " t·ª´ v·ª±ng l√™n Cloud th√†nh c√¥ng!");
                    
                    // Hi·ªán n√∫t b·∫Øt ƒë·∫ßu √¢m thanh
                    document.getElementById('audio-unlock').classList.remove('hidden');
                } catch (err) {
                    console.error("L·ªói Supabase:", err);
                    alert("C√≥ l·ªói khi ƒë·∫©y data l√™n Cloud: " + err.message);
                }
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

	function initApp() {
		console.log("H√†m initApp ƒëang ch·∫°y...");
		if (rawData && rawData.length > 0) {
			document.getElementById('setup-screen').classList.add('hidden');
			document.getElementById('study-screen').classList.remove('hidden');
			updateDisplay();
		}
	}
function switchMode(mode) {
    stopAutoPlay();
    currentMode = mode;
    const titleEl = document.getElementById('mode-title'); // L·∫•y ph·∫ßn t·ª≠ ti√™u ƒë·ªÅ

    if (mode === 'review') {
        prepareReviewPool();
        if (reviewPool.length === 0) { 
            alert("Tr·ªëng!"); 
            currentMode = 'study'; 
            return; 
        }
        
        // S·ª¨A ·ªû ƒê√ÇY: D√πng innerHTML ƒë·ªÉ gi·ªØ l·∫°i th·∫ª span ch·ª©a m≈©i t√™n ‚ñæ
        titleEl.innerHTML = 'Ch·∫ø ƒë·ªô √¥n t·∫≠p <span id="menu-arrow">‚ñæ</span>';
        
        document.getElementById('study-controls').classList.add('hidden');
        document.getElementById('review-controls').classList.remove('hidden');
        document.getElementById('btn-to-review').classList.add('hidden');
        document.getElementById('btn-to-study').classList.remove('hidden');
        document.getElementById('random-multi-wrap').classList.remove('hidden');
        reviewIndex = 0; 
        currentFieldIndex = 1; 
        updateDisplay(true);
    } else {
        // S·ª¨A ·ªû ƒê√ÇY: D√πng innerHTML ƒë·ªÉ gi·ªØ l·∫°i th·∫ª span ch·ª©a m≈©i t√™n ‚ñæ
        titleEl.innerHTML = 'Ch·∫ø ƒë·ªô h·ªçc t·∫≠p <span id="menu-arrow">‚ñæ</span>';
        
        document.getElementById('study-controls').classList.remove('hidden');
        document.getElementById('review-controls').classList.add('hidden');
        document.getElementById('btn-to-review').classList.remove('hidden');
        document.getElementById('btn-to-study').classList.add('hidden');
        document.getElementById('random-multi-wrap').classList.add('hidden');
        currentFieldIndex = 1; 
        updateDisplay(true);
    }
// --- D√íNG L·ªÜNH T·∫ÆT MENU ---
document.getElementById('mode-dropdown').style.display = 'none';
}

    function prepareReviewPool() {
        const learned = rawData.filter(w => stats[w[headers[0]]] === 'learned');
        const mastered = rawData.filter(w => stats[w[headers[0]]] === 'mastered');
        let pool = [];
        const isRandomMulti = document.getElementById('randomMulti').checked;
        if (isRandomMulti) {
            let tempMastered = [...mastered].sort(() => Math.random() - 0.5);
            let limitMastered = Math.max(1, Math.floor(learned.length * 0.05));
            pool = [...learned, ...tempMastered.slice(0, limitMastered)].sort(() => Math.random() - 0.5);
        } else {
            let processedSTT = new Set();
            let groupedPool = [];
            let validWords = [...learned, ...mastered].sort(() => Math.random() - 0.5);
            validWords.forEach(word => {
                let stt = String(word[headers[0]]);
                if (processedSTT.has(stt)) return;
                let match = stt.match(/^(\d+)([a-z])$/);
                if (match) {
                    let numPart = match[1];
                    let group = rawData.filter(w => String(w[headers[0]]).startsWith(numPart) && String(w[headers[0]]).match(/^\d+[a-z]$/)).sort((a, b) => String(a[headers[0]]).localeCompare(String(b[headers[0]])));
                    group.forEach(g => { groupedPool.push(g); processedSTT.add(String(g[headers[0]])); });
                } else { groupedPool.push(word); processedSTT.add(stt); }
            });
            pool = groupedPool;
        }
        reviewPool = pool;
    }

function updateDisplay(shouldSpeak = false) {
    if (!rawData.length) return;
    let word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    let total = currentMode === 'study' ? rawData.length : reviewPool.length;
    if (!word) return;

    let sttExcel = word[headers[0]]; 
    // Hi·ªÉn th·ªã STT l√™n d√≤ng ƒë·∫ßu
    document.getElementById('word-counter-top').innerText = `${sttExcel} / ${total}`;

    // --- GI·ªÆ NGUY√äN LOGIC ·∫®N C·ªòT ---
    const currentHidden = (window.hiddenColumns && window.hiddenColumns[currentMode]) ? window.hiddenColumns[currentMode] : [];
    let prevLabel = "";
    for (let i = currentFieldIndex - 1; i >= 1; i--) {
        if (!currentHidden.includes(headers[i])) { prevLabel = headers[i]; break; }
    }
    let nextLabel = "";
    for (let i = currentFieldIndex + 1; i < headers.length; i++) {
        if (!currentHidden.includes(headers[i])) { nextLabel = headers[i]; break; }
    }
    document.getElementById('prev-field').innerText = prevLabel;
    document.getElementById('curr-field').innerText = headers[currentFieldIndex];
    document.getElementById('next-field').innerText = nextLabel;
    
    document.getElementById('btn-prev-field').style.visibility = (prevLabel === "") ? 'hidden' : 'visible';
    document.getElementById('btn-next-field').style.visibility = (nextLabel === "") ? 'hidden' : 'visible';

    // --- N·ªòI DUNG TH·∫∫ (GI·ªÆ NGUY√äN FURIGANA) ---
    let rawContent = word[headers[currentFieldIndex]] || "";
    if (isFuriganaEnabled) {
        document.getElementById('display-text').innerHTML = formatFurigana(rawContent);
    } else {
        document.getElementById('display-text').innerHTML = rawContent.replace(/\(.*?\)/g, '');
    }
    
    // --- HI·ªÇN TH·ªä ICON L√äN D√íNG ƒê·∫¶U (C·∫≠p nh·∫≠t ƒë·ªÉ b·∫•m ƒë∆∞·ª£c) ---
    const statusDivTop = document.getElementById('status-display-top');
    const currentStatus = stats[sttExcel];
    
    if (currentStatus === 'learned') {
        statusDivTop.innerHTML = "‚úÖ";
    } else if (currentStatus === 'mastered') {
        statusDivTop.innerHTML = "‚≠ê";
    } else {
        // Hi·ªán d·∫•u ch·∫•m nh·ªè ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt v·ªã tr√≠ n√†y c√≥ th·ªÉ click (Reset)
        statusDivTop.innerHTML = '<span style="opacity: 0.2;">‚Ä¢</span>'; 
    }
    
    // --- GI·ªÆ NGUY√äN LOGIC √ÇM THANH ---
    if (shouldSpeak && !isAutoPlaying && document.getElementById('autoSpeak').checked) { 
        setTimeout(() => { speakText(); }, 100); 
    }
    updateFuriganaButtons();
}
async function moveWord(step) { 
    currentWordIndex = (currentWordIndex + step + rawData.length) % rawData.length; 
    currentFieldIndex = 1; 
    updateDisplay(true); 
	syncToCloud().catch(err => console.error("L·ªói l∆∞u cloud:", err)); 
}
    function nextReviewWord() { if (reviewIndex < reviewPool.length - 1) reviewIndex++; else { prepareReviewPool(); reviewIndex = 0; } currentFieldIndex = 1; updateDisplay(true); }
    function prevReviewWord() { reviewIndex = (reviewIndex - 1 + reviewPool.length) % reviewPool.length; currentFieldIndex = 1; updateDisplay(true); }

// --- 1. GI·ªÆ NGUY√äN H√ÄM SETSTATUS V·ªöI LOGIC C≈® C·ª¶A B·∫†N ---
async function setStatus(status) {
    let word = currentMode === 'study' ? rawData[currentWordIndex] : reviewPool[reviewIndex];
    if (!word) return;
    const wordKey = word[headers[0]];
    
    // Logic nh√°y m√†u ti√™u ƒë·ªÅ khi ƒë·ªïi tr·∫°ng th√°i (Gi·ªØ nguy√™n)
    const currFieldEl = document.getElementById('curr-field');
    if (currFieldEl) {
        let flashColor = '#475569'; 
        if (status === 'learned') flashColor = '#22c55e'; 
        else if (status === 'mastered') flashColor = '#eab308'; 
        else if (status === null) flashColor = '#ef4444'; 

        currFieldEl.style.transition = 'none';
        currFieldEl.style.color = flashColor;
        currFieldEl.style.transform = 'scale(1.1)';

        setTimeout(() => {
            currFieldEl.style.transition = 'all 0.3s ease';
            currFieldEl.style.color = ''; 
            currFieldEl.style.transform = 'scale(1)';
        }, 200);
    }

    if (status === null) delete stats[wordKey]; 
    else stats[wordKey] = status;
    
    await syncToCloud();

    if (currentMode === 'review' && (status === 'mastered' || status === null)) {
        reviewPool.splice(reviewIndex, 1);
        if (reviewPool.length === 0) { 
            stopAutoPlay(); 
            alert("ƒê√£ ho√†n th√†nh m·ª•c ti√™u √¥n t·∫≠p!"); 
            switchMode('study'); 
            return; 
        }
        if (reviewIndex >= reviewPool.length) reviewIndex = 0;
        updateDisplay();
    } else { 
        updateDisplay(); 
        if(currentMode === 'review') nextReviewWord(); 
    }
}

// --- 2. LOGIC CLICK 1 L·∫¶N/2 L·∫¶N V√ÄO TI√äU ƒê·ªÄ (TH√äM M·ªöI) ---
let fieldClickTimer = null;
document.getElementById('curr-field').onclick = function(e) {
    e.stopPropagation(); 
    if (fieldClickTimer === null) {
        fieldClickTimer = setTimeout(() => {
            fieldClickTimer = null;
            setStatus('learned'); // Click 1 l·∫ßn -> ƒê√£ h·ªçc
        }, 300); 
    } else {
        clearTimeout(fieldClickTimer);
        fieldClickTimer = null;
        setStatus('mastered'); // Click 2 l·∫ßn -> ƒê√£ nh·ªõ
    }
};

// GHI ƒê√à H√ÄM changeField ƒê·ªÇ NH·∫¢Y QUA C·ªòT ·∫®N
function changeField(dir) {
    const currentHidden = hiddenColumns[currentMode] || [];
    let nextIdx = currentFieldIndex;
    
    while (true) {
        nextIdx += dir;
        // N·∫øu ch·∫°m bi√™n th√¨ d·ª´ng
        if (nextIdx < 1 || nextIdx >= headers.length) return false;
        
        // N·∫øu c·ªôt n√†y kh√¥ng b·ªã ·∫©n th√¨ ch·ªçn n√≥ v√† tho√°t
        if (!currentHidden.includes(headers[nextIdx])) {
            currentFieldIndex = nextIdx;
            updateDisplay(true);
            return true;
        }
    }
}

    /* FIX L·ªñI √ÇM THANH IPHONE TRI·ªÜT ƒê·ªÇ */
function speakText(callback) {
    const displayEl = document.getElementById('display-text');
    if (!displayEl) { if (callback) callback(); return; }

    // 1. X·ª≠ l√Ω l·∫•y text s·∫°ch (b·ªè Furigana)
    const tempEl = displayEl.cloneNode(true);
    const rts = tempEl.querySelectorAll('rt');
    rts.forEach(rt => rt.remove()); 
    let text = tempEl.innerText.replace(/\(.*?\)/g, '').trim();

    if (text === "N.A" || !text || text === "---") { if (callback) callback(); return; }
    
    // 2. Nh·∫≠n di·ªán ng√¥n ng·ªØ
    const isVN = /[√†√°·∫£√£·∫°ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√¢·∫•·∫ß·∫©·∫´·∫≠√®√©·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªáƒë√¨√≠·ªâƒ©·ªã√≤√≥·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√π√∫·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ª∑·ªπ·ªµ]/i.test(text);
    const isJP = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(text);
    let langCode = isVN ? 'vi-VN' : (isJP ? 'ja-JP' : 'en-US');

    synth.cancel(); 
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langCode;

    // 3. Ch·ªçn gi·ªçng (∆Øu ti√™n Enhanced cho iPhone c·ªßa b·∫°n)
    let allVoices = synth.getVoices();
    let selectedVoice = null;

    if (langCode === 'vi-VN') {
        selectedVoice = allVoices.find(v => v.lang.startsWith('vi') && v.name.includes('Linh') && v.name.includes('Enhanced')) ||
                        allVoices.find(v => v.lang.startsWith('vi') && (v.name.includes('Linh') || v.name.includes('An'))) ||
                        allVoices.find(v => v.lang.startsWith('vi'));
    } else if (langCode === 'ja-JP') {
        selectedVoice = allVoices.find(v => v.lang.startsWith('ja') && v.name.includes('Kyoko') && v.name.includes('Enhanced')) ||
                        allVoices.find(v => v.lang.startsWith('ja') && (v.name.includes('Kyoko') || v.name.includes('Haruka') || v.name.includes('Ichiro'))) ||
                        allVoices.find(v => v.lang.startsWith('ja'));
    } else {
        selectedVoice = allVoices.find(v => v.lang.startsWith('en') && (v.name.includes('Allison') || v.name.includes('Samantha')) && v.name.includes('Enhanced')) ||
                        allVoices.find(v => v.lang.startsWith('en') && (v.name.includes('Samantha') || v.name.includes('Zira') || v.name.includes('David'))) ||
                        allVoices.find(v => v.lang.startsWith('en'));
    }

    if (selectedVoice) utter.voice = selectedVoice;

    // 4. Thi·∫øt l·∫≠p t·ªëc ƒë·ªô v√† th·ª±c hi·ªán ƒë·ªçc
    utter.rate = document.getElementById('voiceRate').value || 1;
    utter.onend = () => { if (callback) callback(); };
    utter.onerror = () => { if (callback) callback(); };
    
    setTimeout(() => { synth.speak(utter); }, 100);
}
    function toggleAutoPlay() { if (isAutoPlaying) stopAutoPlay(); else startAutoPlay(); }
    function startAutoPlay() { isAutoPlaying = true; document.getElementById('btn-autoplay').innerText = "‚èπ D·ª´ng ph√°t"; document.getElementById('btn-autoplay').style.background = "var(--danger)"; currentFieldIndex = 1; updateDisplay(); playSequence(); }
    function stopAutoPlay() { isAutoPlaying = false; synth.cancel(); document.getElementById('btn-autoplay').innerText = "‚ñ∂ T·ª± ƒë·ªông ph√°t"; document.getElementById('btn-autoplay').style.background = "#8b5cf6"; }

    function playSequence() {
        if (!isAutoPlaying) return;
        
        // ƒê·ªçc t√™n c·ªôt (Vi·ªát)
        const headerText = headers[currentFieldIndex];
        const utterHeader = new SpeechSynthesisUtterance(headerText);
        utterHeader.lang = 'vi-VN';
        
        if (availableVoices.length > 0) {
            const viVoice = availableVoices.find(v => v.lang.startsWith('vi-VN'));
            if (viVoice) utterHeader.voice = viVoice;
        }

        utterHeader.rate = document.getElementById('voiceRate').value;
        utterHeader.onend = () => {
            if (!isAutoPlaying) return;
            // ƒê·ªçc n·ªôi dung √¥
            speakText(() => {
                if (!isAutoPlaying) return;
                setTimeout(() => {
                    if (!isAutoPlaying) return;
                    if (currentFieldIndex < headers.length - 1) { 
                        currentFieldIndex++; 
                        updateDisplay(); 
                        playSequence(); 
                    } else { 
                        if (reviewIndex < reviewPool.length - 1) { 
                            reviewIndex++; 
                            currentFieldIndex = 1; 
                            updateDisplay(); 
                            playSequence(); 
                        } else { stopAutoPlay(); } 
                    }
                }, 800);
            });
        };
        synth.speak(utterHeader);
    }

// 3. H√†m Tr·∫Øc nghi·ªám (B·∫•m xong c≈©ng ph·∫£i T·∫ÆT)
function showQuizScreen(event) {
    if (event) event.stopPropagation();

    // T·∫ÆT MENU
    document.getElementById('mode-dropdown').classList.remove('show');
    const arrow = document.getElementById('menu-arrow');
    if(arrow) arrow.style.transform = "rotate(0deg)";

    // Logic Quiz c·ªßa b·∫°n
    stopAutoPlay();
    document.getElementById('study-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('quiz-setup').classList.remove('hidden');
    document.getElementById('quiz-playing').classList.add('hidden');
    const pool = rawData.filter(w => stats[w[headers[0]]]);
    document.getElementById('quiz-header-title').innerText = `üìù Tr·∫Øc nghi·ªám (${pool.length})`;
    if (scenarios.length === 0) { scenarios.push({ root: headers[1], exclude: [headers[0]] }); saveScenarios(); }
    renderScenarios();
}

    function addScenario() { scenarios.push({ root: headers[1], exclude: [headers[0]] }); saveScenarios(); renderScenarios(); }
    function removeScenario(idx) { scenarios.splice(idx, 1); if (scenarios.length === 0) addScenario(); else { saveScenarios(); renderScenarios(); } }
    function saveScenarios() { localStorage.setItem('quiz_scenarios', JSON.stringify(scenarios)); }

	function renderScenarios() {
		const list = document.getElementById('scenarios-list');
		list.innerHTML = "";
		const poolCount = rawData.filter(w => stats[w[headers[0]]] === 'learned' || stats[w[headers[0]]] === 'mastered').length;
	
		scenarios.forEach((sc, idx) => {
			const box = document.createElement('div');
			box.className = 'scenario-box';
			let rootOpts = headers.slice(1).map(h => `<option value="${h}" ${h === sc.root ? 'selected' : ''}>${h}</option>`).join('');
			let exOpts = headers.slice(1).filter(h => h !== sc.root).map(h => `<label class="exclude-item"><input type="checkbox" ${sc.exclude.includes(h) ? 'checked' : ''} onchange="toggleExclude(${idx}, '${h}')"> ${h}</label>`).join('');
			const targetCount = headers.filter((h, i) => i !== 0 && h !== sc.root && !sc.exclude.includes(h)).length;
			const maxPossible = poolCount * targetCount;
	
			box.innerHTML = `
				<span class="remove-scenario" onclick="removeScenario(${idx})">‚úñ X√≥a</span>
				<span class="scenario-title">K·ªãch b·∫£n ${idx+1}</span>
				<div style="font-size: 0.8rem; color: var(--primary); margin-bottom: 10px;">
					T·ªëi ƒëa: <strong>${maxPossible}</strong> c√¢u h·ªèi
				</div>
				<div class="select-group">
					<label>C·ªôt g·ªëc:</label>
					<select onchange="updateRoot(${idx}, this.value)" style="width:100%; padding:5px; border-radius:5px;">${rootOpts}</select>
				</div>
				<div class="select-group">
					<label>C·ªôt lo·∫°i tr·ª´:</label>
					<div class="exclude-list">${exOpts}</div>
				</div>`;
			list.appendChild(box);
		});
	}

    function updateRoot(idx, val) { scenarios[idx].root = val; saveScenarios(); renderScenarios(); }
    function toggleExclude(idx, val) {
        const i = scenarios[idx].exclude.indexOf(val);
        if (i > -1) scenarios[idx].exclude.splice(i, 1); else scenarios[idx].exclude.push(val);
        saveScenarios(); renderScenarios();
    }

    function startQuiz() {
        const Q = parseInt(document.getElementById('quizCount').value) || null;
        const timeVal = parseInt(document.getElementById('timePerQuestion').value) || 10;
        const pool = rawData.filter(w => stats[w[headers[0]]]);
        if (!pool.length) { alert("H·ªçc th√™m t·ª´ ƒëi!"); return; }
        quizData = []; userAnswers = {};
        scenarios.forEach(sc => {
            const targets = headers.filter((h, i) => i !== 0 && h !== sc.root && !sc.exclude.includes(h));
            pool.forEach(word => { targets.forEach(t => { quizData.push({ rH: sc.root, tH: t, rV: word[sc.root], cV: word[t] }); }); });
        });
        quizData.sort(() => Math.random() - 0.5);
        if (Q && Q < quizData.length) quizData = quizData.slice(0, Q);
        document.getElementById('quiz-setup').classList.add('hidden');
        document.getElementById('quiz-playing').classList.remove('hidden');
        document.getElementById('quiz-result-summary').classList.add('hidden');
        document.getElementById('quiz-finish-btn').classList.remove('hidden');
        const container = document.getElementById('quiz-container');
        container.innerHTML = "";
        quizData.forEach((q, idx) => {
            const item = document.createElement('div'); item.className = 'quiz-item'; item.id = `quiz-q-${idx}`;
            let allVals = [...new Set(rawData.map(w => w[q.tH]))];
            let choices = [q.cV, ...allVals.filter(v => v !== q.cV).sort(() => Math.random() - 0.5).slice(0, 3)].sort(() => Math.random() - 0.5);
            item.innerHTML = `<h4>C√¢u ${idx+1}: "${q.tH}" c·ªßa <u>${q.rV}</u>?</h4>`;
			item.innerHTML = `
				<h4 onclick="document.getElementById('quiz-result-summary').scrollIntoView({behavior: 'smooth'})" 
					style="cursor: pointer; color: var(--primary); text-decoration: underline;">
					C√¢u ${idx+1}: "${q.tH}" c·ªßa <u>${q.rV}</u>?
				</h4>`;
            choices.forEach(c => {
                const b = document.createElement('button'); b.className = 'option-btn'; b.innerText = c;
                b.onclick = () => {
                    if (document.getElementById('quiz-finish-btn').classList.contains('hidden')) return;
                    Array.from(item.querySelectorAll('.option-btn')).forEach(btn => btn.classList.remove('selected'));
                    b.classList.add('selected'); userAnswers[idx] = c;
                };
                item.appendChild(b);
            });
            container.appendChild(item);
        });
        let timeLeft = quizData.length * timeVal;
        clearInterval(quizInterval);
        quizInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('time-left').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) { clearInterval(quizInterval); finishQuiz(); }
        }, 1000);
    }

function restartQuiz() {
    clearInterval(quizInterval); // D·ª´ng ƒë·∫øm ng∆∞·ª£c c≈©
    document.getElementById('quiz-result-summary').classList.add('hidden'); // ·∫®n b·∫£ng ƒëi·ªÉm
    document.getElementById('quiz-finish-btn').classList.remove('hidden'); // Hi·ªán l·∫°i n√∫t n·ªôp b√†i
    startQuiz(); // Ch·∫°y l·∫°i t·ª´ ƒë·∫ßu v·ªõi data m·ªõi
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
    function finishQuiz() {
        clearInterval(quizInterval);
        document.getElementById('quiz-finish-btn').classList.add('hidden');
        const summary = document.getElementById('quiz-result-summary');
        summary.classList.remove('hidden');
        let score = 0;
        quizData.forEach((q, idx) => {
            const item = document.getElementById(`quiz-q-${idx}`);
            item.querySelectorAll('.option-btn').forEach(b => {
                b.style.pointerEvents = 'none';
                if (b.innerText === q.cV) b.classList.add('correct-ans');
                if (userAnswers[idx] === b.innerText && b.innerText !== q.cV) b.classList.add('wrong-ans');
            });
            if (userAnswers[idx] === q.cV) score++;
        });
        summary.innerHTML = `<h3 style="margin-top:0">K·∫øt qu·∫£: ${score}/${quizData.length}</h3>
		<div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button onclick="restartQuiz()" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold;">üîÑ L√†m l·∫°i</button>
            <button onclick="exitQuiz(true)" style="flex:1; padding:12px; background:#64748b; color:white; border:none; border-radius:8px; font-weight:bold;">üè† Tho√°t</button>
        </div>`;
        quizData.forEach((_, i) => {
            const dot = document.createElement('span'); dot.className = 'dot-nav';
            dot.style.background = (userAnswers[i] === quizData[i].cV) ? 'var(--success)' : 'var(--danger)';
            dot.innerText = i + 1;
            dot.onclick = () => document.getElementById(`quiz-q-${i}`).scrollIntoView({ behavior: 'smooth' });
            summary.appendChild(dot);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exitQuiz(forceQuit = false) {
    // V·∫´n gi·ªØ l·ªánh d·ª´ng th·ªùi gian c≈© c·ªßa m√†y
    clearInterval(quizInterval); 

    const quizSetup = document.getElementById('quiz-setup');
    const quizPlaying = document.getElementById('quiz-playing');
    const quizResult = document.getElementById('quiz-result-summary');

if (forceQuit) {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
        // Reset ng·∫ßm c√°c m√†n h√¨nh b√™n trong v·ªÅ tr·∫°ng th√°i ch·ªù cho l·∫ßn sau
        quizPlaying.classList.add('hidden');
        quizResult.classList.add('hidden');
        quizSetup.classList.remove('hidden');
        return; // Tho√°t h√†m lu√¥n
    }
    // Ki·ªÉm tra: N·∫øu ƒëang ·ªü m√†n h√¨nh k·∫øt qu·∫£ HO·∫∂C ƒëang ch∆°i 
    // th√¨ khi b·∫•m "Quay l·∫°i" ch·ªâ ·∫©n k·∫øt qu·∫£/tr·∫≠n ƒë·∫•u ƒëi ƒë·ªÉ hi·ªán l·∫°i m√†n h√¨nh Setup
    if (!quizResult.classList.contains('hidden') || !quizPlaying.classList.contains('hidden')) {
        quizPlaying.classList.add('hidden');
        quizResult.classList.add('hidden');
        quizSetup.classList.remove('hidden');
        
        // Hi·ªán l·∫°i n√∫t n·ªôp b√†i (n·∫øu tr∆∞·ªõc ƒë√≥ b·ªã ·∫©n)
        const finishBtn = document.getElementById('quiz-finish-btn');
        if (finishBtn) finishBtn.classList.remove('hidden');

        // Cu·ªôn l√™n ƒë·∫ßu trang setup cho d·ªÖ nh√¨n
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } 
    // N·∫øu ƒëang ƒë·ª©ng ·ªü m√†n h√¨nh Setup (kh√¥ng ch∆°i, kh√¥ng xem k·∫øt qu·∫£) 
    // th√¨ m·ªõi tho√°t h·∫≥n v·ªÅ trang h·ªçc ch√≠nh (ƒë√¢y l√† l·ªánh c≈© c·ªßa m√†y)
    else {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('study-screen').classList.remove('hidden');
    }
}
    async function resetDatabase() {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA S·∫†CH d·ªØ li·ªáu tr√™n Cloud kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
        try {
            // 1. X√≥a to√†n b·ªô t·ª´ v·ª±ng trong b·∫£ng hoc_tap
            const { error: err1 } = await supabaseClient.from('hoc_tap').delete().neq('row_index', -1);
            
            // 2. Reset ti·∫øn ƒë·ªô v√† ti√™u ƒë·ªÅ trong b·∫£ng user_progress
            const { error: err2 } = await supabaseClient.from('user_progress').upsert({
                id: 'current_user',
                stats: {},
                headers: [],
                current_index: 0
            });

            if (err1 || err2) throw new Error("L·ªói khi x√≥a d·ªØ li·ªáu tr√™n Cloud");

            // 3. X√≥a n·ªët localStorage cho s·∫°ch m√°y
            localStorage.clear();
            
            alert("ƒê√£ x√≥a s·∫°ch d·ªØ li·ªáu tr√™n Cloud! Trang web s·∫Ω t·∫£i l·∫°i.");
            location.reload();
        } catch (err) {
            console.error(err);
            alert("C√≥ l·ªói x·∫£y ra: " + err.message);
        }
    }
}
// --- LOGIC VU·ªêT (SWIPE) ƒê√É T·ªêI ∆ØU CHO IPHONE ---
// --- LOGIC VU·ªêT (SWIPE) T·ªêI ∆ØU ---
let touchstartX = 0;
let touchstartY = 0;

const cardElement = document.querySelector('.card');
const scrollArea = document.querySelector('.card-content'); // Ch√≠nh l√† c√°i v√πng ƒë·ªè c·ªßa m√†y

if (cardElement) {
    cardElement.addEventListener('touchstart', e => {
        touchstartX = e.changedTouches[0].screenX;
        touchstartY = e.changedTouches[0].screenY;
    }, {passive: true});

    cardElement.addEventListener('touchmove', e => {
        let currX = e.changedTouches[0].screenX;
        let currY = e.changedTouches[0].screenY;
        
        let diffX = Math.abs(currX - touchstartX);
        let diffY = Math.abs(currY - touchstartY);

        // 1. ∆Øu ti√™n vu·ªët ngang r√µ r·ªát (diffX > diffY) -> Ch·∫∑n tr√¥i app ƒë·ªÉ chuy·ªÉn t·ª´
        if (diffX > diffY && diffX > 10) {
            if (e.cancelable) e.preventDefault(); 
        } 
        // 2. N·∫øu vu·ªët d·ªçc (diffY > diffX)
        else if (diffY > diffX) {
            // Ki·ªÉm tra xem n·ªôi dung b√™n trong c√≥ th·ª±c s·ª± d√†i ƒë·∫øn m·ª©c c·∫ßn cu·ªôn kh√¥ng
            const isScrollable = scrollArea.scrollHeight > scrollArea.clientHeight;
            
            if (isScrollable) {
                // N·∫øu ƒëang ·ªü ƒë·ªânh ho·∫∑c ƒë√°y, ngƒÉn kh√¥ng cho cu·ªôn k√©o c·∫£ trang web ƒëi (overscroll)
                const isAtTop = scrollArea.scrollTop === 0;
                const isAtBottom = scrollArea.scrollHeight - scrollArea.scrollTop <= scrollArea.clientHeight + 1;
                
                // N·∫øu cu·ªôn d·ªçc b√™n trong v√πng ƒë·ªè, d√πng stopPropagation ƒë·ªÉ n√≥ kh√¥ng t√°c ƒë·ªông ra ngo√†i
                e.stopPropagation();
            } else {
                // N·∫øu n·ªôi dung ng·∫Øn, ch·∫∑n vu·ªët d·ªçc lu√¥n ƒë·ªÉ app ƒë·ª©ng im
                if (e.cancelable) e.preventDefault();
            }
        }
    }, {passive: false});

    cardElement.addEventListener('touchend', e => {
        let touchendX = e.changedTouches[0].screenX;
        let touchendY = e.changedTouches[0].screenY;
        const diffX = touchendX - touchstartX;
        const diffY = touchendY - touchstartY;

        // Ch·ªâ x·ª≠ l√Ω chuy·ªÉn t·ª´ khi vu·ªët ngang ƒë·ªß m·∫°nh
        if (Math.abs(diffX) > 40 && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX < 0) handleNext();
            else handlePrev();
        }
    }, {passive: true});
}
</script>
</body>
</html>